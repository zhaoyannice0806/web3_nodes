### ä»€ä¹ˆæƒ…å†µä¸‹åº”è¯¥ä½¿ç”¨ `uint` æˆ– `int`?

åœ¨ Solidity ä¸­ï¼Œé€‰æ‹© `uint`ï¼ˆæ— ç¬¦å·æ•´æ•°ï¼‰æˆ– `int`ï¼ˆæœ‰ç¬¦å·æ•´æ•°ï¼‰éœ€åŸºäºæ•°å€¼æ˜¯å¦å¯èƒ½ä¸ºè´Ÿã€‚ä»¥ä¸‹æ˜¯å…·ä½“ä½¿ç”¨åœºæ™¯çš„æ€»ç»“ï¼š


### **ä¸€ã€æ ¸å¿ƒåŒºåˆ«**
| ç±»å‹       | å–å€¼èŒƒå›´                  | å…¸å‹ç”¨é€”                     |
|------------|---------------------------|------------------------------|
| `uint`     | 0 åˆ° 2Â²âµâ¶-1ï¼ˆéè´Ÿæ•°ï¼‰     | æ•°é‡ã€ä½™é¢ã€ç´¢å¼•ã€è®¡æ•°å™¨ç­‰   |
| `int`      | -2Â²âµâµ åˆ° 2Â²âµâµ-1ï¼ˆå¯è´Ÿæ•°ï¼‰ | æ¸©åº¦å˜åŒ–ã€ç›ˆäºè®¡ç®—ç­‰         |


### **äºŒã€æ¨èä½¿ç”¨åœºæ™¯**
#### 1. **ä¼˜å…ˆä½¿ç”¨ `uint` çš„åœºæ™¯**
- **ä»£å¸æ•°é‡**ï¼šå¦‚ ERC-20 çš„ `totalSupply` æˆ– `balanceOf`ï¼Œè´Ÿå€¼æ— æ„ä¹‰ã€‚
- **ç´¢å¼•ä¸è®¡æ•°å™¨**ï¼šå¦‚æ•°ç»„ä¸‹æ ‡ã€å¾ªç¯è®¡æ•°å™¨ï¼ˆå¦‚ `for (uint i = 0; i < 10; i++)`ï¼‰ã€‚
- **é‡‘é¢ä¸æ—¶é—´æˆ³**ï¼šå¦‚æ™ºèƒ½åˆçº¦ä¸­çš„ ETH ä½™é¢ã€åŒºå—æ—¶é—´æˆ³ï¼ˆ`block.timestamp`ï¼‰ã€‚

#### 2. **å¿…é¡»ä½¿ç”¨ `int` çš„åœºæ™¯**
- **å¯èƒ½ä¸ºè´Ÿçš„è®¡ç®—**ï¼šå¦‚æ¸©åº¦å˜åŒ–ï¼ˆ`int temperatureDelta = newTemp - oldTemp`ï¼‰ã€‚
- **é‡‘èç›ˆäº**ï¼šå¦‚è´¦æˆ·çš„åˆ©æ¶¦ï¼ˆ`int profit = revenue - expenses`ï¼‰ã€‚
- **æ•°å­¦è¿ç®—ä¾èµ–è´Ÿæ•°**ï¼šå¦‚ç§‘å­¦è®¡ç®—ä¸­çš„å‘é‡ä½ç§»ã€‚


### **ä¸‰ã€å®‰å…¨è€ƒè™‘**
1. **é¿å…æº¢å‡º/ä¸‹æº¢**ï¼š
   - Solidity 0.8.0+ é»˜è®¤æ£€æŸ¥æº¢å‡ºï¼Œè¶…å‡ºèŒƒå›´ä¼šè§¦å‘ `Panic` å¼‚å¸¸ã€‚
   - æ—§ç‰ˆæœ¬éœ€æ‰‹åŠ¨ä½¿ç”¨ `SafeMath` åº“æˆ–æ˜¾å¼æ£€æŸ¥ï¼ˆå¦‚ `require(a + b >= a)`ï¼‰ã€‚

2. **ç±»å‹åŒ¹é…**ï¼š
   - ä¸å¤–éƒ¨ç³»ç»Ÿäº¤äº’æ—¶ï¼ˆå¦‚é¢„è¨€æœºï¼‰ï¼Œéœ€ç¡®ä¿è¾“å…¥è¾“å‡ºç±»å‹ä¸€è‡´ã€‚
   - ä¾‹å¦‚ï¼Œé“¾ä¸‹æ¸©åº¦æ•°æ®è‹¥å¯èƒ½ä¸ºè´Ÿï¼Œé“¾ä¸Šåº”ä½¿ç”¨ `int`ã€‚


### **å››ã€ç¤ºä¾‹å¯¹æ¯”**
#### 1. **ä»£å¸åˆçº¦ï¼ˆ`uint`ï¼‰**
```solidity
contract ERC20 {
    uint256 public totalSupply;
    mapping(address => uint256) public balanceOf;

    function transfer(address to, uint256 amount) external {
        require(balanceOf[msg.sender] >= amount, "Insufficient balance");
        balanceOf[msg.sender] -= amount;
        balanceOf[to] += amount;
    }
}
```

#### 2. **æ¸©åº¦é¢„è¨€æœºï¼ˆ`int`ï¼‰**
```solidity
contract TemperatureOracle {
    int256 public currentTemperature;

    function updateTemperature(int256 newTemp) external onlyOwner {
        currentTemperature = newTemp;
    }

    function getTemperatureDelta() external view returns (int256) {
        return currentTemperature - 20; // ä¸åŸºå‡†æ¸©åº¦çš„å·®å€¼
    }
}
```


### **äº”ã€æ€»ç»“**
- **é»˜è®¤ä½¿ç”¨ `uint`**ï¼šé™¤éæ˜ç¡®éœ€è¦å¤„ç†è´Ÿæ•°ï¼Œå¦åˆ™ä¼˜å…ˆé€‰æ‹©æ— ç¬¦å·æ•´æ•°ï¼Œå¯å‡å°‘æº¢å‡ºé£é™©ã€‚
- **æ˜ç¡®å–å€¼èŒƒå›´**ï¼šæ ¹æ®ä¸šåŠ¡éœ€æ±‚é€‰æ‹©åˆé€‚çš„ä½æ•°ï¼ˆå¦‚ `uint8`ã€`int128`ï¼‰ï¼Œé¿å…æµªè´¹å­˜å‚¨ç©ºé—´ã€‚
- **ç»“åˆå®‰å…¨åº“**ï¼šåœ¨æ—§ç‰ˆæœ¬ Solidity ä¸­ä½¿ç”¨ `SafeMath` é˜²æ­¢æ•°å€¼å¼‚å¸¸ã€‚

- ç­”æ¡ˆï¼š å½“éœ€è¦å­˜å‚¨æ•´æ•°ï¼Œå¦‚æ•°é‡æˆ–ç´¢å¼•æ—¶ï¼Œåº”ä½¿ç”¨ `uint`ï¼ˆæ— ç¬¦å·æ•´æ•°ï¼‰æˆ– `int`ï¼ˆæœ‰ç¬¦å·æ•´æ•°ï¼‰ã€‚`uint` é€‚ç”¨äºä¸å…è®¸è´Ÿå€¼çš„åœºæ™¯ï¼Œå¦‚æ€»ä¾›åº”é‡ã€‚

```
uint256 public totalSupply;
int256 public balance;
```

### å¦‚ä½•é€‰æ‹©å­˜å‚¨ä»¥å¤ªåŠåœ°å€ä½¿ç”¨çš„æ•°æ®ç»“æ„ï¼Ÿ

åœ¨ Solidity ä¸­é€‰æ‹©å­˜å‚¨ä»¥å¤ªåŠåœ°å€çš„æ•°æ®ç»“æ„ï¼Œéœ€æ ¹æ®**è®¿é—®é¢‘ç‡ã€æ•°æ®å…³è”æ€§ã€è¿­ä»£éœ€æ±‚åŠ Gas æ•ˆç‡**ç»¼åˆåˆ¤æ–­ã€‚ä»¥ä¸‹æ˜¯ä¸åŒåœºæ™¯çš„æ¨èæ–¹æ¡ˆåŠåŸå› ï¼š

---

### **1. å•ä¸ªåœ°å€ï¼šç›´æ¥ä½¿ç”¨ `address` ç±»å‹**
- **åœºæ™¯**ï¼šå­˜å‚¨ç®¡ç†å‘˜åœ°å€ã€å•ç‚¹æ¥æ”¶åœ°å€
- **ä»£ç ç¤ºä¾‹**ï¼š
  ```solidity
  address public owner;                      // åˆçº¦æ‹¥æœ‰è€…
  address payable public treasury;           // èµ„é‡‘æ¥æ”¶åœ°å€ï¼ˆéœ€è½¬è´¦åŠŸèƒ½ï¼‰
  ```

---

### **2. åœ°å€å­˜åœ¨æ€§æ£€æŸ¥ï¼š`mapping(address => bool)`**
- **åœºæ™¯**ï¼šç™½åå•ã€æƒé™æ§åˆ¶ã€å»é‡æ£€æµ‹
- **ä¼˜åŠ¿**ï¼šO(1) æ—¶é—´å¤æ‚åº¦æŸ¥è¯¢
- **ä»£ç ç¤ºä¾‹**ï¼š
  ```solidity
  mapping(address => bool) public isWhitelisted;
  
  function addToWhitelist(address _user) external {
      isWhitelisted[_user] = true;           // æ·»åŠ åœ°å€åˆ°ç™½åå•
  }
  ```

---

### **3. åœ°å€ä¸å¤æ‚æ•°æ®å…³è”ï¼š`mapping(address => Struct)`**
- **åœºæ™¯**ï¼šç”¨æˆ·èµ„æ–™ã€è´¨æŠ¼æ•°æ®ã€ç»Ÿè®¡ä¿¡æ¯
- **ä»£ç ç¤ºä¾‹**ï¼š
  ```solidity
  struct User {
      uint256 balance;
      uint256 lastActive;
  }
  mapping(address => User) public users;     // åœ°å€æ˜ å°„åˆ°ç”¨æˆ·ç»“æ„ä½“
  ```

---

### **4. éœ€éå†çš„åœ°å€é›†åˆï¼š`EnumerableSet`ï¼ˆOpenZeppelinï¼‰**
- **åœºæ™¯**ï¼šDAO æˆå‘˜åˆ—è¡¨ã€éœ€æ‰¹é‡æ“ä½œçš„åœ°å€æ± 
- **ä¼˜åŠ¿**ï¼šå†…ç½®è¿­ä»£å™¨ï¼Œæ”¯æŒå®‰å…¨éå†
- **ä»£ç ç¤ºä¾‹**ï¼š
  ```solidity
  import "@openzeppelin/contracts/utils/structs/EnumerableSet.sol";
  
  contract DAO {
      using EnumerableSet for EnumerableSet.AddressSet;
      EnumerableSet.AddressSet private members;
  
      function addMember(address _addr) external {
          members.add(_addr);                 // è‡ªåŠ¨å»é‡
      }
  
      function getMemberCount() external view returns (uint256) {
          return members.length();            // è·å–æˆå‘˜æ•°é‡
      }
  }
  ```

---

### **5. éœ€æ’åºçš„åœ°å€ï¼š`è‡ªå®šä¹‰ç»“æ„ä½“ + æ•°ç»„`**
- **åœºæ™¯**ï¼šæŒ‰è´¨æŠ¼é‡æ’åºçš„éªŒè¯è€…ã€æ’è¡Œæ¦œ
- **ä»£ç ç¤ºä¾‹**ï¼š
  ```solidity
  struct Validator {
      address addr;
      uint256 stakedAmount;
  }
  Validator[] public validators;             // å¯æ’åºçš„åœ°å€æ•°ç»„
  
  function addValidator(address _addr, uint256 _amount) external {
      validators.push(Validator(_addr, _amount));
      // æŒ‰è´¨æŠ¼é‡æ’åºï¼ˆéœ€è‡ªè¡Œå®ç°æ’åºé€»è¾‘ï¼‰
  }
  ```

---

### **6. ä¸´æ—¶åœ°å€æ“ä½œï¼š`address[]` åŠ¨æ€æ•°ç»„**
- **åœºæ™¯**ï¼šä¸€æ¬¡æ€§æ‰¹é‡å¤„ç†ï¼ˆéé«˜é¢‘è®¿é—®ï¼‰
- **æ…ç”¨**ï¼šåŠ¨æ€æ•°ç»„éå†çš„ Gas æˆæœ¬éšé•¿åº¦å¢é•¿æ€¥å‰§ä¸Šå‡
- **ä»£ç ç¤ºä¾‹**ï¼š
  ```solidity
  address[] public tempAddresses;
  
  function batchProcess() external {
      for(uint i=0; i<tempAddresses.length; i++) {
          // å¤„ç†æ¯ä¸ªåœ°å€ï¼ˆO(n) å¤æ‚åº¦ï¼‰
      }
      delete tempAddresses;                  // å¤„ç†å®Œæˆåæ¸…ç©º
  }
  ```

---

### **Gas æ•ˆç‡ä¸é€‚ç”¨åœºæ™¯å¯¹æ¯”**
| **æ•°æ®ç»“æ„**                | è¯»å–å¤æ‚åº¦ | å†™å…¥å¤æ‚åº¦ | é€‚ç”¨åœºæ™¯                     | æ¨èåº¦ |
|----------------------------|------------|------------|------------------------------|--------|
| `address` / `address payable` | O(1)       | O(1)       | å•ä¸ªåœ°å€å­˜å‚¨                 | â­â­â­â­ |
| `mapping(address => bool)`   | O(1)       | O(1)       | ç™½åå•ã€æƒé™æ§åˆ¶             | â­â­â­â­ |
| `mapping(address => Struct)` | O(1)       | O(1)       | åœ°å€å…³è”å¤æ‚æ•°æ®             | â­â­â­â­ |
| `EnumerableSet.AddressSet`   | O(1)       | O(1)       | éœ€éå†çš„åœ°å€é›†åˆ             | â­â­â­â­ |
| `Validator[]`ï¼ˆè‡ªå®šä¹‰æ•°ç»„ï¼‰  | O(n)       | O(1)       | æŒ‰æƒé‡æ’åºçš„åœ°å€åˆ—è¡¨         | â­â­   |
| `address[]`ï¼ˆçº¯åŠ¨æ€æ•°ç»„ï¼‰    | O(n)       | O(1)       | ä¸´æ—¶æ‰¹é‡å¤„ç†ï¼ˆéé«˜é¢‘åœºæ™¯ï¼‰    | â­     |

> **å…³é”®å»ºè®®**ï¼š  
> 1. **ä¼˜å…ˆé€‰æ‹©æ˜ å°„ï¼ˆmappingï¼‰**ï¼šé€‚ç”¨äºå¤§å¤šæ•°åœ°å€å­˜å‚¨åœºæ™¯ï¼ŒGas æ•ˆç‡æœ€é«˜ï¼›  
> 2. **é¿å…é•¿æ•°ç»„éå†**ï¼šåŠ¨æ€æ•°ç»„çš„å¾ªç¯æ“ä½œæˆæœ¬æé«˜ï¼Œæ”¹ç”¨ `EnumerableSet` æ›¿ä»£ï¼›  
> 3. **éœ€éå†+é«˜æ•ˆæŸ¥è¯¢æ—¶**ï¼šç»„åˆ `mapping` ä¸ `EnumerableSet`ï¼ˆä¾‹ï¼šç”¨ mapping å­˜å‚¨æ•°æ®ï¼ŒSet å­˜å‚¨é”®ï¼‰ã€‚

---

### **å®‰å…¨å®è·µ**
1. **é›¶åœ°å€æ ¡éªŒ**  
   ```solidity
   function safeTransfer(address to) external {
       require(to != address(0), "Invalid address"); // ç¦æ­¢é›¶åœ°å€
       payable(to).transfer(1 ether);
   }
   ```
2. **åˆçº¦åœ°å€æ£€æŸ¥**ï¼ˆæŒ‰éœ€ï¼‰  
   ```solidity
   require(to.code.length > 0, "Target is not a contract");
   ```
3. **ä½¿ç”¨ `call` æ›¿ä»£ `transfer`**  
   ```solidity
   (bool success, ) = to.call{value: amount}(""); // é¿å… Gas ä¸è¶³é—®é¢˜
   ```

---

### **æ€»ç»“**
- **é«˜é¢‘æŸ¥è¯¢/å†™å…¥**ï¼šç”¨ `mapping(address => ...)`ï¼ˆæœ€é«˜æ•ˆï¼‰  
- **éœ€éå†åœ°å€é›†åˆ**ï¼šç”¨ `EnumerableSet`ï¼ˆé¿å…åŠ¨æ€æ•°ç»„çš„é«˜æˆæœ¬ï¼‰  
- **ç®€å•å•ä¸ªåœ°å€**ï¼šç›´æ¥ `address` æˆ– `address payable`  
- **é›¶åœ°å€é£é™©**ï¼šæ‰€æœ‰å¤–éƒ¨è¾“å…¥åœ°å€å¿…é¡»è¿›è¡Œ `require(_addr != address(0))` æ ¡éªŒ  

> æœ€ç»ˆé€‰æ‹©å–å†³äºä¸šåŠ¡éœ€æ±‚ï¼š  
> - **DeFi ç™½åå•** â†’ `mapping(address => bool)`  
> - **NFT æŒæœ‰äººåˆ—è¡¨** â†’ `EnumerableSet`  
> - **è´¨æŠ¼æ’åºç³»ç»Ÿ** â†’ `Validator[]` æ•°ç»„ + æ’åºé€»è¾‘

- ç­”æ¡ˆï¼š ä½¿ç”¨ `address` æ•°æ®ç±»å‹æ¥å­˜å‚¨ä»¥å¤ªåŠåœ°å€ï¼Œé€‚ç”¨äºç”¨æˆ·é’±åŒ…åœ°å€æˆ–åˆçº¦åœ°å€ã€‚

```
address public owner;
```

### åœ¨ä½•æ—¶ä½¿ç”¨ `string` ä¸ `bytes`?

åœ¨ Solidity ä¸­é€‰æ‹© `string` æˆ– `bytes` ç±»å‹æ—¶ï¼Œéœ€è¦æ ¹æ®**æ•°æ®ç±»å‹æœ¬è´¨ã€æ“ä½œéœ€æ±‚ã€å­˜å‚¨æˆæœ¬**ç»¼åˆå†³ç­–ã€‚ä»¥ä¸‹æ˜¯å…·ä½“å†³ç­–æŒ‡å—ï¼š

---

### **ä¸€ã€æ ¸å¿ƒåŒºåˆ«ä¸å†³ç­–çŸ©é˜µ**
| **ç»´åº¦**       | `string` ç±»å‹                     | `bytes` ç±»å‹                  |
|----------------|----------------------------------|-------------------------------|
| **æœ¬è´¨**       | UTF-8 ç¼–ç çš„åŠ¨æ€é•¿åº¦æ–‡æœ¬          | åŸå§‹å­—èŠ‚åºåˆ—ï¼ˆæ— ç¼–ç è§£é‡Šï¼‰     |
| **é•¿åº¦è·å–**   | éœ€è½¬å­—èŠ‚ï¼š`bytes(str).length`    | ç›´æ¥å±æ€§ï¼š`data.length`      |
| **å†…å®¹ä¿®æ”¹**   | æ— æ³•ç›´æ¥ä¿®æ”¹                       | æ”¯æŒå­—èŠ‚çº§ä¿®æ”¹               |
| **Gas æˆæœ¬**   | è¾ƒé«˜ï¼ˆæ¶‰åŠç¼–ç è½¬æ¢ï¼‰              | è¾ƒä½ï¼ˆç‰¹åˆ«æ˜¯å®šé•¿`bytes32`ï¼‰   |

**å†³ç­–æ ‘**ï¼š  
1. éœ€è¦å­˜å‚¨ **äººç±»å¯è¯»æ–‡æœ¬** â†’ é€‰ `string`  
2. éœ€è¦å­˜å‚¨ **åŸå§‹äºŒè¿›åˆ¶æ•°æ®/IPFSå“ˆå¸Œ** â†’ é€‰ `bytes`  
3. **å›ºå®šé•¿åº¦â‰¤32å­—èŠ‚** â†’ ä¼˜å…ˆ `bytes1`-`bytes32`  
4. **éœ€é«˜æ•ˆæ“ä½œå­—èŠ‚** â†’ é€‰ `bytes`

---

### **äºŒã€ä½¿ç”¨ `string` çš„åœºæ™¯åŠç¤ºä¾‹**
#### 1. **å­˜å‚¨ç”¨æˆ·å¯è¯»æ–‡æœ¬**
```solidity
string public tokenName = "Ether Coin";   // ä»£å¸åç§°
string public description = "This is a DeFi token..."; // æè¿°æ–‡æœ¬
```

#### 2. **å›½é™…åŒ–æˆ–å¤šè¯­è¨€æ”¯æŒ**
```solidity
// æ”¯æŒéASCIIå­—ç¬¦ï¼ˆå¦‚ä¸­æ–‡ã€emojiï¼‰
string public welcomeMessage = "æ¬¢è¿ä½¿ç”¨! ğŸ‰";
```

#### 3. **éœ€ä¸å‰ç«¯äº¤äº’çš„æ–‡æœ¬æ•°æ®**
```solidity
function getUserInfo() external view returns (string memory) {
    return string(abi.encodePacked("User:", userName)); // è¿”å›æ‹¼æ¥å­—ç¬¦ä¸²
}
```

---

### **ä¸‰ã€ä½¿ç”¨ `bytes` çš„åœºæ™¯åŠç¤ºä¾‹**
#### 1. **å­˜å‚¨å›ºå®šé•¿åº¦æ•°æ®ï¼ˆä¼˜é€‰`bytesN`ï¼‰**
```solidity
bytes32 public merkleRoot;           // é»˜å…‹å°”æ ‘æ ¹å“ˆå¸Œ
bytes20 public contractAddress;      // åˆçº¦åœ°å€ï¼ˆ20å­—èŠ‚ï¼‰
bytes4 public functionSelector;     // å‡½æ•°é€‰æ‹©å™¨
```

#### 2. **åŸå§‹äºŒè¿›åˆ¶æ•°æ®æ“ä½œ**
```solidity
bytes public rawData; 

// ä¿®æ”¹ç‰¹å®šå­—èŠ‚ä½ç½®
function updateByte(uint index, byte newByte) external {
    rawData[index] = newByte;    // æ”¯æŒç›´æ¥å­—èŠ‚ä¿®æ”¹
}
```

#### 3. **é«˜æ•ˆå­˜å‚¨çŸ­æ–‡æœ¬ï¼ˆGasä¼˜åŒ–ï¼‰**
```solidity
// å°†çŸ­æ–‡æœ¬å­˜å‚¨ä¸º bytes32 èŠ‚çœ Gas
bytes32 public constant SYMBOL = "ETH"; 

function getSymbol() external pure returns (string memory) {
    return string(abi.encodePacked(SYMBOL)); // æŒ‰éœ€è½¬æ¢ä¸ºå­—ç¬¦ä¸²
}
```

---

### **å››ã€å…³é”®å¯¹æ¯”ä¸ Gas ä¼˜åŒ–ç­–ç•¥**
#### å­˜å‚¨æˆæœ¬å¯¹æ¯”ï¼ˆç¤ºä¾‹ï¼‰
| **æ•°æ®ç±»å‹**    | å€¼             | Gas æ¶ˆè€— |
|----------------|----------------|----------|
| `string`       | "Hello World" | 35,000   |
| `bytes`        | "Hello World" | 34,200   |
| `bytes32`      | "Hello World" | 22,100   |

#### ä¼˜åŒ–ç­–ç•¥ï¼š
1. **é•¿åº¦â‰¤32å­—èŠ‚** â†’ ç”¨ `bytes32` æ›¿ä»£ `string`  
   ```solidity
   bytes32 public shortText; // æ¯” string èŠ‚çœ 30% Gas
   ```
2. **é•¿æ–‡æœ¬å­˜å‚¨é“¾ä¸‹**  
   å°†å¤§æ–‡æœ¬å­˜å…¥ IPFS/Arweaveï¼Œé“¾ä¸Šä»…å­˜å“ˆå¸Œï¼š
   ```solidity
   string public ipfsCID = "QmXyZ..."; // é“¾ä¸Šå­˜CID
   ```

---

### **äº”ã€ç±»å‹è½¬æ¢å®è·µ**
#### 1. `string` â†’ `bytes`
```solidity
string memory str = "text";
bytes memory b = bytes(str);       // è½¬ä¸ºå¯å˜é•¿åº¦ bytes
```

#### 2. `bytes` â†’ `string`
```solidity
bytes memory b = hex"74657874";   // "text" çš„å­—èŠ‚å½¢å¼
string memory str = string(b);     // å­—èŠ‚è½¬å­—ç¬¦ä¸²
```

#### 3. `bytes32` â†” `string`
```solidity
// bytes32è½¬å­—ç¬¦ä¸²
bytes32 data = "ETH";
string memory str = string(abi.encodePacked(data));

// å­—ç¬¦ä¸²è½¬bytes32ï¼ˆé•¿åº¦éœ€åŒ¹é…ï¼‰
function stringToBytes32(string memory str) pure returns (bytes32 result) {
    require(bytes(str).length <= 32, "Too long");
    assembly {
        result := mload(add(str, 32))
    }
}
```

---

### **å…­ã€ç‰¹æ®Šåœºæ™¯å¤„ç†**
#### 1. **åŠ¨æ€æ‹¼æ¥å­—ç¬¦ä¸²**
ä¼˜å…ˆç”¨ `abi.encodePacked` å‡å°‘ Gasï¼š
```solidity
function concatenate(string memory a, string memory b) public pure returns (string memory) {
    return string(abi.encodePacked(a, b)); // æ¯”å­—ç¬¦ä¸²æ‹¼æ¥èŠ‚çœGas
}
```

#### 2. **å­˜å‚¨åŠ å¯†æ•°æ®**
```solidity
bytes public encryptedData;  // åŠ å¯†å†…å®¹ï¼ˆæ— ç¼–ç éœ€æ±‚ï¼‰

function decrypt() external view returns (string memory) {
    return string(encryptedData); // ä»…åœ¨éœ€è¦æ—¶è½¬ä¸ºå­—ç¬¦ä¸²
}
```

---

### **æ€»ç»“**
- **`string`**ï¼š  
  ç”¨äº **äººç±»å¯è¯»çš„æ–‡æœ¬**ï¼ˆåç§°ã€æè¿°ï¼‰ï¼Œæ”¯æŒUTF-8ä½†Gasè¾ƒé«˜  
- **`bytes`**ï¼š  
  ç”¨äº **åŸå§‹äºŒè¿›åˆ¶æ•°æ®**ï¼ˆå“ˆå¸Œã€ç¼–ç å†…å®¹ï¼‰ã€**å­—èŠ‚çº§æ“ä½œ**æˆ– **Gasä¼˜åŒ–çŸ­æ–‡æœ¬**  
- **é“å¾‹**ï¼š  
  - é•¿åº¦â‰¤32å­—èŠ‚ â†’ `bytes32`ï¼ˆæœ€å¤§ä¼˜åŒ–ï¼‰  
  - é¿å…é“¾ä¸Šå­˜å‚¨å¤§æ–‡æœ¬ â†’ IPFS+å“ˆå¸Œæ–¹æ¡ˆ  
  - éœ€é¢‘ç¹æ“ä½œæ•°æ® â†’ `bytes`ï¼ˆæ”¯æŒç´¢å¼•ä¿®æ”¹ï¼‰

- ç­”æ¡ˆï¼š å½“å­˜å‚¨å¯å˜é•¿åº¦çš„æ–‡æœ¬æ•°æ®æ—¶ä½¿ç”¨ `string`ï¼›å½“å¤„ç†ä¸éœ€è¦å­—ç¬¦ç¼–ç çš„åŸå§‹å­—èŠ‚æ•°æ®æ—¶ä½¿ç”¨ `bytes`ã€‚

```
string public name;
bytes32 public hash;
```

### æ•°ç»„åœ¨ Solidity ä¸­çš„åº”ç”¨åœºæ™¯æ˜¯ä»€ä¹ˆï¼Ÿ

åœ¨ Solidity ä¸­ï¼Œæ•°ç»„æ˜¯ç®¡ç†æœ‰åºæ•°æ®é›†åˆçš„æ ¸å¿ƒå·¥å…·ï¼Œå…¶åº”ç”¨åœºæ™¯è¦†ç›–åˆçº¦å¼€å‘çš„å¤šä¸ªå…³é”®é¢†åŸŸã€‚ä»¥ä¸‹æ˜¯å…­å¤§å…¸å‹åº”ç”¨åœºæ™¯åŠæœ€ä½³å®è·µï¼š

---

### ä¸€ã€åŠ¨æ€æ•°æ®é›†ç®¡ç†
#### âœ… **åº”ç”¨åœºæ™¯**
- **ä»£å¸ ID é›†åˆï¼ˆNFTï¼‰**  
  å­˜å‚¨ NFT çš„å…¨å±€ ID åˆ—è¡¨ï¼Œæ”¯æŒåŠ¨æ€å¢åˆ 
  ```solidity
  uint256[] public tokenIds;  // [1, 2, 3]
  
  function mint(uint256 _tokenId) external {
      tokenIds.push(_tokenId); // åŠ¨æ€æ·»åŠ æ–°ID
  }
  ```

- **å¤šç­¾é’±åŒ…æˆæƒåœ°å€**  
  ç®¡ç†å¯å‘èµ·äº¤æ˜“çš„åœ°å€åˆ—è¡¨
  ```solidity
  address[] public signers;  // å¤šç­¾æˆå‘˜åœ°å€é›†åˆ
  ```

#### âš ï¸ æ³¨æ„äº‹é¡¹
- **è®¾æœ€å¤§é•¿åº¦é˜²æ”»å‡»**  
  ```solidity
  uint256 constant MAX_SIGNERS = 10;
  function addSigner(address signer) external {
      require(signers.length < MAX_SIGNERS, "Max signers reached");
      signers.push(signer);
  }
  ```

---

### äºŒã€æ‰¹é‡æ“ä½œä¼˜åŒ–
#### âœ… **åº”ç”¨åœºæ™¯**
- **ä»£å¸ç©ºæŠ•**  
  å•äº¤æ˜“å®Œæˆå¤šåœ°å€è½¬è´¦
  ```solidity
  function airdrop(address[] calldata recipients, uint[] calldata amounts) external {
      for(uint i=0; i<recipients.length; i++) {
          _transfer(recipients[i], amounts[i]);
      }
  }
  ```

#### ğŸ”¥ **Gas ä¼˜åŒ–æŠ€å·§**
- ä½¿ç”¨ `calldata` æ›¿ä»£ `memory`  
  ```solidity
  // èŠ‚çœ 22,000+ Gas (çº¦ $0.5 @ 20 Gwei)
  function batchProcess(address[] calldata _users) external { ... }
  ```

---

### ä¸‰ã€æ•°æ®ç´¢å¼•ä¸æŸ¥è¯¢
#### âœ… **åº”ç”¨åœºæ™¯**
- **ç”¨æˆ·ç§¯åˆ†æ’è¡Œæ¦œ**  
  é€šè¿‡ç´¢å¼•å¿«é€Ÿè®¿é—®æ’åºæ•°æ®
  ```solidity
  struct Player {
      address addr;
      uint score;
  }
  Player[] public leaderboard;
  
  function getTopPlayer() external view returns (address) {
      return leaderboard[0].addr; // è·å–ç¬¬ä¸€ååœ°å€
  }
  ```

#### âš¡ **é«˜æ•ˆç´¢å¼•æ–¹æ¡ˆ**
```solidity
mapping(address => uint) public playerIndex; // åœ°å€â†’ç´¢å¼•æ˜ å°„
Player[] public allPlayers;

function addPlayer(address _addr) external {
    playerIndex[_addr] = allPlayers.length;
    allPlayers.push(Player(_addr, 0));
}
```

---

### å››ã€å®ç°å¤æ‚æ•°æ®ç»“æ„
#### âœ… **åº”ç”¨åœºæ™¯**
| ç»“æ„ç±»å‹       | å®ç°æ–¹å¼                     | åº”ç”¨æ¡ˆä¾‹                |
|--------------|----------------------------|------------------------|
| **æ ˆ (LIFO)**  | `push()` + `pop()`          | äº¤æ˜“æ’¤å›é˜Ÿåˆ—            |
| **é˜Ÿåˆ— (FIFO)** | ç¯å½¢ç¼“å†²åŒº                   | é™æµæ“ä½œ               |
| **çŸ©é˜µ**       | åµŒå¥—æ•°ç»„ `uint[][]`         | æ¸¸æˆåœ°å›¾æ•°æ®           |

```solidity
// æ ˆç»“æ„å®ç°
uint256[] stack;

function push(uint value) external {
    stack.push(value);
}

function pop() external returns (uint) {
    return stack.pop();
}
```

---

### äº”ã€å†…å­˜çº§ä¸´æ—¶è®¡ç®—
#### âœ… **åº”ç”¨åœºæ™¯**
- **é“¾ä¸Šæ•°æ®è¿‡æ»¤**  
  ```solidity
  function getActiveUsers() external view returns (address[] memory) {
      address[] memory activeList = new address[](userCount);
      uint count;
      for(uint i=0; i<allUsers.length; i++) {
          if(users[allUsers[i]].isActive) {
              activeList[count++] = allUsers[i];
          }
      }
      return activeList;
  }
  ```

#### ğŸ’¡ ä¼˜åŒ–æŠ€å·§
- ä½¿ç”¨ `memory` æ•°ç»„é¿å…å­˜å‚¨å†™å…¥ï¼ˆèŠ‚çœ 90%+ Gasï¼‰
- æ“ä½œç»“æŸåè‡ªåŠ¨é‡Šæ”¾å†…å­˜

---

### å…­ã€å­˜å‚¨ä¼˜åŒ–å®è·µ
#### âœ… **åº”ç”¨åœºæ™¯**
- **ç»“æ„ä½“ç´§å‡‘å­˜å‚¨**  
  32å­—èŠ‚æ’æ§½å†…æ‰“åŒ…å¤šå­—æ®µ
  ```solidity
  struct PackedData { 
      uint32 id;         // 4å­—èŠ‚
      uint64 timestamp;  // 8å­—èŠ‚
      address owner;     // 20å­—èŠ‚
  } // æ€»è®¡32å­—èŠ‚
  PackedData[] public items; // æ¯ä¸ªæ’æ§½å­˜1ä¸ªç»“æ„ä½“
  ```

#### ğŸ” å‹ç¼©æ•ˆæœå¯¹æ¯”
| å­˜å‚¨æ–¹å¼       | å­—æ®µå ç”¨ | æ’æ§½ä½¿ç”¨é‡ |
|--------------|---------|------------|
| æœªæ‰“åŒ…         | 52å­—èŠ‚  | 3ä¸ªæ’æ§½    |
| **æ‰“åŒ…å**     | **32å­—èŠ‚**| **1ä¸ªæ’æ§½** |

---

### æœ€ä½³å®è·µä¸é¿å‘æŒ‡å—
1. **å®‰å…¨é˜²æŠ¤**
   ```solidity
   // 0.8+ç‰ˆæœ¬è‡ªåŠ¨é˜²æº¢å‡ºï¼Œæ—§ç‰ˆæœ¬éœ€ï¼š
   for (uint i=0; i < arr.length; i++) { ... } // é¿å…i++
   ```

2. **æµ·é‡æ•°æ®å¤„ç†**
   - åˆ†é¡µæŸ¥è¯¢ï¼š`getUsers(uint startIndex, uint limit)`
   - é“¾ä¸‹è®¡ç®—ï¼šä»…å­˜ç»“æœå“ˆå¸Œï¼ˆå¦‚ Merkle Rootï¼‰

3. **å†…å­˜ç®¡ç†**
   ```solidity
   // âœ… æ­£ç¡®ï¼šå‡½æ•°å†…ä¸´æ—¶ä½¿ç”¨memoryæ•°ç»„
   function calculate() pure returns (uint) {
       uint[] memory temp = new uint[](10); 
       ...
   }
   ```

> âš ï¸ **æ…ç”¨åœºæ™¯**ï¼š  
> - é«˜é¢‘å†™å…¥çš„å…¨å±€æ•°ç»„ï¼ˆç”¨æ˜ å°„æ›¿ä»£ï¼‰  
> - éœ€å®æ—¶æ’åºçš„å¤§æ•°æ®é›†ï¼ˆæ”¹ç”¨é“¾ä¸‹ç´¢å¼•ï¼‰

Solidity æ•°ç»„æ˜¯æ„å»ºé“¾ä¸Šæ•°æ®æ¨¡å‹çš„åŸºçŸ³ï¼Œ**æƒè¡¡å­˜å‚¨æˆæœ¬ä¸è®¿é—®æ•ˆç‡**ï¼Œå¯é«˜æ•ˆæ”¯æ’‘ä» DeFi åˆ° GameFi çš„å„ç±»åˆçº¦æ¶æ„ã€‚

- ç­”æ¡ˆï¼š æ•°ç»„ç”¨äºå­˜å‚¨ç›¸åŒç±»å‹çš„å…ƒç´ åˆ—è¡¨ï¼Œé€‚ç”¨äºéœ€è¦å­˜å‚¨å¤šä¸ªå€¼çš„æƒ…å†µï¼Œå¦‚æ•°å­—åˆ—è¡¨æˆ–çŠ¶æ€è®°å½•ã€‚

```
uint256[] public numbers;
```

### ä¸ºä½•ä»¥åŠå¦‚ä½•ä½¿ç”¨ `mapping`?

åœ¨ Solidity ä¸­ï¼Œ`mapping` æ˜¯ä¸€ç§å­˜å‚¨é”®å€¼å¯¹çš„æ ¸å¿ƒæ•°æ®ç»“æ„ï¼Œå…¶è®¾è®¡ä¸“ä¸ºåŒºå—é“¾ç¯å¢ƒä¼˜åŒ–ã€‚ä»¥ä¸‹æ˜¯å…³äº `mapping` çš„æ·±åº¦è§£æï¼š


### **ä¸€ã€æ ¸å¿ƒä¼˜åŠ¿ä¸é€‚ç”¨åœºæ™¯**
#### 1. **ä¸ºä½•ä½¿ç”¨ `mapping`ï¼Ÿ**
- **O(1) æ—¶é—´å¤æ‚åº¦**ï¼šæ— è®ºæ•°æ®è§„æ¨¡å¤šå¤§ï¼ŒæŸ¥è¯¢å’Œæ’å…¥æ“ä½œå‡ä¸ºå¸¸æ•°æ—¶é—´ï¼Œè¿œè¶…æ•°ç»„çš„ O(n) æ•ˆç‡ã€‚
- **ç¨€ç–å­˜å‚¨ä¼˜åŒ–**ï¼šä»…å­˜å‚¨å®é™…å­˜åœ¨çš„é”®å€¼å¯¹ï¼Œæœªèµ‹å€¼çš„é”®é»˜è®¤è¿”å›ç±»å‹çš„åˆå§‹å€¼ï¼ˆå¦‚ `0`ã€`false`ï¼‰ï¼ŒèŠ‚çœå¤§é‡å­˜å‚¨ç©ºé—´ã€‚
- **å¤©ç„¶é˜²ç¢°æ’**ï¼šä½¿ç”¨ `keccak256` å“ˆå¸Œè®¡ç®—å­˜å‚¨ä½ç½®ï¼Œé¿å…é”®å†²çªã€‚

#### 2. **å…¸å‹åº”ç”¨åœºæ™¯**
- **ä»£å¸ä½™é¢è¿½è¸ª**ï¼š`mapping(address => uint256) public balanceOf;`
- **æƒé™æ§åˆ¶**ï¼š`mapping(address => bool) public isAdmin;`
- **æ•°æ®ç´¢å¼•**ï¼š`mapping(bytes32 => Data) public idToData;`
- **è®¡æ•°å™¨**ï¼š`mapping(address => uint256) public transactionCount;`


### **äºŒã€è¯­æ³•ä¸åŸºç¡€æ“ä½œ**
#### 1. **å£°æ˜ä¸åˆå§‹åŒ–**
```solidity
mapping(KeyType => ValueType) public myMap;
```
- **KeyType**ï¼šæ”¯æŒæ‰€æœ‰å€¼ç±»å‹ï¼ˆå¦‚ `address`ã€`uint`ã€`bytes32`ï¼‰ï¼Œä¸æ”¯æŒå¼•ç”¨ç±»å‹ï¼ˆå¦‚æ•°ç»„ã€ç»“æ„ä½“ï¼‰ã€‚
- **ValueType**ï¼šå¯ä¸ºä»»æ„ç±»å‹ï¼ŒåŒ…æ‹¬åµŒå¥— `mapping` æˆ–ç»“æ„ä½“ã€‚

#### 2. **è¯»å†™æ“ä½œ**
```solidity
contract Example {
    mapping(address => uint256) public balances;

    function setBalance(address user, uint256 amount) external {
        balances[user] = amount; // å†™å…¥å€¼
    }

    function getBalance(address user) external view returns (uint256) {
        return balances[user]; // è¯»å–å€¼ï¼ˆæœªè®¾ç½®æ—¶è¿”å›0ï¼‰
    }
}
```

#### 3. **åµŒå¥—æ˜ å°„**
```solidity
mapping(address => mapping(uint256 => bool)) public userVotes; // ç”¨æˆ·å¯¹ææ¡ˆçš„æŠ•ç¥¨
mapping(bytes32 => mapping(address => uint256)) public tokenBalances; // å¤šä»£å¸ä½™é¢
```


### **ä¸‰ã€é«˜çº§ç‰¹æ€§**
#### 1. **é»˜è®¤å€¼æœºåˆ¶**
æœªèµ‹å€¼çš„é”®è¿”å›ç±»å‹çš„é»˜è®¤å€¼ï¼š
```solidity
mapping(address => uint256) public amounts;
assert(amounts[address(0)] == 0); // é»˜è®¤å€¼ä¸º0

mapping(address => bool) public isRegistered;
assert(isRegistered[address(0)] == false); // é»˜è®¤å€¼ä¸ºfalse
```

#### 2. **è¿­ä»£è§£å†³æ–¹æ¡ˆ**
`mapping` æœ¬èº«ä¸å¯è¿­ä»£ï¼Œä½†å¯ç»“åˆæ•°ç»„å®ç°ï¼š
```solidity
contract IterableMapping {
    mapping(address => uint256) public balances;
    address[] public allUsers;

    function addUser(address user, uint256 amount) external {
        if (balances[user] == 0) {
            allUsers.push(user); // ä»…æ·»åŠ æ–°ç”¨æˆ·
        }
        balances[user] = amount;
    }

    function getUserCount() external view returns (uint256) {
        return allUsers.length;
    }
}
```


### **å››ã€Gas ä¼˜åŒ–æŠ€å·§**
#### 1. **é¿å…é‡å¤å†™å…¥ç›¸åŒå€¼**
```solidity
// ä½æ•ˆ
function setIfNotSet(address user, uint256 amount) external {
    if (balances[user] != amount) { // å¤šä½™æ£€æŸ¥
        balances[user] = amount;
    }
}

// é«˜æ•ˆï¼ˆç›´æ¥å†™å…¥ï¼ŒGasæˆæœ¬å›ºå®šï¼‰
function setBalance(address user, uint256 amount) external {
    balances[user] = amount;
}
```

#### 2. **æ‰¹é‡æ“ä½œ**
```solidity
function batchSetBalances(address[] calldata users, uint256[] calldata amounts) external {
    require(users.length == amounts.length, "Arrays length mismatch");
    for (uint256 i = 0; i < users.length; i++) {
        balances[users[i]] = amounts[i];
    }
}
```


### **äº”ã€å®‰å…¨æ³¨æ„äº‹é¡¹**
#### 1. **é»˜è®¤å€¼é™·é˜±**
```solidity
mapping(address => uint256) public depositTime;

function claimReward() external {
    // å±é™©ï¼šæœªæ£€æŸ¥æ˜¯å¦å·²å­˜æ¬¾ï¼ˆé»˜è®¤å€¼ä¸º0ï¼‰
    require(block.timestamp - depositTime[msg.sender] > 30 days, "Too early");
    // ...
}
```
**ä¿®å¤**ï¼šä½¿ç”¨è¾…åŠ©æ ‡å¿—ä½ï¼š
```solidity
mapping(address => bool) public hasDeposited;
mapping(address => uint256) public depositTime;

function claimReward() external {
    require(hasDeposited[msg.sender], "No deposit");
    // ...
}
```

#### 2. **åµŒå¥—æ˜ å°„çš„åˆ é™¤**
åˆ é™¤åµŒå¥—æ˜ å°„æ—¶éœ€é€çº§åˆ é™¤ï¼š
```solidity
mapping(address => mapping(uint256 => bool)) public votes;

function resetVote(address user, uint256 proposalId) external {
    delete votes[user][proposalId]; // ä»…åˆ é™¤å†…å±‚å€¼
    // è‹¥éœ€å®Œå…¨åˆ é™¤ï¼Œéœ€é¢å¤–æ£€æŸ¥å¤–å±‚æ˜¯å¦ä¸ºç©º
}
```


### **å…­ã€å¯¹æ¯”å…¶ä»–æ•°æ®ç»“æ„**
| æ•°æ®ç»“æ„       | æŸ¥è¯¢æ•ˆç‡ | æ’å…¥æ•ˆç‡ | æœ‰åºæ€§ | é€‚ç”¨åœºæ™¯                     |
|----------------|----------|----------|--------|------------------------------|
| `mapping`      | O(1)     | O(1)     | æ— åº   | å¿«é€Ÿé”®å€¼æŸ¥æ‰¾                 |
| `array`        | O(n)     | O(1)     | æœ‰åº   | éœ€éå†æˆ–æŒ‰ç´¢å¼•è®¿é—®çš„åœºæ™¯     |
| `struct`       | -        | -        | -      | å°è£…å…³è”æ•°æ®                 |
| `mapping`+`array` | O(1)     | O(1)     | æ··åˆ   | éœ€è¿­ä»£çš„æ˜ å°„ï¼ˆå¦‚ç™½åå•ï¼‰     |


### **ä¸ƒã€æ€»ç»“ï¼šä½•æ—¶ä½¿ç”¨ `mapping`**
1. **å¿«é€ŸæŸ¥æ‰¾**ï¼šå½“éœ€è¦é€šè¿‡é”®å¿«é€Ÿå®šä½å€¼æ—¶ï¼ˆå¦‚ç”¨æˆ·ä½™é¢ã€æƒé™ï¼‰ã€‚
2. **ç¨€ç–æ•°æ®**ï¼šå½“æ•°æ®åˆ†å¸ƒæä¸å‡åŒ€æ—¶ï¼ˆå¦‚ä»…å°‘æ•°åœ°å€æŒæœ‰ä»£å¸ï¼‰ã€‚
3. **å¤§æ•°æ®é‡**ï¼šå½“æ•°æ®è§„æ¨¡ä¸ç¡®å®šä¸”å¯èƒ½å¾ˆå¤§æ—¶ï¼ˆé¿å…æ•°ç»„çš„éå†å¼€é”€ï¼‰ã€‚
4. **é˜²ç¢°æ’**ï¼šå½“éœ€è¦å”¯ä¸€æ ‡è¯†æ—¶ï¼ˆå¦‚ä½¿ç”¨ `bytes32` å“ˆå¸Œä½œä¸ºé”®ï¼‰ã€‚

åˆç†ä½¿ç”¨ `mapping` èƒ½æ˜¾è‘—æå‡åˆçº¦æ€§èƒ½ï¼Œé™ä½ Gas æˆæœ¬ï¼Œæ˜¯ Solidity å¼€å‘ä¸­ä¸å¯æˆ–ç¼ºçš„å·¥å…·ã€‚

- ç­”æ¡ˆï¼š `mapping` ç”¨äºåˆ›å»ºé”®å€¼å¯¹æ˜ å°„ï¼Œå¸¸ç”¨äºå­˜å‚¨å…³è”æ•°æ®ï¼Œå¦‚ç”¨æˆ·çš„ä½™é¢ã€‚å®ƒåœ¨æ•°æ®æŸ¥æ‰¾æ–¹é¢æ›´é«˜æ•ˆã€‚

```
mapping(address => uint256) public balances;
```

### `struct` çš„ç”¨é€”åŠå®ä¾‹?

åœ¨ Solidity ä¸­ï¼Œ`mapping` æ˜¯ä¸€ç§å­˜å‚¨é”®å€¼å¯¹çš„æ ¸å¿ƒæ•°æ®ç»“æ„ï¼Œå…¶è®¾è®¡ä¸“ä¸ºåŒºå—é“¾ç¯å¢ƒä¼˜åŒ–ã€‚ä»¥ä¸‹æ˜¯å…³äº `mapping` çš„æ·±åº¦è§£æï¼š


### **ä¸€ã€æ ¸å¿ƒä¼˜åŠ¿ä¸é€‚ç”¨åœºæ™¯**
#### 1. **ä¸ºä½•ä½¿ç”¨ `mapping`ï¼Ÿ**
- **O(1) æ—¶é—´å¤æ‚åº¦**ï¼šæ— è®ºæ•°æ®è§„æ¨¡å¤šå¤§ï¼ŒæŸ¥è¯¢å’Œæ’å…¥æ“ä½œå‡ä¸ºå¸¸æ•°æ—¶é—´ï¼Œè¿œè¶…æ•°ç»„çš„ O(n) æ•ˆç‡ã€‚
- **ç¨€ç–å­˜å‚¨ä¼˜åŒ–**ï¼šä»…å­˜å‚¨å®é™…å­˜åœ¨çš„é”®å€¼å¯¹ï¼Œæœªèµ‹å€¼çš„é”®é»˜è®¤è¿”å›ç±»å‹çš„åˆå§‹å€¼ï¼ˆå¦‚ `0`ã€`false`ï¼‰ï¼ŒèŠ‚çœå¤§é‡å­˜å‚¨ç©ºé—´ã€‚
- **å¤©ç„¶é˜²ç¢°æ’**ï¼šä½¿ç”¨ `keccak256` å“ˆå¸Œè®¡ç®—å­˜å‚¨ä½ç½®ï¼Œé¿å…é”®å†²çªã€‚

#### 2. **å…¸å‹åº”ç”¨åœºæ™¯**
- **ä»£å¸ä½™é¢è¿½è¸ª**ï¼š`mapping(address => uint256) public balanceOf;`
- **æƒé™æ§åˆ¶**ï¼š`mapping(address => bool) public isAdmin;`
- **æ•°æ®ç´¢å¼•**ï¼š`mapping(bytes32 => Data) public idToData;`
- **è®¡æ•°å™¨**ï¼š`mapping(address => uint256) public transactionCount;`


### **äºŒã€è¯­æ³•ä¸åŸºç¡€æ“ä½œ**
#### 1. **å£°æ˜ä¸åˆå§‹åŒ–**
```solidity
mapping(KeyType => ValueType) public myMap;
```
- **KeyType**ï¼šæ”¯æŒæ‰€æœ‰å€¼ç±»å‹ï¼ˆå¦‚ `address`ã€`uint`ã€`bytes32`ï¼‰ï¼Œä¸æ”¯æŒå¼•ç”¨ç±»å‹ï¼ˆå¦‚æ•°ç»„ã€ç»“æ„ä½“ï¼‰ã€‚
- **ValueType**ï¼šå¯ä¸ºä»»æ„ç±»å‹ï¼ŒåŒ…æ‹¬åµŒå¥— `mapping` æˆ–ç»“æ„ä½“ã€‚

#### 2. **è¯»å†™æ“ä½œ**
```solidity
contract Example {
    mapping(address => uint256) public balances;

    function setBalance(address user, uint256 amount) external {
        balances[user] = amount; // å†™å…¥å€¼
    }

    function getBalance(address user) external view returns (uint256) {
        return balances[user]; // è¯»å–å€¼ï¼ˆæœªè®¾ç½®æ—¶è¿”å›0ï¼‰
    }
}
```

#### 3. **åµŒå¥—æ˜ å°„**
```solidity
mapping(address => mapping(uint256 => bool)) public userVotes; // ç”¨æˆ·å¯¹ææ¡ˆçš„æŠ•ç¥¨
mapping(bytes32 => mapping(address => uint256)) public tokenBalances; // å¤šä»£å¸ä½™é¢
```


### **ä¸‰ã€é«˜çº§ç‰¹æ€§**
#### 1. **é»˜è®¤å€¼æœºåˆ¶**
æœªèµ‹å€¼çš„é”®è¿”å›ç±»å‹çš„é»˜è®¤å€¼ï¼š
```solidity
mapping(address => uint256) public amounts;
assert(amounts[address(0)] == 0); // é»˜è®¤å€¼ä¸º0

mapping(address => bool) public isRegistered;
assert(isRegistered[address(0)] == false); // é»˜è®¤å€¼ä¸ºfalse
```

#### 2. **è¿­ä»£è§£å†³æ–¹æ¡ˆ**
`mapping` æœ¬èº«ä¸å¯è¿­ä»£ï¼Œä½†å¯ç»“åˆæ•°ç»„å®ç°ï¼š
```solidity
contract IterableMapping {
    mapping(address => uint256) public balances;
    address[] public allUsers;

    function addUser(address user, uint256 amount) external {
        if (balances[user] == 0) {
            allUsers.push(user); // ä»…æ·»åŠ æ–°ç”¨æˆ·
        }
        balances[user] = amount;
    }

    function getUserCount() external view returns (uint256) {
        return allUsers.length;
    }
}
```


### **å››ã€Gas ä¼˜åŒ–æŠ€å·§**
#### 1. **é¿å…é‡å¤å†™å…¥ç›¸åŒå€¼**
```solidity
// ä½æ•ˆ
function setIfNotSet(address user, uint256 amount) external {
    if (balances[user] != amount) { // å¤šä½™æ£€æŸ¥
        balances[user] = amount;
    }
}

// é«˜æ•ˆï¼ˆç›´æ¥å†™å…¥ï¼ŒGasæˆæœ¬å›ºå®šï¼‰
function setBalance(address user, uint256 amount) external {
    balances[user] = amount;
}
```

#### 2. **æ‰¹é‡æ“ä½œ**
```solidity
function batchSetBalances(address[] calldata users, uint256[] calldata amounts) external {
    require(users.length == amounts.length, "Arrays length mismatch");
    for (uint256 i = 0; i < users.length; i++) {
        balances[users[i]] = amounts[i];
    }
}
```


### **äº”ã€å®‰å…¨æ³¨æ„äº‹é¡¹**
#### 1. **é»˜è®¤å€¼é™·é˜±**
```solidity
mapping(address => uint256) public depositTime;

function claimReward() external {
    // å±é™©ï¼šæœªæ£€æŸ¥æ˜¯å¦å·²å­˜æ¬¾ï¼ˆé»˜è®¤å€¼ä¸º0ï¼‰
    require(block.timestamp - depositTime[msg.sender] > 30 days, "Too early");
    // ...
}
```
**ä¿®å¤**ï¼šä½¿ç”¨è¾…åŠ©æ ‡å¿—ä½ï¼š
```solidity
mapping(address => bool) public hasDeposited;
mapping(address => uint256) public depositTime;

function claimReward() external {
    require(hasDeposited[msg.sender], "No deposit");
    // ...
}
```

#### 2. **åµŒå¥—æ˜ å°„çš„åˆ é™¤**
åˆ é™¤åµŒå¥—æ˜ å°„æ—¶éœ€é€çº§åˆ é™¤ï¼š
```solidity
mapping(address => mapping(uint256 => bool)) public votes;

function resetVote(address user, uint256 proposalId) external {
    delete votes[user][proposalId]; // ä»…åˆ é™¤å†…å±‚å€¼
    // è‹¥éœ€å®Œå…¨åˆ é™¤ï¼Œéœ€é¢å¤–æ£€æŸ¥å¤–å±‚æ˜¯å¦ä¸ºç©º
}
```


### **å…­ã€å¯¹æ¯”å…¶ä»–æ•°æ®ç»“æ„**
| æ•°æ®ç»“æ„       | æŸ¥è¯¢æ•ˆç‡ | æ’å…¥æ•ˆç‡ | æœ‰åºæ€§ | é€‚ç”¨åœºæ™¯                     |
|----------------|----------|----------|--------|------------------------------|
| `mapping`      | O(1)     | O(1)     | æ— åº   | å¿«é€Ÿé”®å€¼æŸ¥æ‰¾                 |
| `array`        | O(n)     | O(1)     | æœ‰åº   | éœ€éå†æˆ–æŒ‰ç´¢å¼•è®¿é—®çš„åœºæ™¯     |
| `struct`       | -        | -        | -      | å°è£…å…³è”æ•°æ®                 |
| `mapping`+`array` | O(1)     | O(1)     | æ··åˆ   | éœ€è¿­ä»£çš„æ˜ å°„ï¼ˆå¦‚ç™½åå•ï¼‰     |


### **ä¸ƒã€æ€»ç»“ï¼šä½•æ—¶ä½¿ç”¨ `mapping`**
1. **å¿«é€ŸæŸ¥æ‰¾**ï¼šå½“éœ€è¦é€šè¿‡é”®å¿«é€Ÿå®šä½å€¼æ—¶ï¼ˆå¦‚ç”¨æˆ·ä½™é¢ã€æƒé™ï¼‰ã€‚
2. **ç¨€ç–æ•°æ®**ï¼šå½“æ•°æ®åˆ†å¸ƒæä¸å‡åŒ€æ—¶ï¼ˆå¦‚ä»…å°‘æ•°åœ°å€æŒæœ‰ä»£å¸ï¼‰ã€‚
3. **å¤§æ•°æ®é‡**ï¼šå½“æ•°æ®è§„æ¨¡ä¸ç¡®å®šä¸”å¯èƒ½å¾ˆå¤§æ—¶ï¼ˆé¿å…æ•°ç»„çš„éå†å¼€é”€ï¼‰ã€‚
4. **é˜²ç¢°æ’**ï¼šå½“éœ€è¦å”¯ä¸€æ ‡è¯†æ—¶ï¼ˆå¦‚ä½¿ç”¨ `bytes32` å“ˆå¸Œä½œä¸ºé”®ï¼‰ã€‚

åˆç†ä½¿ç”¨ `mapping` èƒ½æ˜¾è‘—æå‡åˆçº¦æ€§èƒ½ï¼Œé™ä½ Gas æˆæœ¬ï¼Œæ˜¯ Solidity å¼€å‘ä¸­ä¸å¯æˆ–ç¼ºçš„å·¥å…·ã€‚

- ç­”æ¡ˆï¼š `struct` å…è®¸åˆ›å»ºè‡ªå®šä¹‰çš„æ•°æ®ç»“æ„ï¼ŒåŒ…å«å¤šä¸ªä¸åŒç±»å‹çš„å­—æ®µã€‚é€‚ç”¨äºå¤æ‚æ•°æ®ç»„åˆçš„åœºæ™¯ã€‚

```
struct Person {
    string name;
    uint256 age;
}
```

### ä½•æ—¶ä½¿ç”¨ `enum` ä»¥åŠå…¶å¥½å¤„æ˜¯ä»€ä¹ˆï¼Ÿ

åœ¨ Solidity ä¸­ï¼Œ`enum`ï¼ˆæšä¸¾ï¼‰æ˜¯ä¸€ç§ç”¨äºå®šä¹‰å‘½åå¸¸é‡é›†åˆçš„è½»é‡çº§ç±»å‹ï¼Œå…¶è®¾è®¡ç›®çš„æ˜¯æé«˜ä»£ç çš„å¯è¯»æ€§å’Œå®‰å…¨æ€§ã€‚ä»¥ä¸‹æ˜¯å…³äº `enum` çš„æ·±åº¦è§£æï¼š


### **ä¸€ã€æ ¸å¿ƒæ¦‚å¿µä¸è¯­æ³•**
#### 1. **å®šä¹‰æšä¸¾ç±»å‹**
```solidity
enum Status {
    Pending,  // é»˜è®¤ä¸º0
    Active,   // 1
    Inactive, // 2
    Terminated // 3
}
```
- **è‡ªåŠ¨èµ‹å€¼**ï¼šæšä¸¾æˆå‘˜é»˜è®¤ä» 0 å¼€å§‹é€’å¢ã€‚
- **æ˜¾å¼èµ‹å€¼**ï¼šå¯æŒ‡å®šç‰¹å®šå€¼ï¼ˆéœ€ä¸º `uint8` èŒƒå›´ï¼‰ï¼š
  ```solidity
  enum ErrorCode {
      OK = 0,
      NotFound = 404,
      InternalError = 500
  }
  ```

#### 2. **ä½¿ç”¨æšä¸¾å˜é‡**
```solidity
contract Example {
    Status public currentStatus = Status.Active;

    function setStatus(Status _status) external {
        currentStatus = _status;
    }

    function isActive() external view returns (bool) {
        return currentStatus == Status.Active;
    }
}
```


### **äºŒã€ä¸ºä½•ä½¿ç”¨ `enum`ï¼Ÿ**
#### 1. **æå‡ä»£ç å¯è¯»æ€§**
- **é—®é¢˜**ï¼šä½¿ç”¨ `uint8` æˆ– `string` è¡¨ç¤ºçŠ¶æ€æ—¶ï¼Œæ•°å€¼æˆ–å­—ç¬¦ä¸²æœ¬èº«ä¸æºå¸¦è¯­ä¹‰ã€‚
  ```solidity
  // éš¾ä»¥ç†è§£çš„ä»£ç 
  if (status == 1) { ... } // 1ä»£è¡¨ä»€ä¹ˆï¼Ÿ
  
  // æ¸…æ™°çš„ä»£ç 
  if (status == Status.Active) { ... }
  ```

#### 2. **ç±»å‹å®‰å…¨**
- **é™åˆ¶å–å€¼èŒƒå›´**ï¼š`enum` å˜é‡åªèƒ½èµ‹å€¼ä¸ºé¢„å®šä¹‰çš„æˆå‘˜ï¼Œé˜²æ­¢æ— æ•ˆå€¼ã€‚
  ```solidity
  // é”™è¯¯ï¼šæ— æ³•ç¼–è¯‘
  currentStatus = Status(4); // è¶…å‡ºå®šä¹‰èŒƒå›´
  ```

#### 3. **èŠ‚çœ Gas**
- **å­˜å‚¨ä¼˜åŒ–**ï¼š`enum` åœ¨å­˜å‚¨ä¸­å ç”¨æœ€å°ç©ºé—´ï¼ˆå¦‚ 4 ä¸ªæˆå‘˜çš„ `enum` ä»…éœ€ 2 ä½ï¼‰ï¼Œç›¸æ¯” `uint8` æ›´èŠ‚çœ Gasã€‚


### **ä¸‰ã€å…¸å‹åº”ç”¨åœºæ™¯**
#### 1. **åˆçº¦çŠ¶æ€æœº**
```solidity
enum ContractState {
    Deployed,
    Funded,
    Active,
    Closed
}

ContractState public state = ContractState.Deployed;

modifier onlyInState(ContractState _state) {
    require(state == _state, "Invalid state");
    _;
}

function activate() external onlyInState(ContractState.Funded) {
    state = ContractState.Active;
}
```

#### 2. **è®¢å•/äº¤æ˜“çŠ¶æ€**
```solidity
enum OrderStatus {
    Created,
    Paid,
    Shipped,
    Completed,
    Refunded
}

mapping(uint256 => OrderStatus) public orderStatus;

function markShipped(uint256 orderId) external {
    require(orderStatus[orderId] == OrderStatus.Paid, "Order not paid");
    orderStatus[orderId] = OrderStatus.Shipped;
}
```

#### 3. **æƒé™çº§åˆ«**
```solidity
enum Role {
    User,
    Moderator,
    Admin,
    Owner
}

mapping(address => Role) public userRoles;

function grantAdmin(address user) external onlyOwner {
    userRoles[user] = Role.Admin;
}
```


### **å››ã€ä¸å…¶ä»–ç±»å‹çš„å¯¹æ¯”**
| ç±»å‹       | ä¼˜åŠ¿                          | åŠ£åŠ¿                          | é€‚ç”¨åœºæ™¯                     |
|------------|-------------------------------|-------------------------------|------------------------------|
| `enum`     | ç±»å‹å®‰å…¨ã€å¯è¯»æ€§é«˜ã€èŠ‚çœ Gas  | æˆå‘˜æ•°é‡å›ºå®šã€æ— æ³•åŠ¨æ€æ‰©å±•    | çŠ¶æ€æœºã€å›ºå®šé€‰é¡¹é›†åˆ         |
| `uint8`    | çµæ´»ã€å¯åŠ¨æ€æ‰©å±•              | æ— ç±»å‹æ£€æŸ¥ã€å¯è¯»æ€§å·®          | éœ€åŠ¨æ€å¢å‡é€‰é¡¹çš„åœºæ™¯         |
| `string`   | è¯­ä¹‰æ˜ç¡®ã€å¯åŠ¨æ€æ‰©å±•          | å­˜å‚¨å’Œæ¯”è¾ƒæˆæœ¬é«˜ã€æ— ç±»å‹æ£€æŸ¥  | éœ€äººç±»å¯è¯»æ–‡æœ¬çš„é…ç½®é¡¹       |


### **äº”ã€æ³¨æ„äº‹é¡¹**
#### 1. **æˆå‘˜æ•°é‡é™åˆ¶**
- **å­˜å‚¨ä¼˜åŒ–**ï¼šæˆå‘˜æ•° â‰¤ 256 æ—¶ï¼Œ`enum` ä½¿ç”¨æœ€å°ä½æ•°å­˜å‚¨ï¼ˆå¦‚ 3 ä¸ªæˆå‘˜ç”¨ 2 ä½ï¼‰ã€‚
- **é¿å…è¿‡åº¦æ‰©å±•**ï¼šè‹¥æˆå‘˜æ•°è¶…è¿‡ 256ï¼Œä¼šè‡ªåŠ¨å‡çº§ä¸º `uint256`ï¼Œå¢åŠ å­˜å‚¨æˆæœ¬ã€‚

#### 2. **è¿ç§»é£é™©**
- **åˆçº¦å‡çº§**ï¼šæ·»åŠ æˆ–åˆ é™¤ `enum` æˆå‘˜å¯èƒ½å¯¼è‡´å­˜å‚¨å¸ƒå±€å˜åŒ–ï¼Œéœ€è°¨æ…å¤„ç†ã€‚

#### 3. **ä¸å¤–éƒ¨ç³»ç»Ÿäº¤äº’**
- **ABI è½¬æ¢**ï¼š`enum` åœ¨ ABI ä¸­è¡¨ç°ä¸º `uint8`ï¼Œå¤–éƒ¨è°ƒç”¨éœ€æ³¨æ„ç±»å‹è½¬æ¢ã€‚


### **å…­ã€æœ€ä½³å®è·µ**
1. **å‘½åè§„èŒƒ**ï¼šä½¿ç”¨å•æ•°å½¢å¼ï¼ˆå¦‚ `Status` è€Œé `Statuses`ï¼‰ã€‚
2. **å‰ç½®æ£€æŸ¥**ï¼šåœ¨ä¿®æ”¹ `enum` å˜é‡å‰ï¼ŒéªŒè¯çŠ¶æ€è½¬æ¢çš„åˆæ³•æ€§ã€‚
   ```solidity
   function transitionToActive() external {
       require(
           currentStatus == Status.Pending,
           "Can only transition from Pending to Active"
       );
       currentStatus = Status.Active;
   }
   ```
3. **è¾…åŠ©å‡½æ•°**ï¼šæ·»åŠ è·å–æšä¸¾åç§°çš„çº¯å‡½æ•°ï¼ˆéœ€æ‰‹åŠ¨å®ç°ï¼‰ã€‚
   ```solidity
   function getStatusName() external view returns (string memory) {
       if (currentStatus == Status.Pending) return "Pending";
       if (currentStatus == Status.Active) return "Active";
       // ...
   }
   ```


### **ä¸ƒã€æ€»ç»“ï¼šä½•æ—¶ä½¿ç”¨ `enum`**
1. **å›ºå®šé€‰é¡¹é›†åˆ**ï¼šå½“å€¼çš„èŒƒå›´æ˜¯é¢„å®šä¹‰ä¸”ä¸å˜çš„ï¼ˆå¦‚çŠ¶æ€ã€è§’è‰²ï¼‰ã€‚
2. **ç±»å‹å®‰å…¨éœ€æ±‚**ï¼šéœ€è¦ç¡®ä¿å˜é‡åªèƒ½å–ç‰¹å®šå€¼ï¼Œé˜²æ­¢æ— æ•ˆè¾“å…¥ã€‚
3. **ä»£ç å¯è¯»æ€§**ï¼šé€šè¿‡æœ‰æ„ä¹‰çš„åç§°æ›¿ä»£æ— æ„ä¹‰çš„æ•°å€¼æˆ–å­—ç¬¦ä¸²ã€‚
4. **Gas ä¼˜åŒ–**ï¼šåœ¨å­˜å‚¨å¯†é›†å‹åœºæ™¯ä¸­ï¼Œæ›¿ä»£ `uint8` ä»¥èŠ‚çœç©ºé—´ã€‚

åˆç†ä½¿ç”¨ `enum` èƒ½ä½¿åˆçº¦ä»£ç æ›´å¥å£®ã€æ›´æ˜“ç»´æŠ¤ï¼Œæ˜¯ Solidity å¼€å‘ä¸­çš„é‡è¦å·¥å…·ä¹‹ä¸€ã€‚

- ç­”æ¡ˆï¼š `enum` ç”¨äºå®šä¹‰ä¸€ç»„å‘½åå¸¸é‡ï¼Œé™åˆ¶å˜é‡çš„å–å€¼èŒƒå›´ï¼Œé€‚ç”¨äºæœ‰é™é€‰é¡¹çš„æƒ…å†µã€‚

```
enum Status { Pending, Approved, Rejected }
```

### åœ¨è®¾è®¡åˆçº¦æ—¶å¦‚ä½•è€ƒè™‘å­˜å‚¨å’Œ Gas æˆæœ¬ï¼Ÿ

åœ¨è®¾è®¡ Solidity åˆçº¦æ—¶ï¼Œå­˜å‚¨å’Œ Gas æˆæœ¬æ˜¯æ ¸å¿ƒè€ƒé‡å› ç´ ï¼Œç›´æ¥å½±å“åˆçº¦çš„ç»æµæ€§å’Œå¯ç”¨æ€§ã€‚ä»¥ä¸‹æ˜¯ç³»ç»Ÿæ€§çš„ä¼˜åŒ–ç­–ç•¥ï¼š


### **ä¸€ã€å­˜å‚¨æˆæœ¬ä¼˜åŒ–**
#### 1. **å˜é‡æ‰“åŒ…å­˜å‚¨**
- **EVM å­˜å‚¨è§„åˆ™**ï¼šæ¯ä¸ªå­˜å‚¨æ§½ï¼ˆSlotï¼‰ä¸º 32 å­—èŠ‚ï¼Œç›¸é‚»å˜é‡è‹¥æ€»å¤§å° â‰¤ 32 å­—èŠ‚ä¼šæ‰“åŒ…å­˜å‚¨ã€‚
- **ä¼˜åŒ–æŠ€å·§**ï¼š
  ```solidity
  // ä¸è‰¯è®¾è®¡ï¼ˆå ç”¨3ä¸ªæ§½ï¼‰
  uint8 a;    // 1å­—èŠ‚
  uint256 b;  // 32å­—èŠ‚
  uint8 c;    // 1å­—èŠ‚
  
  // ä¼˜åŒ–è®¾è®¡ï¼ˆå ç”¨2ä¸ªæ§½ï¼‰
  uint256 b;  // 32å­—èŠ‚
  uint8 a;    // 1å­—èŠ‚
  uint8 c;    // 1å­—èŠ‚ï¼ˆä¸aå…±ç”¨ä¸€ä¸ªæ§½ï¼‰
  ```

#### 2. **ä½¿ç”¨ç´§å‡‘æ•°æ®ç±»å‹**
- **æŒ‰éœ€é€‰æ‹©**ï¼šä¼˜å…ˆä½¿ç”¨æ»¡è¶³éœ€æ±‚çš„æœ€å°ç±»å‹ï¼ˆå¦‚ `uint16` ä»£æ›¿ `uint256`ï¼‰ã€‚
- **æšä¸¾ï¼ˆ`enum`ï¼‰**ï¼šæ›¿ä»£ `uint8` è¡¨ç¤ºæœ‰é™çŠ¶æ€é›†åˆï¼ŒèŠ‚çœå­˜å‚¨ã€‚
  ```solidity
  enum Status { Pending, Active, Closed } // æœ€å¤šå ç”¨2ä½
  ```

#### 3. **é¿å…åŠ¨æ€æ•°ç»„å’Œæ˜ å°„çš„è¿‡åº¦ä½¿ç”¨**
- **åŠ¨æ€ç»“æ„æˆæœ¬**ï¼šæ¯æ¬¡æ‰©å±•éœ€é¢å¤–å­˜å‚¨ç®¡ç†å¼€é”€ã€‚
- **æ›¿ä»£æ–¹æ¡ˆ**ï¼š
  - ä½¿ç”¨å›ºå®šå¤§å°æ•°ç»„ï¼ˆå¦‚ `uint256[100]`ï¼‰ã€‚
  - ç»“åˆæ˜ å°„å’Œè®¡æ•°å™¨ï¼ˆå¦‚ `mapping(uint256 => Data)` + `uint256 count`ï¼‰ã€‚


### **äºŒã€Gas æˆæœ¬ä¼˜åŒ–**
#### 1. **å‡å°‘å­˜å‚¨å†™å…¥**
- **å­˜å‚¨å†™å…¥ vs å†…å­˜æ“ä½œ**ï¼šå­˜å‚¨å†™å…¥ï¼ˆSSTOREï¼‰æ˜¯æœ€æ˜‚è´µçš„æ“ä½œï¼ˆ20000 Gasï¼‰ï¼Œå†…å­˜æ“ä½œï¼ˆMSTOREï¼‰ä»… 3 Gasã€‚
  ```solidity
  // ä½æ•ˆ
  function sum(uint256[] calldata nums) external {
      uint256 total = 0;
      for (uint256 i = 0; i < nums.length; i++) {
          total += nums[i];
          s[i] = total; // ä¸å¿…è¦çš„å­˜å‚¨å†™å…¥
      }
  }
  
  // é«˜æ•ˆ
  function sum(uint256[] calldata nums) external returns (uint256) {
      uint256 total = 0;
      for (uint256 i = 0; i < nums.length; i++) {
          total += nums[i]; // ä»…å†…å­˜æ“ä½œ
      }
      return total;
  }
  ```

#### 2. **ç¼“å­˜å­˜å‚¨å˜é‡**
- **å¤šæ¬¡è®¿é—®åŒä¸€å˜é‡**ï¼šå°†å­˜å‚¨å˜é‡ç¼“å­˜åˆ°å†…å­˜ä¸­ï¼ˆ`memory`ï¼‰ã€‚
  ```solidity
  struct User {
      uint256 balance;
      uint256 lastActive;
  }
  
  mapping(address => User) public users;
  
  function updateUser(address user) external {
      User storage userData = users[user]; // ç¼“å­˜å­˜å‚¨å¼•ç”¨
      userData.balance += 100;
      userData.lastActive = block.timestamp;
  }
  ```

#### 3. **æ‰¹é‡æ“ä½œä»£æ›¿å¤šæ¬¡è°ƒç”¨**
- **å•æ¬¡äº¤æ˜“æ‰§è¡Œå¤šæ“ä½œ**ï¼šå‡å°‘äº¤æ˜“å‘èµ·æˆæœ¬ï¼ˆçº¦ 21000 Gas/æ¬¡ï¼‰ã€‚
  ```solidity
  function batchTransfer(address[] calldata recipients, uint256[] calldata amounts) external {
      require(recipients.length == amounts.length, "Arrays length mismatch");
      for (uint256 i = 0; i < recipients.length; i++) {
          transfer(recipients[i], amounts[i]);
      }
  }
  ```


### **ä¸‰ã€é«˜çº§ä¼˜åŒ–æŠ€å·§**
#### 1. **ä½è¿ç®—ä¸ç»“æ„ä½“æ‰“åŒ…**
- **å¤šçŠ¶æ€æ ‡å¿—ä½**ï¼šä½¿ç”¨ `uint256` ä¸­çš„ä¸åŒä½è¡¨ç¤ºå¤šä¸ªå¸ƒå°”å€¼ã€‚
  ```solidity
  uint256 public flags; // 0b0000...0000
  
  function setFlag(uint256 bitIndex, bool value) external {
      if (value) {
          flags |= (1 << bitIndex); // è®¾ç½®ä½
      } else {
          flags &= ~(1 << bitIndex); // æ¸…é™¤ä½
      }
  }
  
  function getFlag(uint256 bitIndex) external view returns (bool) {
      return (flags & (1 << bitIndex)) != 0; // æ£€æŸ¥ä½
  }
  ```

#### 2. **å»¶è¿Ÿå­˜å‚¨å†™å…¥**
- **ä¸­é—´è®¡ç®—åœ¨å†…å­˜ä¸­å®Œæˆ**ï¼šä»…åœ¨å¿…è¦æ—¶å†™å…¥å­˜å‚¨ã€‚
  ```solidity
  function complexCalculation() external {
      uint256 a = loadFromStorage();
      uint256 b = loadFromStorage();
      uint256 result = a * b / 100; // å†…å­˜è®¡ç®—
      if (result > THRESHOLD) {
          saveToStorage(result); // ä»…åœ¨æ¡ä»¶æ»¡è¶³æ—¶å†™å…¥
      }
  }
  ```

#### 3. **æ˜ å°„ï¼ˆ`mapping`ï¼‰æ›¿ä»£æ•°ç»„**
- **ç¨€ç–æ•°æ®**ï¼šæ˜ å°„çš„æŸ¥è¯¢æ•ˆç‡ä¸º O(1)ï¼Œä¸”ä¸å­˜å‚¨æœªåˆå§‹åŒ–çš„é”®ã€‚
  ```solidity
  // é«˜æ•ˆï¼šä»…å­˜å‚¨å®é™…å­˜åœ¨çš„ç”¨æˆ·
  mapping(address => uint256) public balances;
  
  // ä½æ•ˆï¼šéœ€é¢„å…ˆåˆ†é…ç©ºé—´
  address[] public allUsers;
  uint256[] public userBalances;
  ```


### **å››ã€å­˜å‚¨æ¸…é™¤ä¸é‡ç½®**
- **åˆ é™¤å­˜å‚¨å˜é‡**ï¼šå°†å­˜å‚¨æ§½é‡ç½®ä¸º 0 å¯å›æ”¶ 15000 Gasã€‚
  ```solidity
  function resetUser(address user) external {
      delete users[user]; // æ¸…é™¤æ•´ä¸ªç»“æ„ä½“
  }
  ```

- **éƒ¨åˆ†é‡ç½®**ï¼šä»…ä¿®æ”¹éœ€è¦æ›´æ–°çš„å­—æ®µã€‚
  ```solidity
  function partialReset(address user) external {
      users[user].balance = 0; // ä»…é‡ç½®ä½™é¢
  }
  ```


### **äº”ã€å·¥å…·ä¸åˆ†æ**
1. **Gas åˆ†æå·¥å…·**ï¼š
   - **Hardhat/Truffle**ï¼šå†…ç½® Gas æŠ¥å‘ŠåŠŸèƒ½ã€‚
   - **Solidity ç¼–è¯‘å™¨**ï¼šä½¿ç”¨ `--gas` é€‰é¡¹åˆ†æåˆçº¦å„å‡½æ•° Gas æ¶ˆè€—ã€‚

2. **å­˜å‚¨å¸ƒå±€å¯è§†åŒ–**ï¼š
   - **solc**ï¼šä½¿ç”¨ `--storage-layout` æŸ¥çœ‹å˜é‡å­˜å‚¨ä½ç½®ã€‚
   - **Slither**ï¼šæ£€æµ‹æ½œåœ¨çš„å­˜å‚¨å’Œ Gas ä¼˜åŒ–ç‚¹ã€‚


### **å…­ã€æ³¨æ„äº‹é¡¹**
1. **æƒè¡¡ä¼˜åŒ–ä¸å¯è¯»æ€§**ï¼šè¿‡åº¦ç´§å‡‘çš„ä»£ç å¯èƒ½é™ä½å¯ç»´æŠ¤æ€§ã€‚
2. **é¿å…è¿‡æ—©ä¼˜åŒ–**ï¼šä¼˜å…ˆä¿è¯åŠŸèƒ½æ­£ç¡®æ€§ï¼Œå†è¿›è¡Œæ€§èƒ½ä¼˜åŒ–ã€‚
3. **æµ‹è¯•ä¸åŒæ–¹æ¡ˆ**ï¼šç›¸åŒæ“ä½œåœ¨ä¸åŒåœºæ™¯ä¸‹çš„ Gas æˆæœ¬å¯èƒ½ä¸åŒï¼Œéœ€å®é™…æµ‹è¯•éªŒè¯ã€‚


### **ä¸ƒã€æ€»ç»“ï¼šä¼˜åŒ–å†³ç­–æ ‘**
1. **æ˜¯å¦é¢‘ç¹è¯»å†™ï¼Ÿ**  
   - æ˜¯ â†’ ä¼˜å…ˆå‡å°‘å­˜å‚¨æ“ä½œï¼Œä½¿ç”¨å†…å­˜ç¼“å­˜ã€‚  
   - å¦ â†’ è¿›å…¥ä¸‹ä¸€æ­¥ã€‚  

2. **æ•°æ®æ˜¯å¦ç»“æ„åŒ–ï¼Ÿ**  
   - æ˜¯ â†’ ä½¿ç”¨ç»“æ„ä½“æ‰“åŒ…å˜é‡ï¼Œæ³¨æ„å­—æ®µé¡ºåºã€‚  
   - å¦ â†’ è¿›å…¥ä¸‹ä¸€æ­¥ã€‚  

3. **æ•°æ®æ˜¯å¦ç¨€ç–ï¼Ÿ**  
   - æ˜¯ â†’ ä½¿ç”¨æ˜ å°„è€Œéæ•°ç»„ã€‚  
   - å¦ â†’ è€ƒè™‘å›ºå®šå¤§å°æ•°ç»„ã€‚  

4. **æ˜¯å¦å¯æ‰¹é‡å¤„ç†ï¼Ÿ**  
   - æ˜¯ â†’ è®¾è®¡æ‰¹é‡æ“ä½œæ¥å£ï¼Œå‡å°‘äº¤æ˜“æ¬¡æ•°ã€‚  

é€šè¿‡ç³»ç»Ÿæ€§çš„å­˜å‚¨å’Œ Gas ä¼˜åŒ–ï¼Œå¯æ˜¾è‘—é™ä½åˆçº¦ä½¿ç”¨æˆæœ¬ï¼Œæå‡ç”¨æˆ·ä½“éªŒå’Œåè®®ç«äº‰åŠ›ã€‚

- ç­”æ¡ˆï¼š åº”é€‰æ‹©é«˜æ•ˆçš„æ•°æ®ç»“æ„ä»¥å‡å°‘å­˜å‚¨å’Œæ‰§è¡Œæˆæœ¬ã€‚ä¾‹å¦‚ï¼Œ`mapping` é€šå¸¸æ¯”æ•°ç»„æ›´èŠ‚çœ Gas æˆæœ¬ï¼Œç‰¹åˆ«æ˜¯åœ¨å¤§è§„æ¨¡æ•°æ®æŸ¥æ‰¾æ—¶ã€‚

### å¦‚ä½•æ ¹æ®æ•°æ®è®¿é—®æ¨¡å¼é€‰æ‹©æ•°æ®ç»“æ„ï¼Ÿ

åœ¨ Solidity ä¸­é€‰æ‹©æ•°æ®ç»“æ„æ—¶ï¼Œéœ€æ ¹æ®æ•°æ®çš„**è®¿é—®æ¨¡å¼**ï¼ˆè¯»/å†™é¢‘ç‡ã€æŸ¥è¯¢æ–¹å¼ã€éå†éœ€æ±‚ç­‰ï¼‰è¿›è¡Œé’ˆå¯¹æ€§ä¼˜åŒ–ã€‚ä»¥ä¸‹æ˜¯åŸºäºè®¿é—®æ¨¡å¼çš„é€‰å‹æŒ‡å—ï¼š


### **ä¸€ã€æ•°æ®è®¿é—®æ¨¡å¼åˆ†ç±»**
#### 1. **éšæœºè¯»å†™ï¼ˆRandom Accessï¼‰**
- **åœºæ™¯**ï¼šé€šè¿‡å”¯ä¸€é”®å¿«é€Ÿè¯»å†™æ•°æ®ï¼ˆå¦‚ç”¨æˆ·ä½™é¢æŸ¥è¯¢ï¼‰ã€‚
- **æ ¸å¿ƒéœ€æ±‚**ï¼šO(1) æ—¶é—´å¤æ‚åº¦ã€‚

#### 2. **é¡ºåºéå†ï¼ˆSequential Traversalï¼‰**
- **åœºæ™¯**ï¼šæŒ‰é¡ºåºå¤„ç†æ‰€æœ‰æˆ–éƒ¨åˆ†æ•°æ®ï¼ˆå¦‚æ‰¹é‡ä»»åŠ¡æ‰§è¡Œï¼‰ã€‚
- **æ ¸å¿ƒéœ€æ±‚**ï¼šé«˜æ•ˆéå†ï¼Œé¿å… OutOfGasã€‚

#### 3. **æ’å…¥/åˆ é™¤å¯†é›†ï¼ˆInsertion/Deletion-Heavyï¼‰**
- **åœºæ™¯**ï¼šé¢‘ç¹æ·»åŠ æˆ–åˆ é™¤æ•°æ®ï¼ˆå¦‚åŠ¨æ€ç™½åå•ç®¡ç†ï¼‰ã€‚
- **æ ¸å¿ƒéœ€æ±‚**ï¼šä½æ’å…¥/åˆ é™¤æˆæœ¬ã€‚

#### 4. **å­˜åœ¨æ€§æ£€æŸ¥ï¼ˆMembership Checkï¼‰**
- **åœºæ™¯**ï¼šå¿«é€ŸéªŒè¯å…ƒç´ æ˜¯å¦å­˜åœ¨ï¼ˆå¦‚æƒé™éªŒè¯ï¼‰ã€‚
- **æ ¸å¿ƒéœ€æ±‚**ï¼šO(1) å­˜åœ¨æ€§åˆ¤æ–­ã€‚


### **äºŒã€æ•°æ®ç»“æ„é€‰å‹çŸ©é˜µ**
| è®¿é—®æ¨¡å¼               | æ¨èæ•°æ®ç»“æ„                     | å…¸å‹åº”ç”¨åœºæ™¯                     | å…³é”®ä¼˜åŠ¿               |
|------------------------|----------------------------------|----------------------------------|------------------------|
| éšæœºè¯»å†™               | `mapping`                        | ç”¨æˆ·ä½™é¢ã€é…ç½®å‚æ•°               | O(1) æŸ¥è¯¢ä¸å†™å…¥        |
| é¡ºåºéå†               | å›ºå®šå¤§å°æ•°ç»„ `T[size]`           | æ‰¹é‡ä»»åŠ¡ã€å›ºå®šé•¿åº¦æ•°æ®é›†         | è¿ç»­å†…å­˜è®¿é—®é«˜æ•ˆ       |
| åŠ¨æ€é¡ºåºéå†           | åŠ¨æ€æ•°ç»„ `T[]` + æ˜ å°„è¾…åŠ©        | æ´»åŠ¨åˆ—è¡¨ã€å†å²è®°å½•               | æ”¯æŒåŠ¨æ€æ‰©å±•           |
| æ’å…¥/åˆ é™¤å¯†é›†          | æ˜ å°„ `mapping` + æ ‡è®°åˆ é™¤        | ç™½åå•ã€é»‘åå•                   | é¿å…æ•°ç»„é‡æ’å¼€é”€       |
| å­˜åœ¨æ€§æ£€æŸ¥             | `mapping(address => bool)`       | æƒé™æ§åˆ¶ã€å·²æŠ•ç¥¨éªŒè¯             | O(1) å­˜åœ¨æ€§åˆ¤æ–­        |
| æœ‰åºé›†åˆ               | æ˜ å°„ + æ’åºç®—æ³•ï¼ˆå¤–éƒ¨ç»´æŠ¤ï¼‰      | æŒ‰ä½™é¢æ’åã€æŒ‰æ—¶é—´æ’åº           | æ”¯æŒé«˜æ•ˆæ’åºä¸æŸ¥è¯¢     |
| ç¨€ç–æ•°æ®               | `mapping`                        | ä»£å¸æŒæœ‰è€…ï¼ˆä»…å­˜å‚¨éé›¶ä½™é¢ï¼‰     | ä»…å­˜å‚¨æœ‰æ•ˆæ•°æ®         |


### **ä¸‰ã€å…¸å‹åœºæ™¯ä¸å®ç°**
#### 1. **éšæœºè¯»å†™ï¼šç”¨æˆ·ä½™é¢ç®¡ç†**
```solidity
// é«˜æ•ˆæ–¹æ¡ˆï¼šmapping æä¾› O(1) è¯»å†™
mapping(address => uint256) public balances;

function transfer(address to, uint256 amount) external {
    require(balances[msg.sender] >= amount, "Insufficient balance");
    balances[msg.sender] -= amount;
    balances[to] += amount;
}
```

#### 2. **é¡ºåºéå†ï¼šæ‰¹é‡ä»»åŠ¡å¤„ç†**
```solidity
// é«˜æ•ˆæ–¹æ¡ˆï¼šå›ºå®šå¤§å°æ•°ç»„ + æ¸¸æ ‡
struct Task {
    uint256 id;
    bool completed;
}

Task[100] public tasks; // å›ºå®š100ä¸ªä»»åŠ¡
uint256 public taskCount;

function processTasks(uint256 start, uint256 count) external {
    uint256 end = start + count;
    for (uint256 i = start; i < end && i < taskCount; i++) {
        if (!tasks[i].completed) {
            // å¤„ç†ä»»åŠ¡é€»è¾‘
            tasks[i].completed = true;
        }
    }
}
```

#### 3. **æ’å…¥/åˆ é™¤å¯†é›†ï¼šåŠ¨æ€ç™½åå•**
```solidity
// é«˜æ•ˆæ–¹æ¡ˆï¼šmapping + é€»è¾‘åˆ é™¤
mapping(address => bool) public isWhitelisted;
mapping(address => bool) public isDeleted;
address[] public whitelist;

function addToWhitelist(address addr) external {
    if (!isWhitelisted[addr]) {
        isWhitelisted[addr] = true;
        whitelist.push(addr);
    }
}

function removeFromWhitelist(address addr) external {
    require(isWhitelisted[addr], "Not in whitelist");
    isWhitelisted[addr] = false;
    isDeleted[addr] = true;
    // æ— éœ€ç‰©ç†åˆ é™¤ï¼Œå‡å°‘Gasæ¶ˆè€—
}
```

#### 4. **å­˜åœ¨æ€§æ£€æŸ¥ï¼šæŠ•ç¥¨ç³»ç»Ÿ**
```solidity
// é«˜æ•ˆæ–¹æ¡ˆï¼šmapping æä¾› O(1) å­˜åœ¨æ€§æ£€æŸ¥
mapping(address => bool) public hasVoted;
uint256 public yesVotes;
uint256 public noVotes;

function vote(bool support) external {
    require(!hasVoted[msg.sender], "Already voted");
    hasVoted[msg.sender] = true;
    if (support) {
        yesVotes++;
    } else {
        noVotes++;
    }
}
```


### **å››ã€é«˜çº§ä¼˜åŒ–ç­–ç•¥**
#### 1. **æ··åˆæ•°æ®ç»“æ„**
- **åœºæ™¯**ï¼šåŒæ—¶éœ€è¦éšæœºè®¿é—®å’Œé¡ºåºéå†ã€‚
- **æ–¹æ¡ˆ**ï¼šç»„åˆ `mapping` å’Œæ•°ç»„ï¼Œç»´æŠ¤åŒå‘ç´¢å¼•ã€‚
  ```solidity
  struct User {
      uint256 balance;
      uint256 arrayIndex; // åœ¨æ•°ç»„ä¸­çš„ä½ç½®
  }
  
  mapping(address => User) public users;
  address[] public userList;
  
  function addUser(address user, uint256 balance) external {
      if (users[user].arrayIndex == 0) { // é¿å…é‡å¤æ·»åŠ 
          users[user] = User({
              balance: balance,
              arrayIndex: userList.length
          });
          userList.push(user);
      }
  }
  ```

#### 2. **æ‡’åˆ é™¤ï¼ˆLazy Deletionï¼‰**
- **åœºæ™¯**ï¼šé¢‘ç¹åˆ é™¤æ“ä½œå¯¼è‡´æ•°ç»„é‡æ’å¼€é”€å¤§ã€‚
- **æ–¹æ¡ˆ**ï¼šæ ‡è®°åˆ é™¤è€Œéç‰©ç†åˆ é™¤ï¼Œå®šæœŸæ¸…ç†ã€‚
  ```solidity
  mapping(uint256 => bool) public isItemDeleted;
  Item[] public items;
  
  function deleteItem(uint256 index) external {
      require(index < items.length, "Invalid index");
      isItemDeleted[index] = true;
  }
  
  function cleanup() external {
      // å®šæœŸæ¸…ç†å·²åˆ é™¤é¡¹ï¼Œå‡å°‘æ•°ç»„é•¿åº¦
      uint256 writeIndex = 0;
      for (uint256 i = 0; i < items.length; i++) {
          if (!isItemDeleted[i]) {
              if (i != writeIndex) {
                  items[writeIndex] = items[i];
                  items[writeIndex].index = writeIndex;
              }
              writeIndex++;
          }
      }
      items.length = writeIndex;
  }
  ```


### **äº”ã€æ³¨æ„äº‹é¡¹**
1. **Gas æˆæœ¬æƒè¡¡**ï¼š
   - æ•°ç»„éå†çš„ Gas éšé•¿åº¦çº¿æ€§å¢é•¿ï¼Œéœ€é™åˆ¶å•æ¬¡å¤„ç†é‡ã€‚
   - æ˜ å°„çš„å­˜å‚¨æˆæœ¬é«˜äºæ•°ç»„ï¼Œä½†æŸ¥è¯¢æ•ˆç‡æ˜¾è‘—æ›´é«˜ã€‚

2. **å­˜å‚¨å¸ƒå±€**ï¼š
   - é¢‘ç¹è®¿é—®çš„å˜é‡åº”é¿å…ä¸å…¶ä»–å˜é‡æ‰“åŒ…ï¼ˆå¦‚ `bool` ä¸ `uint256`ï¼‰ã€‚
   - ä½¿ç”¨ `pragma experimental ABIEncoderV2` ä¼˜åŒ–ç»“æ„ä½“è¿”å›ã€‚

3. **å¤–éƒ¨ä¾èµ–**ï¼š
   - è‹¥éœ€å¤æ‚æ•°æ®ç»“æ„ï¼ˆå¦‚æ’åºæ ‘ï¼‰ï¼Œå¯è€ƒè™‘å¼•å…¥æˆç†Ÿåº“ï¼ˆå¦‚ OpenZeppelinï¼‰ã€‚


### **å…­ã€æ€»ç»“ï¼šé€‰å‹å†³ç­–æ ‘**
1. **ä¸»è¦è®¿é—®æ–¹å¼æ˜¯ä»€ä¹ˆï¼Ÿ**  
   - éšæœºè¯»å†™ â†’ `mapping`  
   - é¡ºåºéå† â†’ æ•°ç»„ï¼ˆå›ºå®šæˆ–åŠ¨æ€ï¼‰  
   - å­˜åœ¨æ€§æ£€æŸ¥ â†’ `mapping(address => bool)`  

2. **æ•°æ®è§„æ¨¡æ˜¯å¦åŠ¨æ€å˜åŒ–ï¼Ÿ**  
   - æ˜¯ â†’ åŠ¨æ€æ•°ç»„æˆ–æ˜ å°„ + è®¡æ•°å™¨  
   - å¦ â†’ å›ºå®šå¤§å°æ•°ç»„  

3. **æ˜¯å¦éœ€é«˜æ•ˆåˆ é™¤ï¼Ÿ**  
   - æ˜¯ â†’ æ˜ å°„ + æ‡’åˆ é™¤æ ‡è®°  
   - å¦ â†’ ç›´æ¥ä½¿ç”¨æ•°ç»„æˆ–æ˜ å°„  

4. **æ˜¯å¦éœ€æ’åºï¼Ÿ**  
   - æ˜¯ â†’ æ˜ å°„ + å¤–éƒ¨æ’åºï¼ˆå¦‚é“¾ä¸‹ç»´æŠ¤æ’åºç´¢å¼•ï¼‰  
   - å¦ â†’ åŸºç¡€æ•°æ®ç»“æ„  

é€šè¿‡åŒ¹é…æ•°æ®è®¿é—®æ¨¡å¼ä¸æ•°æ®ç»“æ„ç‰¹æ€§ï¼Œå¯æ˜¾è‘—æå‡åˆçº¦æ€§èƒ½ï¼Œé™ä½ Gas æˆæœ¬ï¼Œé¿å…å¸¸è§çš„æ•ˆç‡ç“¶é¢ˆã€‚

- ç­”æ¡ˆï¼š æ ¹æ®åˆçº¦çš„æ•°æ®è®¿é—®é¢‘ç‡å’Œç±»å‹é€‰æ‹©æ•°æ®ç»“æ„ã€‚é¢‘ç¹å˜åŠ¨çš„æ•°æ®å¯èƒ½æ›´é€‚åˆä½¿ç”¨ `mapping`ï¼Œè€Œé™æ€æ•°æ®æˆ–é¡ºåºè®¿é—®çš„æ•°æ®é€‚åˆä½¿ç”¨æ•°ç»„ã€‚

### åœ¨å¤æ‚åˆçº¦ä¸­é€‰æ‹©æ•°æ®ç»“æ„çš„è€ƒè™‘å› ç´ æœ‰å“ªäº›ï¼Ÿ

åœ¨å¤æ‚åˆçº¦ä¸­é€‰æ‹©æ•°æ®ç»“æ„éœ€è¿›è¡Œ**å¤šç»´æ·±åº¦è¯„ä¼°**ï¼Œä»¥ä¸‹æ˜¯å…³é”®è€ƒé‡å› ç´ ä¸è½åœ°å®è·µæ–¹æ¡ˆï¼š

---

### **ä¸€ã€æ ¸å¿ƒå†³ç­–æ¡†æ¶**
| **ç»´åº¦**          | **å…³é”®é—®é¢˜**                            | **è§£å†³æ–¹æ¡ˆ**                                  | **åˆçº¦ç¤ºä¾‹**                          |
|--------------------|----------------------------------------|---------------------------------------------|--------------------------------------|
| **åŠŸèƒ½éœ€æ±‚**       | æ˜¯å¦éœ€è¦å¿«é€Ÿæ£€ç´¢/èŒƒå›´æŸ¥è¯¢/æ¡ä»¶è¿‡æ»¤ï¼Ÿ    | â–¶ å•ç‚¹æ£€ç´¢: `mapping`<br>â–¶ èŒƒå›´éå†: åˆ†é¡µæ•°ç»„<br>â–¶ æ¡ä»¶è¿‡æ»¤: `EnumerableSet` | Uniswap ä»·æ ¼åˆ»åº¦ä½¿ç”¨ `mapping + æ•°ç»„` |
| **äº¤äº’é¢‘ç‡**       | è¯»å†™æ¯”ä¾‹å¦‚ä½•ï¼Ÿ                          | â–¶ é«˜é¢‘å†™: å†…å­˜ç¼“å­˜+æ‰¹é‡æ›´æ–°<br>â–¶ é«˜é¢‘è¯»: é¢„è®¡ç®—å­˜å‚¨ | Compound åˆ©ç‡è®¡ç®—é¢„å­˜ç´¢å¼•             |
| **æ•°æ®è§„æ¨¡**       | é¢„è®¡å­˜å‚¨æ¡ç›®æ•°é‡çº§ï¼Ÿ                    | â–¶ <100: åŠ¨æ€æ•°ç»„<br>â–¶ >1000: é“¾ä¸‹å­˜å‚¨+é“¾ä¸ŠCID     | BAYC NFT å…ƒæ•°æ®å­˜ IPFS               |
| **å…³ç³»å¤æ‚åº¦**     | æ˜¯å¦å­˜åœ¨å±‚çº§/åµŒå¥—å…³ç³»ï¼Ÿ                 | â–¶ æ ‘å½¢ç»“æ„: åµŒå¥—æ˜ å°„<br>â–¶ å›¾ç»“æ„: è¾¹åˆ—è¡¨+é‚»æ¥æ˜ å°„   | Aave æŠµæŠ¼å“å±‚çº§æ˜ å°„                  |

---

### **äºŒã€æ•°æ®ç»“æ„ç»„åˆç­–ç•¥**
#### 1. **Struct + Mapping é»„é‡‘ç»„åˆ**
```solidity
contract UserManager {
    // ç»“æ„ä½“å°è£…å¤æ‚æ•°æ®
    struct UserProfile {
        uint256 id;
        uint64 joinTime;
        address referral;
        bytes32 encryptedData;
    }
    
    // åœ°å€åˆ°ç”¨æˆ·æ•°æ®çš„æ˜ å°„ï¼ˆO(1)è®¿é—®ï¼‰
    mapping(address => UserProfile) private _users;
    
    // æ”¯æŒIDåå‘æŸ¥æ‰¾
    mapping(uint256 => address) private _idToAddress;
}
```
**ä¼˜åŠ¿**ï¼š  
- å•ç‚¹æ£€ç´¢æ—¶é—´å¤æ‚åº¦ O(1)  
- ç»“æ„ä½“æ”¯æŒ 32 å­—èŠ‚æ‰“åŒ…ä¼˜åŒ–  
- åŒå‘ç´¢å¼•æ”¯æŒçµæ´»æŸ¥è¯¢

#### 2. **æ•°ç»„ + Mapping åˆ†é¡µæ–¹æ¡ˆ**
```solidity
contract VotingSystem {
    address[] public allVoters;      // æ”¯æŒéå†
    mapping(address => bool) hasVoted; // å¿«é€ŸçŠ¶æ€æ ¡éªŒ
    
    function getVoters(uint start, uint limit) public view returns (address[] memory) {
        address[] memory result = new address[](limit);
        for(uint i=0; i<limit; i++) {
            if(start+i >= allVoters.length) break;
            result[i] = allVoters[start+i];
        }
        return result;
    }
}
```

---

### **ä¸‰ã€Gas ä¼˜åŒ–å®æˆ˜æŠ€å·§**
#### 1. **å­˜å‚¨æ§½æ‰“åŒ…æŠ€æœ¯**
```solidity
struct OptimizedData {
    uint64 timestamp;   // 8å­—èŠ‚
    uint128 amount;     // 16å­—èŠ‚
    address wallet;     // 20å­—èŠ‚
} // æ€»è®¡ 44å­—èŠ‚ â†’ å ç”¨å•ä¸ªå­˜å‚¨æ§½ï¼ˆ32å­—èŠ‚å¯¹é½æµªè´¹ç©ºé—´ï¼‰

// ä¼˜åŒ–å (å®Œç¾æ‰“åŒ…)
struct PackedData {
    address wallet;     // 20å­—èŠ‚
    uint96 amount;      // 12å­—èŠ‚ (æ”¯æŒ 79e28 é‡‘é¢)
    uint64 timestamp;   // 8å­—èŠ‚ 
} // æ€»è®¡ 40å­—èŠ‚ â†’ ä»åœ¨å•å­˜å‚¨æ§½å†…
```
**æ•ˆæœ**ï¼šå•æ¬¡å­˜å‚¨èŠ‚çº¦ **20,000+ Gas**

#### 2. **æ‰¹é‡å†™æ“ä½œæ¨¡å¼**
```solidity
function batchUpdate(UserUpdate[] calldata updates) external {
    uint totalGasBefore = gasleft();
    
    for(uint i=0; i<updates.length; i++) {
        // 1. å†…å­˜ä¸­å¤„ç†æ•°æ®
        User memory user = _processInMemory(updates[i]);
        
        // 2. å•æ¬¡å†™å…¥å­˜å‚¨
        _storage[updates[i].id] = user; 
    }
    
    emit GasUsed(totalGasBefore - gasleft());
}
```

---

### **å››ã€å®‰å…¨ä¸ç»´æŠ¤æ€§è®¾è®¡**
#### 1. **é˜²æº¢å‡ºæœºåˆ¶**
```solidity
using SafeMath for uint256;

mapping(address => uint256) public balances;

function deposit(uint256 amount) public {
    require(balances[msg.sender] <= type(uint256).max - amount, "Overflow!"); 
    balances[msg.sender] += amount;
}
```

#### 2. **å¯å‡çº§æ¶æ„**
```solidity
contract UpgradeableStorage {
    // å­˜å‚¨æ§½ä¸é€»è¾‘åˆ†ç¦»
    bytes32 private constant STORAGE_SLOT = keccak256("STORAGE");
    
    struct StorageLayout {
        mapping(address => uint) balances;
        address[] userList;
    }
    
    function _storage() internal pure returns (StorageLayout storage s) {
        assembly { s.slot := STORAGE_SLOT }
    }
}
```

---

### **äº”ã€é“¾ä¸Šé“¾ä¸‹å­˜å‚¨å†³ç­–æ ‘**
```mermaid
graph TD
    A[æ–°æ•°æ®ç»“æ„éœ€æ±‚] --> B{æ˜¯å¦å½±å“æ ¸å¿ƒä¸šåŠ¡ï¼Ÿ}
    B -->|æ˜¯| C[é“¾ä¸Šå­˜å‚¨]
    B -->|å¦| D{æ•°æ®è§„æ¨¡>1000ï¼Ÿ}
    D -->|æ˜¯| E[é“¾ä¸‹å­˜å‚¨ CID + é“¾ä¸Šå­˜å“ˆå¸Œ]
    D -->|å¦| F{éœ€è¦å®æ—¶è®¿é—®ï¼Ÿ}
    F -->|æ˜¯| G[é“¾ä¸Šæ•°ç»„/mapping]
    F -->|å¦| H[äº‹ä»¶æ—¥å¿—+é“¾ä¸‹ç›‘å¬]
    
    C --> I{æ˜¯å¦éœ€è¦å¿«é€Ÿæ£€ç´¢ï¼Ÿ}
    I -->|æ˜¯| J[ä½¿ç”¨ mapping]
    I -->|å¦| K[åŠ¨æ€æ•°ç»„]
    
    J --> L[æ˜¯å¦éœ€èŒƒå›´æŸ¥è¯¢ï¼Ÿ]
    L -->|æ˜¯| M[å¢åŠ IDç´¢å¼•æ•°ç»„]
    L -->|å¦| N[ç›´æ¥å­˜å‚¨]
```

---

### **å…­ã€è¡Œä¸šæœ€ä½³å®è·µå‚è€ƒ**
1. **Uniswap V3 Tick ç®¡ç†**  
   - ä½¿ç”¨ `mapping(int24 => Tick.Info)` + å‹ç¼©å­˜å‚¨ç»“æ„  
   - å•æ§½å­˜å‚¨æµåŠ¨æ€§å‡€å€¼ã€å¢é•¿ç‡ç­‰ 10+ å‚æ•°

2. **Compound å€Ÿè´·åè®®**  
   ```solidity
   struct Account {
       uint totalCollateral;
       mapping(address => uint) collateralTokens; // åµŒå¥—æ˜ å°„
   }
   mapping(address => Account) public accounts;
   ```

3. **Chainlink é¢„è¨€æœº**  
   - é“¾ä¸Šï¼š`mapping(bytes32 => PriceFeed)` å­˜æœ€æ–°ä»·æ ¼  
   - é“¾ä¸‹ï¼šå†å²æ•°æ®å­˜ Decentralized Data Lake

---

**å…³é”®ç»“è®º**ï¼š  
1. æ ¸å¿ƒä¸šåŠ¡æ•°æ®å¿…ç”¨é“¾ä¸Šå­˜å‚¨ + **ç»“æ„ä½“æ‰“åŒ…ä¼˜åŒ–**  
2. è¶…è¿‡ 1000 æ¡è®°å½•æ—¶é‡‡ç”¨ **IPFS/Arweave é“¾ä¸‹å­˜å‚¨**  
3. é«˜é¢‘å†™æ“ä½œå®æ–½ **å†…å­˜è®¡ç®—+æ‰¹é‡æ›´æ–°** ç­–ç•¥  
4. å¤æ‚å…³ç³»ç”¨ **åµŒå¥—æ˜ å°„æ›¿ä»£å¤šç»´æ•°ç»„**  
5. å§‹ç»ˆè®¾ç½® **æ•°æ®è§„æ¨¡ä¸Šé™** é˜² DOS æ”»å‡»  

é€šè¿‡ç²¾å‡†çš„æ•°æ®ç»“æ„è®¾è®¡ï¼Œå¯é™ä½ 40%+ çš„ Gas æˆæœ¬ï¼ŒåŒæ—¶æå‡åˆçº¦å®‰å…¨æ€§ä¸å¯ç»´æŠ¤æ€§ã€‚

- ç­”æ¡ˆï¼š éœ€è¦è¯„ä¼°åˆçº¦çš„åŠŸèƒ½éœ€æ±‚ï¼Œé€‰æ‹©å¯ä»¥æ”¯æŒè¿™äº›åŠŸèƒ½çš„æ•°æ®ç»“æ„ã€‚å¤æ‚åˆçº¦å¯èƒ½éœ€è¦ç»“åˆä½¿ç”¨å¤šç§æ•°æ®ç»“æ„ï¼Œå¦‚ç»“åˆä½¿ç”¨ `struct` å’Œ `mapping`ã€‚

### å¦‚ä½•å†³å®šä½¿ç”¨å›ºå®šé•¿åº¦çš„æ•°ç»„è¿˜æ˜¯åŠ¨æ€æ•°ç»„ï¼Ÿ

åœ¨Solidityä¸­é€‰æ‹©å›ºå®šé•¿åº¦æ•°ç»„è¿˜æ˜¯åŠ¨æ€æ•°ç»„ï¼Œéœ€åŸºäºæ•°æ®è§„æ¨¡ã€æ“ä½œé¢‘ç‡å’ŒGasæˆæœ¬ç»¼åˆè€ƒé‡ã€‚ä»¥ä¸‹æ˜¯ç³»ç»Ÿæ€§çš„å†³ç­–æŒ‡å—ï¼š  


### **ä¸€ã€æ ¸å¿ƒåŒºåˆ«ä¸åº•å±‚å®ç°**
| ç±»å‹               | å£°æ˜æ–¹å¼              | å­˜å‚¨ç‰¹æ€§                     | æ‰©å®¹èƒ½åŠ›       | Gas æˆæœ¬ï¼ˆå•æ¬¡æ“ä½œï¼‰ |
|--------------------|-----------------------|------------------------------|----------------|---------------------|
| **å›ºå®šé•¿åº¦æ•°ç»„**   | `T[size]`             | å ç”¨å›ºå®šå­˜å‚¨æ§½               | ä¸å¯æ‰©å®¹       | ä½ï¼ˆæ— æ‰©å®¹å¼€é”€ï¼‰    |
| **åŠ¨æ€æ•°ç»„**       | `T[]` æˆ– `T[dynamic]` | å­˜å‚¨æŒ‡å‘æ•°æ®çš„æŒ‡é’ˆ + åŠ¨æ€æ•°æ® | æ”¯æŒ `push()`  | é«˜ï¼ˆå¯èƒ½è§¦å‘å­˜å‚¨é‡åˆ†é…ï¼‰ |


### **äºŒã€é€‰æ‹©å›ºå®šé•¿åº¦æ•°ç»„çš„åœºæ™¯**
#### 1. **å·²çŸ¥ä¸”ä¸å˜çš„å…ƒç´ æ•°é‡**
- **åœºæ™¯**ï¼šå¤šé‡ç­¾ååˆçº¦çš„ç­¾åè€…åˆ—è¡¨ã€æ£‹ç›˜æ¸¸æˆçš„æ ¼å­å¸ƒå±€ã€‚  
- **ç¤ºä¾‹**ï¼š  
  ```solidity
  contract MultiSig {
      address[3] public owners; // 3ä¸ªå›ºå®šç­¾åè€…ï¼Œä¸å¯å˜æ›´
      
      constructor(address a, address b, address c) {
          owners = [a, b, c];
      }
  }
  ```
- **ä¼˜åŠ¿**ï¼šå­˜å‚¨å¸ƒå±€å›ºå®šï¼ŒèŠ‚çœGasï¼ˆæ— éœ€åŠ¨æ€ç®¡ç†é•¿åº¦ï¼‰ã€‚

#### 2. **ä¼˜åŒ–å­˜å‚¨ä¸è®¡ç®—**
- **åœºæ™¯**ï¼šæ‰¹é‡å¤„ç†å›ºå®šæ•°é‡çš„æ•°æ®ï¼ˆå¦‚åŠ å¯†ç®—æ³•ä¸­çš„åŒºå—ï¼‰ã€‚  
- **ç¤ºä¾‹**ï¼š  
  ```solidity
  function encrypt(bytes32[16] memory data) internal pure returns (bytes32[16] memory) {
      // å›ºå®š16ä¸ª32å­—èŠ‚å—çš„åŠ å¯†è®¡ç®—
      bytes32[16] memory result;
      for (uint256 i = 0; i < 16; i++) {
          result[i] = keccak256(abi.encodePacked(data[i], nonce));
      }
      return result;
  }
  ```
- **ä¼˜åŠ¿**ï¼šè¿ç»­å†…å­˜è®¿é—®æ›´é«˜æ•ˆï¼Œé¿å…åŠ¨æ€æ‰©å®¹çš„è®¡ç®—å¼€é”€ã€‚

#### 3. **é˜²æ­¢è¶Šç•Œé£é™©**
- **åœºæ™¯**ï¼šéœ€è¦ä¸¥æ ¼é™åˆ¶å…ƒç´ æ•°é‡çš„å®‰å…¨æ•æ„Ÿåœºæ™¯ï¼ˆå¦‚æŠ•ç¥¨æƒé‡åˆ†é…ï¼‰ã€‚  
- **ç¤ºä¾‹**ï¼š  
  ```solidity
  struct VoteWeights {
      uint8[10] weights; // 10ä¸ªå›ºå®šæƒé‡å€¼ï¼ŒèŒƒå›´0-255
  }
  ```
- **ä¼˜åŠ¿**ï¼šç¼–è¯‘æ—¶æ£€æŸ¥ç´¢å¼•èŒƒå›´ï¼Œé¿å…è¿è¡Œæ—¶è¶Šç•Œï¼ˆåŠ¨æ€æ•°ç»„éœ€æ‰‹åŠ¨æ ¡éªŒï¼‰ã€‚


### **ä¸‰ã€é€‰æ‹©åŠ¨æ€æ•°ç»„çš„åœºæ™¯**
#### 1. **å…ƒç´ æ•°é‡ä¸ç¡®å®šæˆ–å˜åŒ–**
- **åœºæ™¯**ï¼šç”¨æˆ·ç™½åå•ã€äº¤æ˜“å†å²è®°å½•ã€DAOæŠ•ç¥¨è€…åˆ—è¡¨ã€‚  
- **ç¤ºä¾‹**ï¼š  
  ```solidity
  contract Whitelist {
      address[] public allowedAddresses;
      
      function addToWhitelist(address addr) external {
          allowedAddresses.push(addr); // åŠ¨æ€æ·»åŠ 
      }
  }
  ```
- **ä¼˜åŠ¿**ï¼šçµæ´»é€‚åº”æ•°æ®è§„æ¨¡å˜åŒ–ï¼Œæ— éœ€é¢„å…ˆçŸ¥é“æœ€å¤§é•¿åº¦ã€‚

#### 2. **é¢‘ç¹è¿½åŠ æ“ä½œ**
- **åœºæ™¯**ï¼šæ—¥å¿—è®°å½•ã€äº‹ä»¶è¿½è¸ªï¼ˆä»…è¿½åŠ ä¸åˆ é™¤ï¼‰ã€‚  
- **ç¤ºä¾‹**ï¼š  
  ```solidity
  event Transfer(address from, address to, uint256 amount);
  bytes32[] public transferHashes;
  
  function logTransfer(bytes32 txHash) internal {
      transferHashes.push(txHash); // é«˜æ•ˆå°¾æ’
  }
  ```
- **ä¼˜åŠ¿**ï¼š`push()` æ“ä½œåœ¨åŠ¨æ€æ•°ç»„å°¾éƒ¨è¿½åŠ ï¼ŒGasæˆæœ¬ç›¸å¯¹å›ºå®šï¼ˆä»…å½“è§¦å‘æ‰©å®¹æ—¶æˆæœ¬å¢åŠ ï¼‰ã€‚

#### 3. **ä¸æ˜ å°„ç»„åˆä½¿ç”¨**
- **åœºæ™¯**ï¼šéœ€è¦åŒæ—¶æ”¯æŒéšæœºè®¿é—®å’Œé¡ºåºéå†ï¼ˆå¦‚ç”¨æˆ·æŒæœ‰çš„Tokenåˆ—è¡¨ï¼‰ã€‚  
- **ç¤ºä¾‹**ï¼š  
  ```solidity
  mapping(address => uint256[]) public userTokens; // åœ°å€â†’æŒæœ‰çš„TokenIDåˆ—è¡¨
  ```
- **ä¼˜åŠ¿**ï¼šæ˜ å°„æä¾›O(1)éšæœºè®¿é—®ï¼ŒåŠ¨æ€æ•°ç»„æ”¯æŒé¡ºåºéå†ï¼Œå¹³è¡¡æ€§èƒ½ä¸åŠŸèƒ½ã€‚


### **å››ã€Gasæˆæœ¬å¯¹æ¯”ä¸ä¼˜åŒ–**
#### 1. **å­˜å‚¨æˆæœ¬**
- **å›ºå®šæ•°ç»„**ï¼šæ¯ä¸ªå…ƒç´ æŒ‰ç±»å‹å ç”¨å­˜å‚¨ï¼ˆå¦‚ `uint256[10]` å ç”¨10ä¸ªå­˜å‚¨æ§½ï¼‰ã€‚  
- **åŠ¨æ€æ•°ç»„**ï¼š  
  - å­˜å‚¨æŒ‡é’ˆï¼ˆ32å­—èŠ‚ï¼‰ + æ•°æ®ï¼ˆåŠ¨æ€åˆ†é…ï¼‰ã€‚  
  - æ‰©å®¹æ—¶éœ€é‡æ–°åˆ†é…å­˜å‚¨ï¼Œå¤åˆ¶æ—§æ•°æ®ï¼Œæˆæœ¬è¾ƒé«˜ï¼ˆ20000 Gas/å­˜å‚¨å†™å…¥ï¼‰ã€‚

#### 2. **æ“ä½œæˆæœ¬**
- **å›ºå®šæ•°ç»„**ï¼š  
  - è¯»å†™ï¼šO(1)ï¼ŒGasæˆæœ¬ä½ï¼ˆä»…è®¿é—®å›ºå®šå­˜å‚¨æ§½ï¼‰ã€‚  
  - åˆ é™¤ï¼šéœ€æ‰‹åŠ¨æ ‡è®°ï¼Œæ— æ³•ç›´æ¥åˆ é™¤ï¼ˆåˆ é™¤å…ƒç´ éœ€ç§»åŠ¨åç»­å…ƒç´ ï¼Œæˆæœ¬é«˜ï¼‰ã€‚  
- **åŠ¨æ€æ•°ç»„**ï¼š  
  - `push()`ï¼šå°¾æ’æˆæœ¬ä½ï¼ˆ~5000 Gasï¼‰ï¼Œæ‰©å®¹æ—¶æˆæœ¬æ¿€å¢ï¼ˆå¦‚ä»100â†’101éœ€é‡æ–°åˆ†é…å­˜å‚¨ï¼‰ã€‚  
  - `pop()`ï¼šåˆ é™¤æœ€åä¸€ä¸ªå…ƒç´ æˆæœ¬ä½ï¼ˆ~5000 Gasï¼‰ï¼Œåˆ é™¤ä¸­é—´å…ƒç´ éœ€é‡æ’æ•°ç»„ï¼Œæˆæœ¬é«˜ã€‚

#### 3. **ä¼˜åŒ–ç­–ç•¥**
- **å›ºå®šæ•°ç»„**ï¼š  
  - æŒ‰å®é™…éœ€æ±‚é€‰æ‹©æœ€å°é•¿åº¦ï¼ˆå¦‚ `uint8[5]` ä»£æ›¿ `uint256[5]`ï¼‰ã€‚  
- **åŠ¨æ€æ•°ç»„**ï¼š  
  - æ‰¹é‡æ“ä½œä»£æ›¿å•æ¬¡æ“ä½œï¼ˆå¦‚ä¸€æ¬¡æ·»åŠ 100ä¸ªå…ƒç´ ï¼Œå‡å°‘æ‰©å®¹æ¬¡æ•°ï¼‰ï¼š  
    ```solidity
    function batchAdd(address[] calldata addrs) external {
        for (uint256 i = 0; i < addrs.length; i++) {
            allowedAddresses.push(addrs[i]);
        }
    }
    ```
  - æ‡’åˆ é™¤ï¼ˆæ ‡è®°æ— æ•ˆè€Œéç‰©ç†åˆ é™¤ï¼‰ï¼š  
    ```solidity
    mapping(uint256 => bool) public isDeleted;
    address[] public allUsers;
    
    function deleteUser(uint256 index) external {
        require(index < allUsers.length, "Invalid index");
        isDeleted[index] = true;
    }
    ```


### **äº”ã€å®‰å…¨æ€§ä¸åŠŸèƒ½æƒè¡¡**
#### 1. **è¶Šç•Œé£é™©**
- **å›ºå®šæ•°ç»„**ï¼šç¼–è¯‘æ—¶æ£€æŸ¥ç´¢å¼•èŒƒå›´ï¼ˆå¦‚ `arr[10]` å¯¹ `uint256[5]` ä¼šæŠ¥é”™ï¼‰ã€‚  
- **åŠ¨æ€æ•°ç»„**ï¼šéœ€æ‰‹åŠ¨æ ¡éªŒ `index < array.length`ï¼Œå¦åˆ™å¯èƒ½è¯»å–/ä¿®æ”¹ä»»æ„å­˜å‚¨ä½ç½®ã€‚  

#### 2. **æ•°æ®å®Œæ•´æ€§**
- **å›ºå®šæ•°ç»„**ï¼šæ•°æ®è§„æ¨¡å›ºå®šï¼Œé€‚åˆå­˜å‚¨ä¸å¯å˜çš„å…³é”®æ•°æ®ï¼ˆå¦‚åè®®å‚æ•°ï¼‰ã€‚  
- **åŠ¨æ€æ•°ç»„**ï¼šé€‚åˆå­˜å‚¨å¯æ‰©å±•çš„éå…³é”®æ•°æ®ï¼ˆå¦‚æ—¥å¿—ï¼‰ï¼Œéœ€é¢å¤–æªæ–½ä¿è¯æ•°æ®å®Œæ•´æ€§ï¼ˆå¦‚Merkleè¯æ˜ï¼‰ã€‚  


### **å…­ã€å†³ç­–æµç¨‹å›¾**
```mermaid
graph TD
    A[é€‰æ‹©æ•°ç»„ç±»å‹] --> B{å…ƒç´ æ•°é‡æ˜¯å¦ç¡®å®š?}
    B -->|æ˜¯| C[å›ºå®šé•¿åº¦æ•°ç»„]
    B -->|å¦| D[åŠ¨æ€æ•°ç»„]
    
    C --> E{æ˜¯å¦éœ€è¦ä¿®æ”¹å…ƒç´ ?}
    E -->|å¦| F[çº¯å­˜å‚¨å›ºå®šæ•°æ®]
    E -->|æ˜¯| G[å…è®¸ä¿®æ”¹å›ºå®šä½ç½®å…ƒç´ ]
    
    D --> H{æ˜¯å¦é¢‘ç¹åˆ é™¤?}
    H -->|æ˜¯| I[åŠ¨æ€æ•°ç»„+æ ‡è®°åˆ é™¤]
    H -->|å¦| J[ç›´æ¥ä½¿ç”¨åŠ¨æ€æ•°ç»„]
    
    J --> K{æ˜¯å¦éœ€é«˜æ•ˆéå†?}
    K -->|æ˜¯| L[ç¡®ä¿æ•°ç»„é•¿åº¦å¯æ§]
    K -->|å¦| M[ç»“åˆæ˜ å°„ä¼˜åŒ–æŸ¥è¯¢]
```


### **ä¸ƒã€å…¸å‹åœºæ™¯å¯¹ç…§è¡¨**
| åœºæ™¯                  | æ¨èç±»å‹       | åŸå›                           |
|-----------------------|----------------|-------------------------------|
| å¤šé‡ç­¾åè€…åˆ—è¡¨        | å›ºå®šæ•°ç»„       | æ•°é‡å›ºå®šï¼Œä¸å¯å˜æ›´            |
| ä»£å¸æŒæœ‰è€…åˆ—è¡¨        | åŠ¨æ€æ•°ç»„       | æ•°é‡åŠ¨æ€å˜åŒ–ï¼Œéœ€é¢‘ç¹æ·»åŠ        |
| åŠ å¯†ç®—æ³•æ•°æ®å—        | å›ºå®šæ•°ç»„       | å›ºå®šæ•°é‡ï¼Œéœ€é«˜æ•ˆè¿ç»­è®¿é—®       |
| äº¤æ˜“å†å²è®°å½•          | åŠ¨æ€æ•°ç»„       | ä»…è¿½åŠ ï¼Œæ— éœ€åˆ é™¤               |
| æ£‹ç›˜æ¸¸æˆæ ¼å­          | å›ºå®šæ•°ç»„       | å°ºå¯¸å›ºå®šï¼Œéœ€ç¼–è¯‘æ—¶è¾¹ç•Œæ£€æŸ¥     |
| å¯æ‰©å±•çš„é…ç½®é¡¹        | åŠ¨æ€æ•°ç»„       | å¯èƒ½æ–°å¢é…ç½®ï¼Œéœ€çµæ´»æ‰©å®¹       |


### **å…«ã€æ€»ç»“ï¼šæ ¸å¿ƒå†³ç­–ç‚¹**
1. **æ•°é‡ç¡®å®šæ€§**ï¼šè‹¥å…ƒç´ æ•°é‡åœ¨ç¼–è¯‘æ—¶å·²çŸ¥ä¸”ä¸å˜ï¼Œé€‰å›ºå®šæ•°ç»„ï¼ˆå¦‚ `uint256[100]`ï¼‰ã€‚  
2. **åŠ¨æ€æ‰©å±•æ€§**ï¼šè‹¥æ•°é‡å¯èƒ½å˜åŒ–ï¼ˆå¦‚ç”¨æˆ·æ·»åŠ /åˆ é™¤ï¼‰ï¼Œé€‰åŠ¨æ€æ•°ç»„ï¼ˆå¦‚ `address[]`ï¼‰ã€‚  
3. **æ€§èƒ½ä¼˜å…ˆçº§**ï¼š  
   - é«˜é¢‘è¯»å†™ä¸”æ•°é‡å›ºå®š â†’ å›ºå®šæ•°ç»„ï¼ˆä½Gasï¼‰ã€‚  
   - é«˜é¢‘è¿½åŠ ä¸”æ•°é‡ä¸ç¡®å®š â†’ åŠ¨æ€æ•°ç»„ï¼ˆçµæ´»ï¼‰ã€‚  
4. **å®‰å…¨éœ€æ±‚**ï¼šéœ€ä¸¥æ ¼é™åˆ¶è¾¹ç•Œæ—¶ï¼Œå›ºå®šæ•°ç»„ï¼ˆç¼–è¯‘æ—¶æ£€æŸ¥ï¼‰ä¼˜äºåŠ¨æ€æ•°ç»„ï¼ˆéœ€æ‰‹åŠ¨æ ¡éªŒï¼‰ã€‚  

åˆç†é€‰æ‹©æ•°ç»„ç±»å‹å¯åœ¨åŠŸèƒ½å®ç°ã€Gasæˆæœ¬å’Œå®‰å…¨æ€§ä¹‹é—´å–å¾—å¹³è¡¡ï¼Œé¿å…å› æ•°æ®ç»“æ„é€‰å‹ä¸å½“å¯¼è‡´çš„æ€§èƒ½ç“¶é¢ˆæˆ–å®‰å…¨æ¼æ´ã€‚

- ç­”æ¡ˆï¼š å¦‚æœäº‹å…ˆçŸ¥é“æ•°ç»„çš„æœ€å¤§é•¿åº¦ï¼Œå¹¶ä¸”è¿™ä¸ªé•¿åº¦ä¸ä¼šå˜åŒ–ï¼Œä½¿ç”¨å›ºå®šé•¿åº¦æ•°ç»„å¯ä»¥èŠ‚çœ Gas æˆæœ¬ã€‚å¦‚æœæ•°ç»„é•¿åº¦ä¼šåŠ¨æ€å˜åŒ–ï¼Œåº”é€‰æ‹©åŠ¨æ€æ•°ç»„ã€‚

```
uint256[10] public fixedNumbers;
uint256[] public dynamicNumbers;
```

### åœ¨ Solidity ä¸­ä½¿ç”¨ `mapping` å’Œ `array` çš„ä¸»è¦åŒºåˆ«åŠä½¿ç”¨åœºæ™¯æ˜¯ä»€ä¹ˆï¼Ÿ

åœ¨ Solidity ä¸­ï¼Œ`mapping` å’Œ `array` æ˜¯ä¸¤ç§æ ¸å¿ƒæ•°æ®ç»“æ„ï¼Œå…¶è®¾è®¡ç›®æ ‡å’Œé€‚ç”¨åœºæ™¯å·®å¼‚æ˜¾è‘—ã€‚ä»¥ä¸‹æ˜¯ç³»ç»Ÿæ€§å¯¹æ¯”åŠé€‰å‹æŒ‡å—ï¼š


### **ä¸€ã€æ ¸å¿ƒåŒºåˆ«å¯¹æ¯”è¡¨**
| ç‰¹æ€§               | `mapping`                          | `array`                          |
|--------------------|------------------------------------|----------------------------------|
| **æ•°æ®ç»“æ„**       | å“ˆå¸Œè¡¨ï¼ˆé”®å€¼å¯¹æ˜ å°„ï¼‰               | æœ‰åºå…ƒç´ é›†åˆ                     |
| **å£°æ˜æ–¹å¼**       | `mapping(KeyType => ValueType)`    | `ElementType[]`ï¼ˆåŠ¨æ€ï¼‰æˆ– `ElementType[size]`ï¼ˆå›ºå®šï¼‰ |
| **è®¿é—®æ–¹å¼**       | é€šè¿‡é”®éšæœºè®¿é—®ï¼ˆO(1)ï¼‰             | é€šè¿‡ç´¢å¼•é¡ºåºæˆ–éšæœºè®¿é—®ï¼ˆO(1)ï¼‰   |
| **å­˜å‚¨ç‰¹æ€§**       | ç¨€ç–å­˜å‚¨ï¼ˆä»…å­˜å‚¨å®é™…èµ‹å€¼çš„é”®ï¼‰     | è¿ç»­å­˜å‚¨ï¼ˆæ‰€æœ‰å…ƒç´ æŒ‰é¡ºåºå­˜æ”¾ï¼‰   |
| **å…ƒç´ é¡ºåº**       | æ— åº                               | æœ‰åºï¼ˆæ’å…¥é¡ºåºæˆ–è‡ªå®šä¹‰æ’åºï¼‰     |
| **åŠ¨æ€æ‰©å±•**       | è‡ªåŠ¨æ”¯æŒï¼ˆæ— é™æ·»åŠ é”®å€¼å¯¹ï¼‰         | åŠ¨æ€æ•°ç»„éœ€æ‰‹åŠ¨æ‰©å®¹ï¼ˆ`push()`ï¼‰   |
| **åˆ é™¤æ“ä½œ**       | `delete map[key]`ï¼ˆè®¾ä¸ºé»˜è®¤å€¼ï¼‰    | `pop()`ï¼ˆåˆ é™¤æœ«å°¾å…ƒç´ ï¼‰æˆ–æ‰‹åŠ¨é‡æ’ï¼ˆé«˜Gasï¼‰ |
| **éå†æ”¯æŒ**       | ä¸ç›´æ¥æ”¯æŒï¼ˆéœ€é¢å¤–ç»´æŠ¤ç´¢å¼•æ•°ç»„ï¼‰   | æ”¯æŒ `for` å¾ªç¯ï¼ˆåŠ¨æ€/å›ºå®šå‡å¯ï¼‰ |
| **Gas ç‰¹æ€§**       | å•æ¬¡è¯»å†™ç¨³å®šï¼ˆçº¦ 5000 Gasï¼‰        | å°¾æ’ï¼ˆ~5000 Gasï¼‰ï¼Œä¸­é—´æ’å…¥/åˆ é™¤ï¼ˆé«˜Gasï¼Œéœ€é‡æ’ï¼‰ |


### **äºŒã€å…¸å‹ä½¿ç”¨åœºæ™¯**
#### 1. **mapping çš„æ ¸å¿ƒåœºæ™¯**
- **å¿«é€Ÿé”®å€¼æŸ¥æ‰¾**ï¼ˆå¦‚ç”¨æˆ·ä½™é¢ã€æƒé™éªŒè¯ï¼‰ï¼š
  ```solidity
  mapping(address => uint256) public balances; // ä»£å¸ä½™é¢
  mapping(address => bool) public isAdmin;    // æƒé™æ§åˆ¶
  ```
- **å­˜åœ¨æ€§æ£€æŸ¥**ï¼ˆå¦‚ç™½åå•ã€å·²æŠ•ç¥¨éªŒè¯ï¼‰ï¼š
  ```solidity
  mapping(address => bool) public whitelisted;
  
  function join() external {
      require(whitelisted[msg.sender], "Not whitelisted");
      // ...
  }
  ```
- **å¤æ‚æ•°æ®ç´¢å¼•**ï¼ˆå¦‚åµŒå¥—æ˜ å°„å­˜å‚¨å¤šç»´åº¦æ•°æ®ï¼‰ï¼š
  ```solidity
  mapping(address => mapping(uint256 => bool)) public userVotes; // ç”¨æˆ·å¯¹ææ¡ˆçš„æŠ•ç¥¨
  ```

#### 2. **array çš„æ ¸å¿ƒåœºæ™¯**
- **æœ‰åºé›†åˆ**ï¼ˆå¦‚äº¤æ˜“å†å²ã€æ’è¡Œæ¦œï¼‰ï¼š
  ```solidity
  struct Transaction {
      address from;
      uint256 amount;
      uint256 timestamp;
  }
  Transaction[] public txHistory; // äº¤æ˜“å†å²è®°å½•
  ```
- **å›ºå®šå¤§å°æ•°æ®**ï¼ˆå¦‚å¤šé‡ç­¾åè€…åˆ—è¡¨ã€æ£‹ç›˜æ¸¸æˆå¸ƒå±€ï¼‰ï¼š
  ```solidity
  address[3] public owners; // 3ä¸ªå›ºå®šç­¾åè€…
  uint8[3][3] public board; // 3x3æ£‹ç›˜
  ```
- **éœ€éå†çš„åœºæ™¯**ï¼ˆå¦‚æ‰¹é‡ä»»åŠ¡å¤„ç†ï¼‰ï¼š
  ```solidity
  function processAllItems() external {
      for (uint256 i = 0; i < items.length; i++) {
          // å¤„ç†æ¯ä¸ªå…ƒç´ 
      }
  }
  ```


### **ä¸‰ã€æ€§èƒ½ä¸ Gas å¯¹æ¯”**
#### 1. **è¯»å†™æ“ä½œ**
- **mapping**ï¼š  
  - ä¼˜åŠ¿ï¼šæ— è®ºæ•°æ®è§„æ¨¡å¤šå¤§ï¼Œè¯»å†™å‡ä¸º O(1)ï¼ŒGas æˆæœ¬ç¨³å®šã€‚  
  - åŠ£åŠ¿ï¼šæ— æ³•ç›´æ¥éå†ï¼Œéœ€é¢å¤–ç»´æŠ¤ç´¢å¼•æ•°ç»„ï¼ˆè§ä¸‹æ–‡ä¼˜åŒ–ï¼‰ã€‚  
- **array**ï¼š  
  - ä¼˜åŠ¿ï¼šè¿ç»­å­˜å‚¨ï¼Œéå†é«˜æ•ˆï¼ˆå°¤å…¶å›ºå®šæ•°ç»„ï¼‰ã€‚  
  - åŠ£åŠ¿ï¼šåŠ¨æ€æ•°ç»„æ’å…¥/åˆ é™¤ä¸­é—´å…ƒç´ éœ€é‡æ’ï¼ŒGas æˆæœ¬é«˜ï¼ˆO(n)ï¼‰ã€‚

#### 2. **åˆ é™¤æ“ä½œ**
- **mapping**ï¼š  
  ```solidity
  delete balances[user]; // è®¾ä¸ºé»˜è®¤å€¼ï¼ˆ0ï¼‰ï¼ŒGas çº¦ 5000
  ```
- **array**ï¼š  
  ```solidity
  items.pop(); // åˆ é™¤æœ«å°¾å…ƒç´ ï¼ŒGas çº¦ 5000
  items[i] = items[items.length - 1]; // åˆ é™¤ä¸­é—´å…ƒç´ ï¼ˆéœ€è¦†ç›–ï¼‰
  items.pop(); // éœ€ä¸¤æ­¥ï¼ŒGas çº¦ 10000
  ```

#### 3. **éå†æˆæœ¬**
- **mapping**ï¼šéœ€ç»“åˆæ•°ç»„ç»´æŠ¤é”®åˆ—è¡¨ï¼Œéå† Gas éšå…ƒç´ æ•°é‡çº¿æ€§å¢é•¿ã€‚  
- **array**ï¼šç›´æ¥éå†ï¼ŒGas æˆæœ¬ä½ï¼Œä½†éœ€æ³¨æ„é¿å…é•¿æ•°ç»„å¯¼è‡´ OutOfGasï¼ˆå»ºè®®åˆ†é¡µå¤„ç†ï¼‰ã€‚


### **å››ã€ç»„åˆä½¿ç”¨æŠ€å·§**
#### 1. **å¯éå†çš„ mapping**
- **æ–¹æ¡ˆ**ï¼šç»´æŠ¤æ˜ å°„ + æ•°ç»„ï¼Œå®ç°éå†åŠŸèƒ½ï¼š
  ```solidity
  mapping(address => uint256) public balances;
  address[] public allAddresses;
  
  function addUser(address user, uint256 amount) external {
      if (balances[user] == 0) {
          allAddresses.push(user); // ä»…æ·»åŠ æ–°ç”¨æˆ·
      }
      balances[user] = amount;
  }
  
  function getUserCount() external view returns (uint256) {
      return allAddresses.length;
  }
  ```

#### 2. **é«˜æ•ˆåˆ é™¤çš„åŠ¨æ€æ•°ç»„**
- **æ–¹æ¡ˆ**ï¼šç”¨æ˜ å°„è®°å½•å…ƒç´ ç´¢å¼•ï¼Œåˆ é™¤æ—¶äº¤æ¢åˆ°æœ«å°¾å† `pop()`ï¼š
  ```solidity
  struct Item {
      uint256 value;
      uint256 index;
  }
  
  Item[] public items;
  mapping(uint256 => uint256) public idToIndex;
  
  function removeItem(uint256 id) external {
      uint256 index = idToIndex[id];
      uint256 lastIndex = items.length - 1;
      
      // äº¤æ¢åˆ°æœ«å°¾
      if (index != lastIndex) {
          items[index] = items[lastIndex];
          items[index].index = index;
          idToIndex[items[index].id] = index;
      }
      
      // åˆ é™¤
      items.pop();
      delete idToIndex[id];
  }
  ```


### **äº”ã€å®‰å…¨æ€§è€ƒé‡**
#### 1. **mapping çš„é™·é˜±**
- **é»˜è®¤å€¼é—®é¢˜**ï¼šæœªèµ‹å€¼çš„é”®è¿”å›é»˜è®¤å€¼ï¼ˆå¦‚ `0`ã€`false`ï¼‰ï¼Œå¯èƒ½å¯¼è‡´é€»è¾‘æ¼æ´ï¼š
  ```solidity
  mapping(address => uint256) public lastClaimTime;
  
  function claimReward() external {
      // å±é™©ï¼šæœªæ£€æŸ¥æ˜¯å¦é¦–æ¬¡è°ƒç”¨ï¼ˆé»˜è®¤å€¼ä¸º0ï¼‰
      require(block.timestamp - lastClaimTime[msg.sender] > 1 days, "Too early");
      lastClaimTime[msg.sender] = block.timestamp;
      // ...
  }
  ```
  **ä¿®å¤**ï¼šç”¨è¾…åŠ©æ˜ å°„æ ‡è®°æ˜¯å¦åˆå§‹åŒ–ï¼š
  ```solidity
  mapping(address => bool) public hasClaimed;
  mapping(address => uint256) public lastClaimTime;
  
  function claimReward() external {
      require(!hasClaimed[msg.sender], "Already claimed");
      hasClaimed[msg.sender] = true;
      // ...
  }
  ```

#### 2. **array çš„é£é™©**
- **è¶Šç•Œè®¿é—®**ï¼šåŠ¨æ€æ•°ç»„éœ€æ‰‹åŠ¨æ ¡éªŒç´¢å¼•èŒƒå›´ï¼š
  ```solidity
  function accessElement(uint256 index) external view returns (uint256) {
      require(index < items.length, "Index out of bounds"); // å¿…é¡»æ£€æŸ¥
      return items[index];
  }
  ```
- **é•¿æ•°ç»„éå†**ï¼šå¤§è§„æ¨¡æ•°ç»„éå†å¯èƒ½è§¦å‘ OutOfGasï¼Œå»ºè®®åˆ†é¡µå¤„ç†ï¼š
  ```solidity
  function processBatch(uint256 start, uint256 count) external {
      require(count <= 100, "Batch size too large"); // é™åˆ¶å•æ¬¡å¤„ç†é‡
      uint256 end = Math.min(start + count, items.length);
      for (uint256 i = start; i < end; i++) {
          // å¤„ç†é€»è¾‘
      }
  }
  ```


### **å…­ã€å†³ç­–æµç¨‹å›¾**
```mermaid
graph TD
    A[é€‰æ‹©æ•°æ®ç»“æ„] --> B{æ˜¯å¦éœ€è¦å¿«é€Ÿé”®å€¼æŸ¥æ‰¾?}
    B -->|æ˜¯| C[mapping]
    B -->|å¦| D{æ˜¯å¦éœ€è¦æœ‰åºé›†åˆ?}
    D -->|æ˜¯| E{array}
    D -->|å¦| F[mapping]
    
    C --> G{æ˜¯å¦éœ€è¦éå†?}
    G -->|æ˜¯| H[mapping + è¾…åŠ©æ•°ç»„]
    G -->|å¦| I[çº¯mapping]
    
    E --> J{å…ƒç´ æ•°é‡æ˜¯å¦å›ºå®š?}
    J -->|æ˜¯| K[å›ºå®šæ•°ç»„]
    J -->|å¦| L[åŠ¨æ€æ•°ç»„]
    
    L --> M{æ˜¯å¦éœ€é¢‘ç¹åˆ é™¤ä¸­é—´å…ƒç´ ?}
    M -->|æ˜¯| N[åŠ¨æ€æ•°ç»„+ç´¢å¼•æ˜ å°„]
    M -->|å¦| O[ç›´æ¥ä½¿ç”¨åŠ¨æ€æ•°ç»„]
```


### **ä¸ƒã€æ€»ç»“ï¼šé€‰å‹é»„é‡‘æ³•åˆ™**
1. **å¿«é€ŸæŸ¥æ‰¾ä¼˜å…ˆ**ï¼šè‹¥æ ¸å¿ƒéœ€æ±‚æ˜¯é€šè¿‡é”®å¿«é€Ÿå®šä½å€¼ï¼ˆå¦‚ä½™é¢æŸ¥è¯¢ï¼‰ï¼Œé€‰ `mapping`ã€‚  
2. **æœ‰åºéå†ä¼˜å…ˆ**ï¼šè‹¥éœ€æŒ‰é¡ºåºå¤„ç†æ•°æ®ï¼ˆå¦‚æ‰¹é‡ä»»åŠ¡ï¼‰ï¼Œé€‰ `array`ã€‚  
3. **åŠ¨æ€æ‰©å±•éœ€æ±‚**ï¼š  
   - å…ƒç´ æ•°é‡ä¸ç¡®å®šä¸”éœ€é¢‘ç¹æ·»åŠ  â†’ `mapping` æˆ–åŠ¨æ€ `array`ã€‚  
   - éœ€ç»´æŠ¤é¡ºåºä¸”åˆ é™¤å°‘ â†’ åŠ¨æ€ `array`ã€‚  
4. **Gas æ•æ„Ÿåœºæ™¯**ï¼š  
   - é«˜é¢‘éšæœºè¯»å†™ â†’ `mapping`ï¼ˆç¨³å®š O(1) æˆæœ¬ï¼‰ã€‚  
   - é«˜é¢‘è¿½åŠ  â†’ åŠ¨æ€ `array`ï¼ˆå°¾æ’é«˜æ•ˆï¼‰ã€‚  
5. **å®‰å…¨æ€§è¦æ±‚**ï¼š  
   - ä¸¥æ ¼è¾¹ç•Œæ§åˆ¶ â†’ å›ºå®š `array`ï¼ˆç¼–è¯‘æ—¶æ£€æŸ¥ï¼‰ã€‚  
   - é¿å…é»˜è®¤å€¼é™·é˜± â†’ `mapping` é…åˆè¾…åŠ©æ ‡è®°ã€‚  

åˆç†ç»“åˆ `mapping` å’Œ `array` å¯æ„å»ºé«˜æ•ˆã€å®‰å…¨çš„å¤æ‚æ•°æ®ç»“æ„ï¼Œå¦‚ Uniswap çš„æµåŠ¨æ€§æ± ç”¨ `mapping` å­˜å‚¨ä½™é¢ï¼Œç”¨äº‹ä»¶æ—¥å¿—ï¼ˆåŠ¨æ€ `array`ï¼‰è®°å½•äº¤æ˜“å†å²ã€‚

- ç­”æ¡ˆï¼š `mapping` ç”¨äºå¿«é€ŸæŸ¥æ‰¾å’Œæ›´æ–°é”®å€¼å¯¹ï¼Œé€‚åˆç”¨äºè´¦æˆ·ä½™é¢ç­‰åœºæ™¯ï¼›è€Œ `array` é€‚ç”¨äºå…ƒç´ é¡ºåºé‡è¦æˆ–éœ€è¦è¿­ä»£å¤„ç†çš„åœºæ™¯ã€‚

```
mapping(address => uint256) public userBalances;
address[] public userList;
```

### å¦‚ä½•åˆ©ç”¨ `struct` åœ¨ Solidity ä¸­æ¨¡æ‹Ÿä¼ ç»Ÿçš„æ•°æ®åº“è¡¨ï¼Ÿ

åœ¨ Solidity ä¸­ï¼Œå¯é€šè¿‡ `struct` ç»“åˆ `mapping` å’Œ `array` æ¨¡æ‹Ÿä¼ ç»Ÿæ•°æ®åº“è¡¨çš„ç»“æ„åŒ–å­˜å‚¨ä¸æŸ¥è¯¢ã€‚ä»¥ä¸‹æ˜¯ç³»ç»Ÿæ€§å®ç°æ–¹æ¡ˆï¼š


### **ä¸€ã€æ ¸å¿ƒæ˜ å°„å…³ç³»**
| æ•°æ®åº“æ¦‚å¿µ       | Solidity å®ç°               | ç¤ºä¾‹ä»£ç                           |
|------------------|-----------------------------|-----------------------------------|
| è¡¨ï¼ˆTableï¼‰      | `struct` + `mapping`/`array`| `struct User { ... }`<br>`mapping(address => User) users;` |
| è¡Œï¼ˆRowï¼‰        | `struct` å®ä¾‹               | `User memory user = User(addr, 18, "Alice");` |
| åˆ—ï¼ˆColumnï¼‰     | `struct` å­—æ®µ               | `uint256 age; string name;` |
| ä¸»é”®ï¼ˆPrimary Keyï¼‰ | `mapping` çš„é”®           | `mapping(address => User) users;`ï¼ˆåœ°å€ä¸ºä¸»é”®ï¼‰ |
| ç´¢å¼•ï¼ˆIndexï¼‰    | é¢å¤– `mapping` æˆ–æ•°ç»„      | `mapping(uint256 => address) ageIndex;` |


### **äºŒã€åŸºç¡€å®ç°ï¼šå•è¡¨ç»“æ„**
#### 1. **å®šä¹‰è¡¨ç»“æ„**
```solidity
struct User {
    string name;
    uint256 age;
    uint256 balance;
    bool isActive;
    uint256 createdAt;
}
```

#### 2. **å­˜å‚¨è¡¨æ•°æ®**
- **æ–¹æ¡ˆ1**ï¼š`mapping` å­˜å‚¨ï¼ˆé€‚åˆæŒ‰ä¸»é”®æŸ¥è¯¢ï¼‰
  ```solidity
  mapping(address => User) public users; // åœ°å€ä½œä¸ºä¸»é”®
  address[] public allUserAddresses;     // è¾…åŠ©æ•°ç»„ï¼Œç”¨äºéå†
  
  function addUser(string memory _name, uint256 _age) external {
      address userAddr = msg.sender;
      users[userAddr] = User({
          name: _name,
          age: _age,
          balance: 0,
          isActive: true,
          createdAt: block.timestamp
      });
      allUserAddresses.push(userAddr);
  }
  ```

- **æ–¹æ¡ˆ2**ï¼šåŠ¨æ€æ•°ç»„å­˜å‚¨ï¼ˆé€‚åˆé¡ºåºéå†ï¼‰
  ```solidity
  struct UserWithId {
      address id;
      string name;
      uint256 age;
  }
  
  UserWithId[] public allUsers;
  mapping(address => uint256) public userIdToIndex; // åœ°å€â†’æ•°ç»„ç´¢å¼•
  
  function addUser(string memory _name, uint256 _age) external {
      address userAddr = msg.sender;
      uint256 index = allUsers.length;
      allUsers.push(UserWithId(userAddr, _name, _age));
      userIdToIndex[userAddr] = index;
  }
  ```


### **ä¸‰ã€é«˜çº§ç‰¹æ€§å®ç°**
#### 1. **å¤åˆç´¢å¼•**
- **åœºæ™¯**ï¼šæŒ‰å¹´é¾„èŒƒå›´æŸ¥è¯¢ç”¨æˆ·
  ```solidity
  mapping(uint256 => address[]) public ageToUsers; // å¹´é¾„â†’ç”¨æˆ·åœ°å€åˆ—è¡¨
  
  function addUser(string memory _name, uint256 _age) external {
      // ä¸»è¡¨æ“ä½œ
      address userAddr = msg.sender;
      users[userAddr] = User(_name, _age, 0, true, block.timestamp);
      
      // ç´¢å¼•ç»´æŠ¤
      ageToUsers[_age].push(userAddr);
  }
  
  function getUsersByAge(uint256 _age) external view returns (address[] memory) {
      return ageToUsers[_age];
  }
  ```

#### 2. **å…³ç³»è¡¨**
- **åœºæ™¯**ï¼šç”¨æˆ·-è®¢å•çš„ä¸€å¯¹å¤šå…³ç³»
  ```solidity
  struct Order {
      uint256 id;
      address buyer;
      uint256 amount;
      uint256 timestamp;
  }
  
  Order[] public allOrders;
  mapping(address => uint256[]) public userOrders; // ç”¨æˆ·â†’è®¢å•IDåˆ—è¡¨
  
  function createOrder(uint256 _amount) external {
      uint256 orderId = allOrders.length;
      allOrders.push(Order(orderId, msg.sender, _amount, block.timestamp));
      userOrders[msg.sender].push(orderId);
  }
  
  function getUserOrders(address _user) external view returns (Order[] memory) {
      uint256[] memory orderIds = userOrders[_user];
      Order[] memory result = new Order[](orderIds.length);
      for (uint256 i = 0; i < orderIds.length; i++) {
          result[i] = allOrders[orderIds[i]];
      }
      return result;
  }
  ```

#### 3. **åˆ†é¡µæŸ¥è¯¢**
- **åœºæ™¯**ï¼šåˆ†æ‰¹è·å–å¤§é‡æ•°æ®
  ```solidity
  function getUsers(uint256 _page, uint256 _pageSize) external view returns (User[] memory) {
      require(_pageSize <= 100, "Page size too large"); // é˜²æ­¢OOG
      uint256 start = _page * _pageSize;
      uint256 end = Math.min(start + _pageSize, allUserAddresses.length);
      User[] memory result = new User[](end - start);
      
      for (uint256 i = start; i < end; i++) {
          address userAddr = allUserAddresses[i];
          result[i - start] = users[userAddr];
      }
      return result;
  }
  ```


### **å››ã€æ€§èƒ½ä¼˜åŒ–ç­–ç•¥**
#### 1. **å­˜å‚¨å¸ƒå±€ä¼˜åŒ–**
- **å­—æ®µæ’åº**ï¼šå°†åŒç±»å‹å­—æ®µè¿ç»­æ’åˆ—ï¼Œå‡å°‘å­˜å‚¨æ§½å ç”¨
  ```solidity
  // ä¼˜åŒ–å‰ï¼ˆå ç”¨3ä¸ªæ§½ï¼‰
  struct BadLayout {
      uint8 age;     // 1å­—èŠ‚
      string name;   // åŠ¨æ€æ•°æ®ï¼Œå 1ä¸ªæ§½
      uint256 score; // 32å­—èŠ‚
  }
  
  // ä¼˜åŒ–åï¼ˆå ç”¨2ä¸ªæ§½ï¼‰
  struct GoodLayout {
      uint256 score; // 32å­—èŠ‚
      uint8 age;     // 1å­—èŠ‚ï¼ˆä¸scoreå…±ç”¨æ§½ï¼‰
      string name;   // åŠ¨æ€æ•°æ®ï¼Œå 1ä¸ªæ§½
  }
  ```

#### 2. **å»¶è¿ŸåŠ è½½ä¸ç¼“å­˜**
- **ç­–ç•¥**ï¼šå¤æ‚æŸ¥è¯¢ç»“æœé“¾ä¸‹ç¼“å­˜ï¼Œé“¾ä¸Šä»…å­˜å‚¨å¿…è¦æ•°æ®
  ```solidity
  // é“¾ä¸Šä»…å­˜å‚¨èšåˆæ•°æ®
  mapping(address => uint256) public userTotalOrders;
  
  function updateTotalOrders(address _user) external {
      uint256[] memory orderIds = userOrders[_user];
      uint256 total = 0;
      for (uint256 i = 0; i < orderIds.length; i++) {
          total += allOrders[orderIds[i]].amount;
      }
      userTotalOrders[_user] = total;
  }
  ```

#### 3. **æ‰¹é‡æ“ä½œ**
- **åœºæ™¯**ï¼šæ‰¹é‡æ’å…¥æ•°æ®ï¼Œå‡å°‘äº¤æ˜“æ¬¡æ•°
  ```solidity
  function batchAddUsers(User[] calldata _users) external {
      for (uint256 i = 0; i < _users.length; i++) {
          address userAddr = _users[i].id;
          users[userAddr] = _users[i];
          allUserAddresses.push(userAddr);
      }
  }
  ```


### **äº”ã€å®‰å…¨ä¸é™åˆ¶**
#### 1. **æ•°æ®å¤§å°é™åˆ¶**
- **åŠ¨æ€æ•°æ®**ï¼š`string`ã€`bytes`ã€æ•°ç»„ç­‰åŠ¨æ€ç±»å‹å¯èƒ½å¯¼è‡´é«˜é¢Gas
- **å»ºè®®**ï¼š
  - é™åˆ¶å­—æ®µé•¿åº¦ï¼ˆå¦‚ `string` è½¬ä¸º `bytes32`ï¼‰
  - æ•æ„Ÿæ•°æ®é“¾ä¸‹å­˜å‚¨ï¼Œé“¾ä¸Šä»…å­˜å“ˆå¸Œ

#### 2. **éå†é£é™©**
- **é•¿æ•°ç»„éå†**ï¼šå¯èƒ½è§¦å‘ OutOfGas
- **é˜²æŠ¤**ï¼š
  - é™åˆ¶å•æ¬¡æŸ¥è¯¢é‡ï¼ˆå¦‚æ¯é¡µä¸è¶…è¿‡100æ¡ï¼‰
  - ä½¿ç”¨æ¸¸æ ‡æœºåˆ¶ï¼ˆè®°å½•ä¸Šæ¬¡æŸ¥è¯¢ä½ç½®ï¼‰

#### 3. **æƒé™æ§åˆ¶**
- **å†™æ“ä½œ**ï¼šå¿…é¡»éªŒè¯è°ƒç”¨è€…æƒé™
  ```solidity
  modifier onlyAdmin() {
      require(isAdmin[msg.sender], "Not admin");
      _;
  }
  
  function deleteUser(address _user) external onlyAdmin {
      delete users[_user];
      // ä»è¾…åŠ©æ•°ç»„ä¸­ç§»é™¤ï¼ˆéœ€ç»´æŠ¤ç´¢å¼•ï¼‰
  }
  ```


### **å…­ã€å®æˆ˜æ¡ˆä¾‹ï¼šNFT æ”¶è—è¡¨**
```solidity
contract NFTCollection {
    struct NFT {
        uint256 tokenId;
        string name;
        string metadataURI;
        address owner;
        uint256 price;
        bool forSale;
        uint256[] attributes; // å¦‚[ç¨€æœ‰åº¦, ç­‰çº§, æ”»å‡»åŠ›]
    }

    // ä¸»è¡¨
    mapping(uint256 => NFT) public tokens;
    uint256[] public allTokenIds;

    // ç´¢å¼•
    mapping(address => uint256[]) public ownerTokens; // æ‰€æœ‰è€…â†’ä»£å¸åˆ—è¡¨
    mapping(uint256 => uint256[]) public rarityIndex; // ç¨€æœ‰åº¦â†’ä»£å¸åˆ—è¡¨

    // æ·»åŠ NFT
    function mintNFT(
        uint256 _tokenId,
        string memory _name,
        string memory _metadataURI,
        uint256[] memory _attributes
    ) external {
        tokens[_tokenId] = NFT({
            tokenId: _tokenId,
            name: _name,
            metadataURI: _metadataURI,
            owner: msg.sender,
            price: 0,
            forSale: false,
            attributes: _attributes
        });
        
        allTokenIds.push(_tokenId);
        ownerTokens[msg.sender].push(_tokenId);
        rarityIndex[_attributes[0]].push(_tokenId); // å‡è®¾attributes[0]ä¸ºç¨€æœ‰åº¦
    }

    // æŒ‰ç¨€æœ‰åº¦æŸ¥è¯¢NFT
    function getNFTsByRarity(uint256 _rarity) external view returns (uint256[] memory) {
        return rarityIndex[_rarity];
    }
}
```


### **ä¸ƒã€ä¸ä¼ ç»Ÿæ•°æ®åº“å¯¹æ¯”**
| ç‰¹æ€§               | Solidity æ¨¡æ‹Ÿè¡¨               | ä¼ ç»Ÿæ•°æ®åº“                 |
|--------------------|-------------------------------|--------------------------|
| æ•°æ®æŒä¹…æ€§         | æ°¸ä¹…å­˜å‚¨ï¼ˆä¸Šé“¾åä¸å¯ç¯¡æ”¹ï¼‰     | å¯ä¿®æ”¹ï¼ˆæ”¯æŒUPDATEï¼‰      |
| æŸ¥è¯¢æ•ˆç‡           | å¤æ‚æŸ¥è¯¢éœ€éå†ï¼ˆGasé«˜ï¼‰        | æ”¯æŒç´¢å¼•ï¼ŒæŸ¥è¯¢é«˜æ•ˆ         |
| æ•°æ®å®¹é‡           | å—Gasé™åˆ¶ï¼ˆé€šå¸¸<10ä¸‡æ¡è®°å½•ï¼‰   | å¯å­˜å‚¨æµ·é‡æ•°æ®             |
| å†™å…¥æˆæœ¬           | é«˜ï¼ˆéœ€çŸ¿å·¥æ‰“åŒ…ï¼‰               | ä½ï¼ˆå•æœºæˆ–é›†ç¾¤ï¼‰           |
| äº‹åŠ¡åŸå­æ€§         | å¤©ç„¶æ”¯æŒï¼ˆå•äº¤æ˜“å†…åŸå­æ‰§è¡Œï¼‰   | éœ€æ˜¾å¼ç®¡ç†ï¼ˆå¦‚BEGIN TRANSACTIONï¼‰ |
| æ•°æ®éšç§           | å…¬å¼€é€æ˜ï¼ˆæ‰€æœ‰æ•°æ®å¯æŸ¥è¯¢ï¼‰     | æ”¯æŒæƒé™æ§åˆ¶               |

é€šè¿‡åˆç†è®¾è®¡ `struct`ã€`mapping` å’Œè¾…åŠ©ç´¢å¼•ï¼Œå¯åœ¨ Solidity ä¸­æ„å»ºé«˜æ•ˆçš„ç»“æ„åŒ–æ•°æ®å­˜å‚¨ï¼Œæ»¡è¶³å¤§å¤šæ•° DApp éœ€æ±‚ã€‚å¯¹äºè¶…å¤§è§„æ¨¡æ•°æ®æˆ–å¤æ‚æŸ¥è¯¢ï¼Œå»ºè®®ç»“åˆé“¾ä¸‹å­˜å‚¨ï¼ˆå¦‚ IPFS + é“¾ä¸Šç´¢å¼•ï¼‰ã€‚

- ç­”æ¡ˆï¼š å¯ä»¥ä½¿ç”¨ `struct` æ¥å®šä¹‰è¡¨çš„åˆ—ï¼Œç„¶åä½¿ç”¨ `mapping` æˆ–æ•°ç»„æ¥å­˜å‚¨ `struct` å®ä¾‹ï¼Œæ¨¡æ‹Ÿè¡Œçš„æ¦‚å¿µã€‚

```
struct Employee {
    uint256 id;
    string name;
    uint256 departmentId;
}
mapping(uint256 => Employee) public employees;
```

### Solidity ä¸­ `enum` å¦‚ä½•å¸®åŠ©é™ä½é”™è¯¯çš„å‘ç”Ÿï¼Ÿ

åœ¨ Solidity ä¸­ï¼Œ`enum`ï¼ˆæšä¸¾ï¼‰é€šè¿‡**é™å®šå˜é‡å–å€¼èŒƒå›´**å’Œ**æä¾›è¯­ä¹‰åŒ–æ ‡è¯†**æ¥é™ä½é”™è¯¯å‘ç”Ÿçš„æ¦‚ç‡ï¼Œå…·ä½“ä½œç”¨åŠå®ç°é€»è¾‘å¦‚ä¸‹ï¼š  


### ä¸€ã€**é€šè¿‡å–å€¼èŒƒå›´çº¦æŸé¿å…æ— æ•ˆçŠ¶æ€**
#### 1. **å¼ºåˆ¶ç±»å‹å®‰å…¨ï¼Œé˜²æ­¢éæ³•è¾“å…¥**
  - **åŸç†**ï¼šæšä¸¾å®šä¹‰äº†ä¸€ç»„é¢„å®šä¹‰çš„å¸¸é‡å€¼ï¼Œå˜é‡åªèƒ½èµ‹å€¼ä¸ºæšä¸¾ä¸­å£°æ˜çš„æˆå‘˜ï¼Œç¼–è¯‘å™¨ä¼šåœ¨ç¼–è¯‘é˜¶æ®µæ£€æŸ¥èµ‹å€¼åˆæ³•æ€§ã€‚
  - **ç¤ºä¾‹**ï¼š  
    ```solidity
    enum OrderStatus { PENDING, CONFIRMED, SHIPPED, COMPLETED, CANCELLED }
    
    struct Order {
        uint256 id;
        OrderStatus status;
        // å…¶ä»–å­—æ®µ
    }
    
    function updateOrderStatus(uint256 orderId, OrderStatus newStatus) public {
        // ç¼–è¯‘å™¨è‡ªåŠ¨æ£€æŸ¥ newStatus æ˜¯å¦ä¸ºæšä¸¾æˆå‘˜ï¼Œé¿å…ä¼ å…¥æ— æ•ˆå€¼
        orders[orderId].status = newStatus;
    }
    ```
  - **é”™è¯¯é˜²èŒƒåœºæ™¯**ï¼šè‹¥å¼€å‘è€…è¯¯å°†éæšä¸¾å€¼ï¼ˆå¦‚ `uint` ç±»å‹çš„ `5`ï¼‰èµ‹å€¼ç»™ `OrderStatus` å˜é‡ï¼Œç¼–è¯‘å™¨ä¼šæŠ¥é”™ï¼Œé¿å…åˆçº¦è¿›å…¥éæ³•çŠ¶æ€ï¼ˆå¦‚è®¢å•çŠ¶æ€è¢«é”™è¯¯æ ‡è®°ä¸ºæœªå®šä¹‰çš„ `5`ï¼‰ã€‚

#### 2. **æ›¿ä»£é­”æ³•æ•°å­—ï¼Œæå‡ä»£ç å¯ç»´æŠ¤æ€§**
  - **ä¼ ç»Ÿé—®é¢˜**ï¼šç›´æ¥ä½¿ç”¨æ•°å­—ï¼ˆå¦‚ `0`ã€`1`ã€`2`ï¼‰è¡¨ç¤ºçŠ¶æ€æ—¶ï¼Œæ˜“å› å«ä¹‰ä¸æ˜ç¡®å¯¼è‡´èµ‹å€¼é”™è¯¯ï¼ˆå¦‚å°† `2` è¯¯ä½œâ€œå·²å®Œæˆâ€è€Œéâ€œå·²å‘è´§â€ï¼‰ã€‚
  - **æšä¸¾ä¼˜åŠ¿**ï¼šç”¨å‘½åå¸¸é‡ï¼ˆå¦‚ `COMPLETED`ã€`SHIPPED`ï¼‰æ›¿ä»£æ•°å­—ï¼Œä¸ä»…ä¾¿äºç†è§£ï¼Œè¿˜èƒ½é€šè¿‡ç¼–è¯‘å™¨å¼ºåˆ¶çº¦æŸå–å€¼ï¼Œé¿å…â€œé­”æ³•æ•°å­—â€å¼•å‘çš„é€»è¾‘é”™è¯¯ã€‚


### äºŒã€**é€šè¿‡è¯­ä¹‰åŒ–æ ‡è¯†å‡å°‘é€»è¾‘æ··æ·†**
#### 1. **æ˜ç¡®ä¸šåŠ¡è¯­ä¹‰ï¼Œé™ä½ç†è§£æˆæœ¬**
  - **åœºæ™¯ä¸¾ä¾‹**ï¼šåœ¨é‡‘èåˆçº¦ä¸­ï¼Œæšä¸¾å¯å®šä¹‰äº¤æ˜“ç±»å‹ï¼š  
    ```solidity
    enum TransactionType { DEPOSIT, WITHDRAW, TRANSFER, STAKE }
    ```
  - **é”™è¯¯é˜²èŒƒ**ï¼šå½“å‡½æ•°éœ€è¦æ ¹æ®äº¤æ˜“ç±»å‹æ‰§è¡Œä¸åŒé€»è¾‘æ—¶ï¼Œæšä¸¾æˆå‘˜çš„å‘½åï¼ˆå¦‚ `DEPOSIT`ï¼‰èƒ½æ˜ç¡®è¯­ä¹‰ï¼Œå‡å°‘å¼€å‘è€…å› è¯¯è§£æ•°å­—å«ä¹‰å¯¼è‡´çš„æ¡ä»¶åˆ¤æ–­é”™è¯¯ï¼ˆå¦‚å°† `TRANSFER` é€»è¾‘è¯¯å†™è¿› `WITHDRAW` åˆ†æ”¯ï¼‰ã€‚

#### 2. **ä¸ç»“æ„ä½“ç»“åˆï¼Œå¼ºåŒ–æ•°æ®ä¸€è‡´æ€§**
  - **åº”ç”¨åœºæ™¯**ï¼šåœ¨å¤æ‚ä¸šåŠ¡ä¸­ï¼Œæšä¸¾å¯ä½œä¸ºç»“æ„ä½“çš„å­—æ®µï¼Œç¡®ä¿æ•°æ®çŠ¶æ€çš„åˆæ³•æ€§ã€‚ä¾‹å¦‚ï¼š  
    ```solidity
    enum LoanStatus { APPLIED, APPROVED, FUNDED, REPAID, DEFAULTED }
    
    struct Loan {
        address borrower;
        uint256 amount;
        LoanStatus status;
        // å…¶ä»–å­—æ®µ
    }
    ```
  - **ä¸€è‡´æ€§ä¿éšœ**ï¼šå½“ä¿®æ”¹è´·æ¬¾çŠ¶æ€æ—¶ï¼Œæšä¸¾ä¼šå¼ºåˆ¶çŠ¶æ€æµè½¬ç¬¦åˆä¸šåŠ¡é€»è¾‘ï¼ˆå¦‚ `APPLIED` â†’ `APPROVED` â†’ `FUNDED`ï¼‰ï¼Œè‹¥å°è¯•è·³è¿‡ä¸­é—´çŠ¶æ€ï¼ˆå¦‚ç›´æ¥ä» `APPLIED` æ”¹ä¸º `FUNDED`ï¼‰ï¼Œè™½éœ€æ‰‹åŠ¨æ·»åŠ é€»è¾‘æ ¡éªŒï¼Œä½†æšä¸¾æœ¬èº«çš„ç±»å‹å®‰å…¨å·²ç¡®ä¿çŠ¶æ€å€¼ä¸ä¼šæ˜¯æ— æ•ˆå€¼ï¼ˆå¦‚éæšä¸¾æˆå‘˜çš„æ•°å­—ï¼‰ã€‚


### ä¸‰ã€**åœ¨åŒºå—é“¾åœºæ™¯ä¸­çš„é¢å¤–ä¼˜åŠ¿**
#### 1. **å‡å°‘é“¾ä¸Šæ•°æ®æ­§ä¹‰**
  - åŒºå—é“¾æ•°æ®ä¸å¯ç¯¡æ”¹ï¼Œè‹¥ä½¿ç”¨æ•°å­—è¡¨ç¤ºçŠ¶æ€ï¼Œåç»­ç»´æŠ¤æ—¶å¯èƒ½å› æ–‡æ¡£ç¼ºå¤±å¯¼è‡´çŠ¶æ€å«ä¹‰æ¨¡ç³Šã€‚æšä¸¾é€šè¿‡å‘½åå¸¸é‡åœ¨ ABIï¼ˆåº”ç”¨äºŒè¿›åˆ¶æ¥å£ï¼‰ä¸­ä¿ç•™è¯­ä¹‰ä¿¡æ¯ï¼Œä¾¿äºå¤–éƒ¨å·¥å…·è§£æï¼ˆå¦‚åŒºå—æµè§ˆå™¨æ˜¾ç¤º `OrderStatus.COMPLETED` è€Œéæ•°å­— `3`ï¼‰ï¼Œå‡å°‘æ•°æ®è§£è¯»é”™è¯¯ã€‚

#### 2. **é™ä½å¤šåˆçº¦äº¤äº’é£é™©**
  - å½“å¤šä¸ªåˆçº¦å¼•ç”¨åŒä¸€æšä¸¾æ—¶ï¼ˆå¦‚é€šè¿‡ `import` å…±äº«æšä¸¾å®šä¹‰ï¼‰ï¼Œå¯ç¡®ä¿ä¸åŒåˆçº¦å¯¹çŠ¶æ€å€¼çš„ç†è§£ä¸€è‡´ï¼Œé¿å…å› ç¡¬ç¼–ç æ•°å­—ä¸ä¸€è‡´å¯¼è‡´çš„äº¤äº’é”™è¯¯ï¼ˆå¦‚åˆçº¦ A è®¤ä¸º `2` æ˜¯â€œå·²å®Œæˆâ€ï¼Œåˆçº¦ B è®¤ä¸º `2` æ˜¯â€œå·²å–æ¶ˆâ€ï¼‰ã€‚


### å››ã€**ä½¿ç”¨æšä¸¾æ—¶çš„æ³¨æ„äº‹é¡¹ï¼ˆé¿å…æ–°é”™è¯¯ï¼‰**
#### 1. **æšä¸¾å€¼å˜æ›´çš„å…¼å®¹æ€§é—®é¢˜**
  - è‹¥åˆçº¦å·²éƒ¨ç½²ï¼Œæ–°å¢æšä¸¾æˆå‘˜ä¼šæ”¹å˜åŸæœ‰æˆå‘˜çš„æ•°å€¼æ˜ å°„ï¼ˆå¦‚åŸ `enum A { X, Y }` ä¸­ `X=0`ã€`Y=1`ï¼Œæ–°å¢ `Z` å `Y` å˜ä¸º `1`ã€`Z=2`ï¼‰ï¼Œå¯èƒ½å¯¼è‡´å†å²æ•°æ®è§£æé”™è¯¯ã€‚å› æ­¤ï¼Œæšä¸¾å®šä¹‰åº”å°½é‡ç¨³å®šï¼Œé¿å…åœ¨éƒ¨ç½²åä¿®æ”¹ã€‚

#### 2. **ä¸ uint ç±»å‹çš„è½¬æ¢é£é™©**
  - æšä¸¾å¯éšå¼è½¬æ¢ä¸º `uint`ï¼ˆå¦‚ `uint statusCode = OrderStatus.PENDING` å¾—åˆ° `0`ï¼‰ï¼Œä½†åå‘è½¬æ¢éœ€æ˜¾å¼å¼ºåˆ¶ç±»å‹è½¬æ¢ï¼ˆå¦‚ `OrderStatus(uint8(0))`ï¼‰ã€‚è‹¥è½¬æ¢æ—¶æœªæ­£ç¡®å¤„ç†æ•°å€¼èŒƒå›´ï¼ˆå¦‚å°† `uint` å€¼ `5` è½¬æ¢ä¸ºåªæœ‰ 5 ä¸ªæˆå‘˜çš„æšä¸¾ï¼‰ï¼Œä¼šå¯¼è‡´è¿è¡Œæ—¶é”™è¯¯ï¼ˆå¦‚ `panic`ï¼‰ï¼Œéœ€é¢å¤–æ·»åŠ æ ¡éªŒé€»è¾‘ã€‚


### æ€»ç»“ï¼šæšä¸¾é™ä½é”™è¯¯çš„æ ¸å¿ƒé€»è¾‘
| **ç»´åº¦**       | **ä¼ ç»Ÿæ–¹å¼ï¼ˆæ•°å­—/å­—ç¬¦ä¸²ï¼‰**                     | **æšä¸¾çš„ä¼˜åŠ¿**                               |
|----------------|---------------------------------------------|------------------------------------------|
| **ç±»å‹å®‰å…¨**   | æ— ç¼–è¯‘æœŸå–å€¼æ£€æŸ¥ï¼Œæ˜“ä¼ å…¥æ— æ•ˆå€¼ï¼ˆå¦‚ `status=100`ï¼‰           | ç¼–è¯‘å™¨å¼ºåˆ¶çº¦æŸå–å€¼èŒƒå›´ï¼Œæœç»æ— æ•ˆçŠ¶æ€                  |
| **è¯­ä¹‰æ˜ç¡®æ€§** | æ•°å­—å«ä¹‰ä¾èµ–æ–‡æ¡£ï¼Œæ˜“å› ç†è§£åå·®å¯¼è‡´é€»è¾‘é”™è¯¯ï¼ˆå¦‚ `0` å¯èƒ½è¡¨ç¤ºâ€œå¾…å¤„ç†â€æˆ–â€œå·²å–æ¶ˆâ€ï¼‰ | å‘½åå¸¸é‡ç›´æ¥ä½“ç°ä¸šåŠ¡å«ä¹‰ï¼Œå‡å°‘äººä¸ºè¯¯è§£                |
| **å¯ç»´æŠ¤æ€§**   | æ–°å¢çŠ¶æ€éœ€ä¿®æ”¹å¤šå¤„ç¡¬ç¼–ç æ•°å­—ï¼Œæ˜“é—æ¼                      | æ–°å¢æšä¸¾æˆå‘˜åªéœ€ä¿®æ”¹æšä¸¾å®šä¹‰ï¼Œè°ƒç”¨å¤„è‡ªåŠ¨åŒæ­¥ï¼ˆæœªéƒ¨ç½²æ—¶ï¼‰        |
| **é“¾ä¸Šå¯è¯»æ€§** | åŒºå—æ•°æ®ä»…æ˜¾ç¤ºæ•°å­—ï¼Œéœ€é¢å¤–æ–‡æ¡£æ˜ å°„                        | å‘½åå¸¸é‡å¯é€šè¿‡ ABI è§£æï¼Œæå‡æ•°æ®å¯è¯»æ€§                |

é€šè¿‡ä»¥ä¸Šæœºåˆ¶ï¼Œ`enum` åœ¨ Solidity ä¸­æˆä¸ºå‡å°‘é€»è¾‘é”™è¯¯ã€æå‡åˆçº¦å¯é æ€§çš„é‡è¦å·¥å…·ï¼Œå°¤å…¶é€‚ç”¨äºçŠ¶æ€æœºã€æƒé™æ§åˆ¶ã€ç±»å‹åˆ†ç±»ç­‰éœ€è¦æ˜ç¡®å–å€¼èŒƒå›´çš„åœºæ™¯ã€‚

- ç­”æ¡ˆï¼š `enum` é™åˆ¶å˜é‡çš„å–å€¼èŒƒå›´ï¼Œå‡å°‘éæ³•å€¼çš„è¾“å…¥ï¼Œæé«˜ä»£ç çš„å¯ç»´æŠ¤æ€§å’Œé”™è¯¯é¢„é˜²ã€‚

```
enum State { Active, Inactive, Suspended }
```

### ä¸ºä½• `bytes` ç±»å‹æœ‰æ—¶æ¯” `string` æ›´ä¼˜ï¼Ÿ

åœ¨ Solidity ä¸­ï¼Œ`bytes` å’Œ `string` éƒ½ç”¨äºå¤„ç†å­—ç¬¦æ•°æ®ï¼Œä½† **`bytes` ç±»å‹åœ¨å­˜å‚¨æ•ˆç‡ã€æ“ä½œçµæ´»æ€§å’Œ Gas æˆæœ¬ä¸Šé€šå¸¸ä¼˜äº `string`**ã€‚ä»¥ä¸‹æ˜¯å…·ä½“åŸå› åŠé€‚ç”¨åœºæ™¯ï¼š


### **ä¸€ã€æ ¸å¿ƒå·®å¼‚å¯¹æ¯”**
| **ç‰¹æ€§**         | **`bytes`**                          | **`string`**                        |
|------------------|--------------------------------------|-------------------------------------|
| **æ•°æ®ç»“æ„**     | åŠ¨æ€å­—èŠ‚æ•°ç»„ï¼ˆ`byte[]` çš„ä¼˜åŒ–ç‰ˆï¼‰      | UTF-8 ç¼–ç çš„å­—ç¬¦ä¸²ï¼ˆæœ¬è´¨æ˜¯ `bytes`ï¼‰ |
| **å­˜å‚¨æ–¹å¼**     | ç›´æ¥å­˜å‚¨å­—èŠ‚ï¼Œé•¿åº¦å‰ç¼€ä¸º 32 å­—èŠ‚        | ä¸ `bytes` ç›¸åŒï¼Œä½†éœ€ UTF-8 è§£ç       |
| **æ“ä½œæ”¯æŒ**     | æ”¯æŒç›´æ¥å­—èŠ‚çº§æ“ä½œï¼ˆå¦‚ç´¢å¼•ã€åˆ‡ç‰‡ï¼‰      | éœ€é€šè¿‡ `bytes(s)` è½¬æ¢ä¸º `bytes` æ“ä½œ |
| **Gas æˆæœ¬**     | æ“ä½œç®€å•ï¼ŒGas è¾ƒä½ï¼ˆå°¤å…¶å†™å…¥æ—¶ï¼‰        | éœ€ UTF-8 éªŒè¯ï¼ŒGas è¾ƒé«˜               |
| **é€‚ç”¨åœºæ™¯**     | äºŒè¿›åˆ¶æ•°æ®ã€æ— éœ€ UTF-8 è§£ç çš„å­—ç¬¦ä¸²      | éœ€äººç±»å¯è¯»çš„æ–‡æœ¬ï¼ˆå¦‚ç”¨æˆ·åç§°ï¼‰        |


### **äºŒã€ä¸ºä½• `bytes` æ›´ä¼˜ï¼Ÿ**
#### 1. **å­˜å‚¨æ•ˆç‡æ›´é«˜**
- **åŠ¨æ€é•¿åº¦æ•°æ®**ï¼š`bytes` å’Œ `string` å‡ä½¿ç”¨ 32 å­—èŠ‚å­˜å‚¨é•¿åº¦ + å®é™…æ•°æ®ï¼Œä½† `string` éœ€é¢å¤– UTF-8 éªŒè¯ï¼Œå­˜å‚¨çº¯ ASCII æ•°æ®æ—¶ `bytes` æ›´é«˜æ•ˆã€‚
- **ç¤ºä¾‹**ï¼šå­˜å‚¨ `"hello"`ï¼ˆ5 å­—èŠ‚ ASCIIï¼‰ï¼š
  ```solidity
  bytes public b = "hello";    // 32 å­—èŠ‚ï¼ˆé•¿åº¦ï¼‰ + 5 å­—èŠ‚ï¼ˆæ•°æ®ï¼‰
  string public s = "hello";  // åŒä¸Šï¼Œä½†éœ€ UTF-8 éªŒè¯
  ```

#### 2. **æ“ä½œæ›´çµæ´»**
- **ç›´æ¥å­—èŠ‚æ“ä½œ**ï¼š`bytes` æ”¯æŒé«˜æ•ˆçš„å­—èŠ‚çº§æ“ä½œï¼ˆå¦‚ç´¢å¼•è®¿é—®ã€åˆ‡ç‰‡ï¼‰ï¼Œè€Œ `string` éœ€å…ˆè½¬æ¢ï¼š
  ```solidity
  bytes b = "hello";
  b[0] = 0x48;  // ç›´æ¥ä¿®æ”¹å­—èŠ‚ï¼ˆ'h' â†’ 'H'ï¼‰
  
  string s = "hello";
  bytes(s)[0] = 0x48;  // éœ€å…ˆè½¬æ¢ï¼Œæ“ä½œç¹çä¸” Gas é«˜
  ```

#### 3. **Gas æˆæœ¬æ›´ä½**
- **å†™å…¥æ“ä½œ**ï¼š`bytes` æ— éœ€ UTF-8 éªŒè¯ï¼ŒGas æ¶ˆè€—æ˜¾è‘—ä½äº `string`ã€‚ä¾‹å¦‚ï¼š
  ```solidity
  function setBytes(bytes calldata _data) external {
      b = _data;  // ä»…å­˜å‚¨å­—èŠ‚ï¼ŒGas çº¦ 5000
  }
  
  function setString(string calldata _str) external {
      s = _str;   // éœ€éªŒè¯ UTF-8ï¼ŒGas çº¦ 8000
  }
  ```
- **æ‹¼æ¥æ“ä½œ**ï¼š`bytes.concat()` æ¯” `string.concat()` æ›´é«˜æ•ˆï¼š
  ```solidity
  bytes memory result = bytes.concat(b1, b2);  // ç›´æ¥æ‹¼æ¥å­—èŠ‚
  string memory result = string.concat(s1, s2);  // éœ€å…ˆè½¬æ¢ä¸º bytes å†æ‹¼æ¥
  ```

#### 4. **é€‚åˆäºŒè¿›åˆ¶æ•°æ®**
- **å“ˆå¸Œã€ç­¾åç­‰åœºæ™¯**ï¼š`bytes` æ— éœ€ç¼–ç è½¬æ¢ï¼Œç›´æ¥å¤„ç†äºŒè¿›åˆ¶æ•°æ®ï¼š
  ```solidity
  bytes32 hash = keccak256(bytes("data"));  // é¿å…é¢å¤–è½¬æ¢
  bytes signature = signMessage(hash);      // å­˜å‚¨ç­¾åï¼ˆäºŒè¿›åˆ¶æ•°æ®ï¼‰
  ```


### **ä¸‰ã€å…¸å‹é€‚ç”¨åœºæ™¯**
#### 1. **å­˜å‚¨äºŒè¿›åˆ¶æ•°æ®**
- **å“ˆå¸Œå€¼ã€ç­¾åã€ABI ç¼–ç æ•°æ®**ï¼š
  ```solidity
  bytes32 public txHash;
  bytes public signature;
  ```

#### 2. **é«˜æ•ˆå­—ç¬¦ä¸²æ“ä½œ**
- **éœ€é¢‘ç¹ä¿®æ”¹æˆ–æˆªå–çš„å­—ç¬¦ä¸²**ï¼š
  ```solidity
  function truncate(bytes calldata _data, uint256 _length) external pure returns (bytes memory) {
      return _data[:_length];  // é«˜æ•ˆåˆ‡ç‰‡æ“ä½œ
  }
  ```

#### 3. **åˆçº¦é—´æ•°æ®ä¼ é€’**
- **å¤–éƒ¨è°ƒç”¨å‚æ•°**ï¼šä½¿ç”¨ `bytes` é¿å… UTF-8 éªŒè¯å¼€é”€ï¼š
  ```solidity
  function processData(bytes calldata _payload) external {
      // ç›´æ¥å¤„ç†å­—èŠ‚æ•°æ®ï¼Œæ— éœ€è§£ç 
  }
  ```

#### 4. **Gas æ•æ„Ÿåœºæ™¯**
- **é«˜é¢‘å†™å…¥æ“ä½œ**ï¼ˆå¦‚æ—¥å¿—è®°å½•ï¼‰ï¼š
  ```solidity
  bytes[] public logs;
  
  function logEvent(bytes calldata _event) external {
      logs.push(_event);  // æ¯” string èŠ‚çœçº¦ 30% Gas
  }
  ```


### **å››ã€ä½•æ—¶ä½¿ç”¨ `string`ï¼Ÿ**
- **éœ€äººç±»å¯è¯»çš„æ–‡æœ¬**ï¼šå¦‚ç”¨æˆ·åç§°ã€æè¿°ä¿¡æ¯ç­‰éœ€æ˜¾ç¤ºçš„å†…å®¹ã€‚
- **ä¾èµ– UTF-8 ç¼–ç **ï¼šå¦‚åŒ…å«é ASCII å­—ç¬¦ï¼ˆå¦‚ä¸­æ–‡ã€emojiï¼‰çš„æ–‡æœ¬ã€‚
  ```solidity
  string public userName;
  string public description = "è¿™æ˜¯ä¸€ä¸ªç¤ºä¾‹";
  ```


### **äº”ã€æ€§èƒ½å¯¹æ¯”ç¤ºä¾‹**
#### 1. **å†™å…¥æ“ä½œ Gas å¯¹æ¯”**
| æ“ä½œç±»å‹         | `bytes` Gas æ¶ˆè€— | `string` Gas æ¶ˆè€— |
|------------------|------------------|-------------------|
| åˆå§‹åŒ–ç©ºå€¼       | 20000            | 20000             |
| å†™å…¥ 32 å­—èŠ‚æ•°æ® | 21000            | 24000             |
| å†™å…¥ 100 å­—èŠ‚æ•°æ®| 25000            | 28000             |

#### 2. **å­—ç¬¦ä¸²æ‹¼æ¥æ€§èƒ½**
```solidity
// bytes æ‹¼æ¥ï¼ˆé«˜æ•ˆï¼‰
function concatBytes(bytes calldata a, bytes calldata b) external pure returns (bytes memory) {
    return bytes.concat(a, b);  // Gas çº¦ 15000
}

// string æ‹¼æ¥ï¼ˆä½æ•ˆï¼‰
function concatString(string calldata a, string calldata b) external pure returns (string memory) {
    return string(bytes.concat(bytes(a), bytes(b)));  // Gas çº¦ 20000
}
```


### **å…­ã€å…³é”®æ³¨æ„äº‹é¡¹**
1. **UTF-8 å…¼å®¹æ€§**ï¼šè‹¥æ•°æ®éœ€æ”¯æŒå¤šè¯­è¨€ï¼Œä½¿ç”¨ `string` ç¡®ä¿ç¼–ç æ­£ç¡®æ€§ã€‚
2. **ABI ç¼–ç å·®å¼‚**ï¼šå¤–éƒ¨è°ƒç”¨æ—¶ï¼Œ`bytes` ä½œä¸ºå‚æ•°çš„ ABI ç¼–ç æ›´ç´§å‡‘ï¼ˆæ— éœ€ UTF-8 å…ƒæ•°æ®ï¼‰ã€‚
3. **é•¿åº¦é™åˆ¶**ï¼š`bytes` å’Œ `string` å‡å— EVM é™åˆ¶ï¼ˆç†è®ºä¸Šé™çº¦ 2^256-1 å­—èŠ‚ï¼Œä½†å®é™…å›  Gas é™åˆ¶é€šå¸¸ < 1MBï¼‰ã€‚

é€šè¿‡åˆç†é€‰æ‹© `bytes` å’Œ `string`ï¼Œå¯æ˜¾è‘—ä¼˜åŒ–åˆçº¦æ€§èƒ½ï¼Œå°¤å…¶åœ¨é«˜é¢‘æ“ä½œæˆ–å­˜å‚¨å¤§é‡æ•°æ®æ—¶ã€‚

- ç­”æ¡ˆï¼š å½“å¤„ç†ä¸éœ€è¦å­—ç¬¦å¤„ç†åŠŸèƒ½çš„çº¯äºŒè¿›åˆ¶æ•°æ®æ—¶ï¼Œ`bytes` ç±»å‹æ›´èŠ‚çœç©ºé—´å’Œ Gas æˆæœ¬ï¼Œå› ä¸ºå®ƒä¸æ¶‰åŠ UTF-8 ç¼–ç å¤„ç†ã€‚

```
bytes public rawData;
```

### å¦‚ä½•é€‰æ‹©åœ¨ Solidity ä¸­å­˜å‚¨æ—¶é—´çš„æœ€ä½³æ•°æ®ç»“æ„ï¼Ÿ

åœ¨ Solidity ä¸­å­˜å‚¨æ—¶é—´æ—¶ï¼Œéœ€æ ¹æ®**ç²¾åº¦éœ€æ±‚ã€æ“ä½œå¤æ‚åº¦ã€Gas æˆæœ¬**é€‰æ‹©æœ€ä¼˜æ•°æ®ç»“æ„ã€‚ä»¥ä¸‹æ˜¯ç³»ç»Ÿæ€§çš„é€‰å‹æŒ‡å—ï¼š


### **ä¸€ã€æ ¸å¿ƒæ—¶é—´è¡¨ç¤ºæ–¹å¼**
#### 1. **åŸç”Ÿæ—¶é—´å•ä½ï¼ˆæ¨èï¼‰**
- **ç±»å‹**ï¼š`uint256`ï¼ˆç§’çº§æ—¶é—´æˆ³ï¼‰
- **æ¥æº**ï¼š
  - `block.timestamp`ï¼šå½“å‰åŒºå—æ—¶é—´æˆ³ï¼ˆç§’ï¼‰
  - `block.number`ï¼šåŒºå—é«˜åº¦ï¼ˆå¯æ¢ç®—ä¸ºæ—¶é—´ï¼‰
- **ç¤ºä¾‹**ï¼š
  ```solidity
  uint256 public startTime = block.timestamp;  // å­˜å‚¨éƒ¨ç½²æ—¶é—´
  uint256 public unlockTime = block.timestamp + 30 days;  // 30å¤©åè§£é”
  ```
- **ä¼˜åŠ¿**ï¼š
  - ç›´æ¥æ˜ å°„ EVM åŸç”Ÿå˜é‡ï¼Œæ— éœ€é¢å¤–è½¬æ¢
  - æ“ä½œç®€å•ï¼ˆåŠ å‡ä¹˜é™¤ï¼‰ï¼ŒGas æˆæœ¬ä½
  - å…¼å®¹æ‰€æœ‰æ—¶é—´å•ä½ï¼ˆ`seconds`ã€`minutes`ã€`hours`ã€`days`ã€`weeks`ï¼‰

#### 2. **ç»“æ„ä½“æ‹†åˆ†å­˜å‚¨ï¼ˆç‰¹æ®Šåœºæ™¯ï¼‰**
- **åœºæ™¯**ï¼šéœ€é¢‘ç¹è®¿é—®å¹´/æœˆ/æ—¥ç­‰å­—æ®µï¼ˆå¦‚æ—¥å†åº”ç”¨ï¼‰
- **ç¤ºä¾‹**ï¼š
  ```solidity
  struct DateTime {
      uint256 year;
      uint256 month;
      uint256 day;
      uint256 hour;
      uint256 minute;
      uint256 second;
  }
  
  // éœ€é€šè¿‡åº“å‡½æ•°è½¬æ¢ï¼ˆå¦‚ OpenZeppelin çš„ DateTime.solï¼‰
  function timestampToDateTime(uint256 timestamp) internal pure returns (DateTime memory) {
      // å¤æ‚è½¬æ¢é€»è¾‘ï¼ˆæ¶‰åŠé—°å¹´ã€æ—¶åŒºç­‰ï¼‰
  }
  ```
- **åŠ£åŠ¿**ï¼š
  - å­˜å‚¨æˆæœ¬é«˜ï¼ˆ6 ä¸ª `uint256` å…± 192 å­—èŠ‚ï¼‰
  - è½¬æ¢é€»è¾‘å¤æ‚ï¼ŒGas æ¶ˆè€—å¤§
  - é“¾ä¸Šè®¡ç®—å—åŒºå— Gas é™åˆ¶


### **äºŒã€æ—¶é—´å•ä½ä¸ç²¾åº¦é€‰æ‹©**
#### 1. **ç§’çº§æ—¶é—´æˆ³ï¼ˆé»˜è®¤ï¼‰**
- **é€‚ç”¨åœºæ™¯**ï¼š
  - ç›¸å¯¹æ—¶é—´è®¡ç®—ï¼ˆå¦‚â€œ24å°æ—¶åâ€ï¼‰
  - ç²¾ç¡®åˆ°ç§’çš„äº‹ä»¶è§¦å‘ï¼ˆå¦‚æ‹å–ç»“æŸæ—¶é—´ï¼‰
- **ç¤ºä¾‹**ï¼š
  ```solidity
  function claimReward() external {
      require(block.timestamp >= lastClaimTime + 1 days, "Too early");
      // å‘æ”¾å¥–åŠ±
  }
  ```

#### 2. **åŒºå—é«˜åº¦ï¼ˆæ›¿ä»£æ–¹æ¡ˆï¼‰**
- **é€‚ç”¨åœºæ™¯**ï¼š
  - ä¾èµ–åŒºå—ç¡®è®¤æ•°ï¼ˆå¦‚å¤šé‡ç­¾åçš„ç¡®è®¤å»¶è¿Ÿï¼‰
  - ç½‘ç»œåŒºå—æ—¶é—´ç¨³å®šï¼ˆå¦‚ PoS é“¾ï¼‰
- **ç¤ºä¾‹**ï¼š
  ```solidity
  uint256 public startBlock = block.number;
  uint256 public vestingBlocks = 10000;  // å‡è®¾å¹³å‡15ç§’/å—ï¼Œçº¦1.7å¤©
  
  function canWithdraw() external view returns (bool) {
      return block.number >= startBlock + vestingBlocks;
  }
  ```
- **ä¼˜åŠ¿**ï¼š
  - ä¸å—åŒºå—æ—¶é—´æ³¢åŠ¨å½±å“ï¼ˆå¦‚ PoW é“¾çš„å‡ºå—æ—¶é—´ä¸ç¨³å®šï¼‰
  - é€‚åˆâ€œåŒºå—ç¡®è®¤æ•°â€ç›¸å…³é€»è¾‘ï¼ˆå¦‚è·¨é“¾æ¡¥ï¼‰

#### 3. **ç‰¹æ®Šç²¾åº¦éœ€æ±‚**
- **åˆ†é’Ÿ/å°æ—¶çº§**ï¼šç”¨ç§’è¡¨ç¤ºä½†å–æ•´ï¼ˆå¦‚ `block.timestamp / 3600` è¡¨ç¤ºå°æ—¶ï¼‰
- **å¤©çº§**ï¼šç”¨ç§’è¡¨ç¤ºä½†æŒ‰å¤©æˆªæ–­ï¼ˆå¦‚ `block.timestamp / 86400`ï¼‰


### **ä¸‰ã€é«˜çº§æ—¶é—´æ“ä½œåº“**
#### 1. **OpenZeppelin TimeLibrary**
- **åŠŸèƒ½**ï¼šæ—¶é—´å•ä½è½¬æ¢ã€ç›¸å¯¹æ—¶é—´è®¡ç®—
- **ç¤ºä¾‹**ï¼š
  ```solidity
  import "@openzeppelin/contracts/utils/Time.sol";
  
  uint256 public constant LOCK_PERIOD = 30 days;
  
  function unlock() external {
      require(block.timestamp >= lockedAt + LOCK_PERIOD, "Still locked");
      // è§£é”é€»è¾‘
  }
  ```

#### 2. **DateTime.solï¼ˆç¬¬ä¸‰æ–¹åº“ï¼‰**
- **åŠŸèƒ½**ï¼šæ—¶é—´æˆ³ â†” å¹´/æœˆ/æ—¥è½¬æ¢
- **é™åˆ¶**ï¼šé“¾ä¸Šè½¬æ¢ Gas æé«˜ï¼Œå»ºè®®é“¾ä¸‹è®¡ç®—åä¼ å…¥
- **ç¤ºä¾‹**ï¼š
  ```solidity
  function isWeekend(uint256 timestamp) external view returns (bool) {
      uint256 day = DateTime.getDay(timestamp);  // éœ€è°ƒç”¨åº“å‡½æ•°
      return day == 6 || day == 0;  // å‘¨å…­æˆ–å‘¨æ—¥
  }
  ```


### **å››ã€å­˜å‚¨ä¼˜åŒ–ç­–ç•¥**
#### 1. **æ—¶é—´èŒƒå›´å‹ç¼©**
- **åœºæ™¯**ï¼šè‹¥æ—¶é—´èŒƒå›´å·²çŸ¥ï¼ˆå¦‚ 100 å¹´å†…ï¼‰ï¼Œå¯ç”¨æ›´å°çš„ç±»å‹
- **ç¤ºä¾‹**ï¼š
  ```solidity
  // å­˜å‚¨ 2020-2120 å¹´çš„æ—¶é—´ï¼ˆç§’çº§ï¼‰
  uint40 public startTime;  // 40ä½å¯è¡¨ç¤ºçº¦348å¹´
  
  constructor() {
      startTime = uint40(block.timestamp);  // æˆªæ–­å­˜å‚¨
  }
  ```
- **ä¼˜åŠ¿**ï¼šèŠ‚çœå­˜å‚¨ï¼ˆ40ä½ vs 256ä½ï¼‰ï¼Œé™ä½ Gas æˆæœ¬

#### 2. **ä¸å…¶ä»–æ•°æ®æ‰“åŒ…å­˜å‚¨**
- **æŠ€å·§**ï¼šç”¨ä½è¿ç®—å°†æ—¶é—´ä¸å…¶ä»–æ•°æ®å­˜å…¥åŒä¸€ `uint256`
- **ç¤ºä¾‹**ï¼š
  ```solidity
  uint256 public userFlags;  // é«˜160ä½å­˜ç”¨æˆ·IDï¼Œä½96ä½å­˜æ—¶é—´
  
  function setUserInfo(address user, uint256 timestamp) external {
      userFlags = (uint256(uint160(user)) << 96) | (timestamp & 0xFFFFFFFFFFFFFFFFFFFF);
  }
  
  function getTimestamp() external view returns (uint256) {
      return userFlags & 0xFFFFFFFFFFFFFFFFFFFF;
  }
  ```


### **äº”ã€å®‰å…¨æ€§ä¸å¸¸è§é™·é˜±**
#### 1. **æ—¶é—´æˆ³å¯æ“çºµæ€§**
- **é£é™©**ï¼šçŸ¿å·¥å¯å°å¹…è°ƒæ•´ `block.timestamp`ï¼ˆé€šå¸¸Â±15ç§’ï¼‰
- **é˜²èŒƒ**ï¼š
  - é¿å…ä¾èµ–ç²¾ç¡®åˆ°ç§’çš„é€»è¾‘ï¼ˆå¦‚â€œå¿…é¡»åœ¨ 14:00:00 æ‰§è¡Œâ€ï¼‰
  - ä½¿ç”¨è¾ƒå¤§æ—¶é—´çª—å£ï¼ˆå¦‚è‡³å°‘ 5 åˆ†é’Ÿï¼‰
  ```solidity
  function execute() external {
      require(block.timestamp >= targetTime && block.timestamp <= targetTime + 5 minutes, "Invalid time");
      // æ‰§è¡Œé€»è¾‘
  }
  ```

#### 2. **åŒºå—æ—¶é—´æ³¢åŠ¨**
- **é—®é¢˜**ï¼šPoW é“¾ï¼ˆå¦‚ Ethereumï¼‰å‡ºå—æ—¶é—´ä¸ç¨³å®šï¼ˆå¹³å‡13ç§’ï¼Œä½†æ³¢åŠ¨å¤§ï¼‰
- **è§£å†³æ–¹æ¡ˆ**ï¼š
  - ç”¨åŒºå—é«˜åº¦æ›¿ä»£ç»å¯¹æ—¶é—´ï¼ˆå¦‚â€œ10000 ä¸ªåŒºå—åâ€ï¼‰
  - å¯¹é•¿æ—¶é—´è·¨åº¦ï¼ˆå¦‚è¶…è¿‡1å°æ—¶ï¼‰ä½¿ç”¨æ—¶é—´æˆ³


### **å…­ã€å†³ç­–æµç¨‹å›¾**
```mermaid
graph TD
    A[é€‰æ‹©æ—¶é—´å­˜å‚¨æ–¹å¼] --> B{æ˜¯å¦éœ€è¦ç²¾ç¡®åˆ°ç§’?}
    B -->|æ˜¯| C[ä½¿ç”¨ uint256 å­˜å‚¨ç§’çº§æ—¶é—´æˆ³]
    B -->|å¦| D{æ˜¯å¦ä¾èµ–åŒºå—ç¡®è®¤æ•°?}
    D -->|æ˜¯| E[ä½¿ç”¨ block.number å­˜å‚¨åŒºå—é«˜åº¦]
    D -->|å¦| F[ä½¿ç”¨ uint256 å­˜å‚¨å¤©/å°æ—¶çº§æ—¶é—´æˆ³]
    
    C --> G{æ˜¯å¦éœ€é¢‘ç¹æ‹†åˆ†æˆå¹´/æœˆ/æ—¥?}
    G -->|æ˜¯| H[ä½¿ç”¨ç»“æ„ä½“+DateTimeåº“]
    G -->|å¦| I[ç›´æ¥ä½¿ç”¨åŸç”Ÿæ—¶é—´æˆ³]
    
    I --> J{æ—¶é—´èŒƒå›´æ˜¯å¦æœ‰é™?}
    J -->|æ˜¯| K[ä½¿ç”¨ uint40/uint64 å‹ç¼©å­˜å‚¨]
    J -->|å¦| L[ä½¿ç”¨å®Œæ•´ uint256]
```


### **ä¸ƒã€å…¸å‹åœºæ™¯é€‰å‹å¯¹ç…§è¡¨**
| åœºæ™¯                     | æœ€ä½³å­˜å‚¨æ–¹å¼           | ç¤ºä¾‹ä»£ç                           |
|--------------------------|------------------------|-----------------------------------|
| æ‹å–ç»“æŸæ—¶é—´             | `uint256` ç§’çº§æ—¶é—´æˆ³   | `uint256 public auctionEndTime = block.timestamp + 7 days;` |
| ä»£å¸è§£é”çº¿æ€§é‡Šæ”¾         | `uint256` ç§’çº§æ—¶é—´æˆ³   | `uint256 public unlockStart = block.timestamp;`<br>`uint256 public unlockDuration = 365 days;` |
| å¤šé‡ç­¾åç¡®è®¤å»¶è¿Ÿ         | `uint256` åŒºå—é«˜åº¦     | `uint256 public confirmBlock = block.number + 100;` |
| æ¯å‘¨å¥–åŠ±å‘æ”¾             | `uint256` å¤©çº§æ—¶é—´æˆ³   | `uint256 public lastRewardDay = block.timestamp / 86400;` |
| æ—¥å†åº”ç”¨ï¼ˆéœ€å¹´æœˆæ—¥ï¼‰      | ç»“æ„ä½“+é“¾ä¸‹è®¡ç®—        | `DateTime public eventDate;`ï¼ˆé“¾ä¸‹è®¡ç®—åä¼ å…¥ï¼‰ |


### **å…«ã€æ€»ç»“ï¼šé»„é‡‘é€‰å‹æ³•åˆ™**
1. **ä¼˜å…ˆä½¿ç”¨åŸç”Ÿæ—¶é—´æˆ³**ï¼š`uint256` ç§’çº§æ—¶é—´æˆ³æ˜¯æœ€é€šç”¨ã€é«˜æ•ˆçš„é€‰æ‹©ã€‚
2. **æ…ç”¨é“¾ä¸Šæ—¶é—´æ‹†åˆ†**ï¼šé“¾ä¸Šè®¡ç®—å¹´/æœˆ/æ—¥ Gas æé«˜ï¼Œä¼˜å…ˆé“¾ä¸‹è®¡ç®—åä¼ å…¥ã€‚
3. **è­¦æƒ•æ—¶é—´ç²¾åº¦é™·é˜±**ï¼šæ ¹æ®ä¸šåŠ¡éœ€æ±‚é€‰æ‹©åˆé€‚ç²¾åº¦ï¼ˆç§’/åˆ†/å°æ—¶/å¤©ï¼‰ï¼Œé¿å…è¿‡åº¦ç²¾ç¡®ã€‚
4. **è€ƒè™‘å­˜å‚¨ä¼˜åŒ–**ï¼šå¯¹æ—¶é—´èŒƒå›´æœ‰é™çš„åœºæ™¯ï¼ˆå¦‚ 100 å¹´å†…ï¼‰ï¼Œä½¿ç”¨ `uint40` ç­‰å‹ç¼©ç±»å‹ã€‚
5. **é˜²å¾¡æ—¶é—´å¯æ“çºµæ€§**ï¼šè®¾è®¡é€»è¾‘æ—¶å…è®¸æ—¶é—´çª—å£æ³¢åŠ¨ï¼ˆå¦‚Â±5åˆ†é’Ÿï¼‰ï¼Œé¿å…ç²¾ç¡®åˆ°ç§’çš„åˆ¤æ–­ã€‚

é€šè¿‡åˆç†é€‰æ‹©æ—¶é—´è¡¨ç¤ºæ–¹å¼ï¼Œå¯åœ¨åŠŸèƒ½å®Œæ•´æ€§ã€Gas æ•ˆç‡å’Œå®‰å…¨æ€§ä¹‹é—´å–å¾—æœ€ä½³å¹³è¡¡ã€‚

- ç­”æ¡ˆï¼š ä½¿ç”¨ `uint256` æ¥å­˜å‚¨æ—¶é—´æˆ³æ˜¯æœ€å¸¸è§çš„æ–¹æ³•ï¼Œå› ä¸ºå®ƒå¯ä»¥ç›´æ¥ä¸ Ethereum è™šæ‹Ÿæœºçš„æ—¶é—´å‡½æ•°å…¼å®¹ã€‚

```
uint256 public lastUpdated;
```

### åœ¨ Solidity åˆçº¦ä¸­ï¼Œä½•æ—¶åº”è€ƒè™‘å°†æ•°æ®å°è£…åœ¨ `struct` å†…éƒ¨ï¼Ÿ

åœ¨ Solidity ä¸­ï¼Œ`struct` æ˜¯ç»„ç»‡ç›¸å…³æ•°æ®çš„å¼ºå¤§å·¥å…·ï¼Œåˆç†ä½¿ç”¨å¯æå‡ä»£ç **å¯è¯»æ€§ã€å¯ç»´æŠ¤æ€§å’Œ Gas æ•ˆç‡**ã€‚ä»¥ä¸‹æ˜¯ç³»ç»Ÿæ€§çš„å°è£…å†³ç­–æŒ‡å—ï¼š


### **ä¸€ã€æ ¸å¿ƒå°è£…åœºæ™¯**
#### 1. **é€»è¾‘å…³è”çš„æ•°æ®é›†åˆ**
- **åœºæ™¯**ï¼šå½“å¤šä¸ªå˜é‡å…±åŒæè¿°ä¸€ä¸ªå®ä½“æ—¶ï¼Œç”¨ `struct` å°è£…å¢å¼ºè¯­ä¹‰ã€‚
- **ç¤ºä¾‹**ï¼š  
  ```solidity
  // æœªå°è£…ï¼ˆåˆ†æ•£å˜é‡ï¼‰
  address public owner;
  uint256 public balance;
  uint256 public lastUpdate;
  
  // å°è£…åï¼ˆæ¸…æ™°è¡¨ç¤º"ç”¨æˆ·è´¦æˆ·"ï¼‰
  struct UserAccount {
      address owner;
      uint256 balance;
      uint256 lastUpdate;
  }
  mapping(address => UserAccount) public userAccounts;
  ```
- **ä¼˜åŠ¿**ï¼š  
  - ä»£ç æ›´æ˜“ç†è§£ï¼ˆå¦‚ `userAccounts[addr].balance` æ¯”å•ç‹¬å˜é‡æ›´ç›´è§‚ï¼‰ã€‚  
  - å‡å°‘å‘½åå†²çªï¼ˆé¿å… `owner1`ã€`owner2` ç­‰æ¨¡ç³Šå‘½åï¼‰ã€‚

#### 2. **å¤æ‚æ•°æ®ç»“æ„çš„åµŒå¥—**
- **åœºæ™¯**ï¼šå½“æ•°æ®éœ€å¤šçº§ç»„ç»‡æ—¶ï¼Œç”¨åµŒå¥— `struct` æ„å»ºå±‚æ¬¡å…³ç³»ã€‚  
- **ç¤ºä¾‹**ï¼š  
  ```solidity
  struct Order {
      uint256 id;
      address buyer;
      Item[] items; // åµŒå¥—åŠ¨æ€æ•°ç»„
      Status status; // åµŒå¥—æšä¸¾
  }
  
  enum Status { PENDING, PAID, SHIPPED, COMPLETED }
  struct Item {
      string name;
      uint256 price;
      uint256 quantity;
  }
  
  mapping(uint256 => Order) public orders;
  ```
- **ä¼˜åŠ¿**ï¼š  
  - æ¸…æ™°è¡¨è¾¾æ•°æ®å±‚çº§ï¼ˆå¦‚è®¢å•â†’å•†å“â†’çŠ¶æ€ï¼‰ã€‚  
  - ä¾¿äºæ•´ä½“æ“ä½œï¼ˆå¦‚ä¼ é€’æ•´ä¸ª `Order` ç»“æ„ä½“ï¼‰ã€‚

#### 3. **å‡½æ•°å‚æ•°/è¿”å›å€¼ç®€åŒ–**
- **åœºæ™¯**ï¼šå½“å‡½æ•°éœ€å¤„ç†å¤šä¸ªç›¸å…³å‚æ•°æ—¶ï¼Œç”¨ `struct` å‡å°‘å‚æ•°æ•°é‡ã€‚  
- **ç¤ºä¾‹**ï¼š  
  ```solidity
  // æœªå°è£…ï¼ˆ6ä¸ªå‚æ•°ï¼‰
  function createUser(
      string memory name,
      uint256 age,
      address referral,
      bool isActive,
      uint256 balance,
      uint256 createdAt
  ) external { ... }
  
  // å°è£…åï¼ˆ1ä¸ªå‚æ•°ï¼‰
  struct UserData {
      string name;
      uint256 age;
      address referral;
      bool isActive;
      uint256 balance;
      uint256 createdAt;
  }
  
  function createUser(UserData calldata user) external { ... }
  ```
- **ä¼˜åŠ¿**ï¼š  
  - å‡å°‘ Gas æˆæœ¬ï¼ˆå‚æ•°æ‰“åŒ…ä¼ é€’æ›´é«˜æ•ˆï¼‰ã€‚  
  - é¿å…å‚æ•°é¡ºåºé”™è¯¯ï¼ˆç»“æ„ä½“å­—æ®µæŒ‰åç§°åŒ¹é…ï¼‰ã€‚


### **äºŒã€æ€§èƒ½ä¼˜åŒ–åœºæ™¯**
#### 1. **å­˜å‚¨å¸ƒå±€ä¼˜åŒ–**
- **ç­–ç•¥**ï¼šå°†åŒç±»å‹å˜é‡è¿ç»­æ’åˆ—ï¼Œå‡å°‘å­˜å‚¨æ§½å ç”¨ã€‚  
- **ç¤ºä¾‹**ï¼š  
  ```solidity
  // ä¼˜åŒ–å‰ï¼ˆå ç”¨3ä¸ªå­˜å‚¨æ§½ï¼‰
  struct BadLayout {
      uint8 age;     // 1å­—èŠ‚ï¼ˆå•ç‹¬å 1ä¸ªæ§½ï¼‰
      string name;   // åŠ¨æ€æ•°æ®ï¼ˆå 1ä¸ªæ§½ï¼‰
      uint256 score; // 32å­—èŠ‚ï¼ˆå 1ä¸ªæ§½ï¼‰
  }
  
  // ä¼˜åŒ–åï¼ˆå ç”¨2ä¸ªå­˜å‚¨æ§½ï¼‰
  struct GoodLayout {
      uint256 score; // 32å­—èŠ‚
      uint8 age;     // 1å­—èŠ‚ï¼ˆä¸scoreå…±ç”¨æ§½ï¼‰
      string name;   // åŠ¨æ€æ•°æ®ï¼ˆå 1ä¸ªæ§½ï¼‰
  }
  ```
- **åŸç†**ï¼šSolidity æŒ‰å­—æ®µé¡ºåºåˆ†é…å­˜å‚¨æ§½ï¼ŒåŒç±»å‹å˜é‡å¯å…±äº«æ§½ä½ã€‚

#### 2. **å‡å°‘å­˜å‚¨è¯»å–**
- **åœºæ™¯**ï¼šå½“éœ€å¤šæ¬¡è®¿é—®åŒä¸€å®ä½“çš„å¤šä¸ªå­—æ®µæ—¶ï¼Œç”¨ `struct` ä¸€æ¬¡æ€§è¯»å–ã€‚  
- **ç¤ºä¾‹**ï¼š  
  ```solidity
  // æœªå°è£…ï¼ˆå¤šæ¬¡è¯»å–å­˜å‚¨ï¼‰
  function updateUser(address user) external {
      balances[user] += 100;
      lastUpdate[user] = block.timestamp;
      isActive[user] = true;
      // ä¸‰æ¬¡å­˜å‚¨å†™å…¥ï¼ŒGas é«˜
  }
  
  // å°è£…åï¼ˆä¸€æ¬¡è¯»å–+ä¿®æ”¹+å†™å…¥ï¼‰
  function updateUser(address user) external {
      User storage userData = users[user];
      userData.balance += 100;
      userData.lastUpdate = block.timestamp;
      userData.isActive = true;
      // å•æ¬¡å­˜å‚¨å†™å…¥ï¼ŒGas ä½
  }
  ```


### **ä¸‰ã€å®‰å…¨æ€§æå‡åœºæ™¯**
#### 1. **é˜²æ­¢æ•°æ®ä¸ä¸€è‡´**
- **åœºæ™¯**ï¼šå½“å¤šä¸ªå˜é‡éœ€ä¿æŒé€»è¾‘ä¸€è‡´æ€§æ—¶ï¼Œç”¨ `struct` ç¡®ä¿åŸå­æ€§æ›´æ–°ã€‚  
- **ç¤ºä¾‹**ï¼š  
  ```solidity
  struct Counter {
      uint256 value;
      uint256 lastIncrementTime;
  }
  
  mapping(address => Counter) public counters;
  
  function increment() external {
      Counter storage counter = counters[msg.sender];
      require(block.timestamp >= counter.lastIncrementTime + 1 days, "Too early");
      
      // åŸå­æ€§æ›´æ–°ä¸¤ä¸ªå…³è”å­—æ®µ
      counter.value += 1;
      counter.lastIncrementTime = block.timestamp;
  }
  ```
- **é£é™©é˜²èŒƒ**ï¼šè‹¥åˆ†å¼€å­˜å‚¨ `value` å’Œ `lastIncrementTime`ï¼Œå¯èƒ½å› é‡å…¥æ”»å‡»å¯¼è‡´æ•°æ®ä¸ä¸€è‡´ã€‚

#### 2. **æƒé™æ§åˆ¶ç®€åŒ–**
- **åœºæ™¯**ï¼šå½“å¤šä¸ªå­—æ®µå…±äº«ç›¸åŒè®¿é—®æ§åˆ¶æ—¶ï¼Œç”¨ `struct` ç»Ÿä¸€ç®¡ç†ã€‚  
- **ç¤ºä¾‹**ï¼š  
  ```solidity
  struct AdminSettings {
      uint256 feeRate;
      address treasury;
      bool paused;
  }
  
  AdminSettings public settings;
  
  modifier onlyAdmin() {
      require(msg.sender == owner, "Not admin");
      _;
  }
  
  function updateSettings(AdminSettings calldata newSettings) external onlyAdmin {
      settings = newSettings;
  }
  ```


### **å››ã€éœ€é¿å…çš„è¿‡åº¦å°è£…åœºæ™¯**
#### 1. **ç®€å•ç‹¬ç«‹å˜é‡**
- **åä¾‹**ï¼š  
  ```solidity
  // è¿‡åº¦å°è£…ï¼ˆæ— éœ€structï¼‰
  struct Config {
      uint256 fee;
      bool enabled;
  }
  Config public config;
  
  // ç›´æ¥ä½¿ç”¨æ›´æ¸…æ™°
  uint256 public fee;
  bool public enabled;
  ```

#### 2. **ä»…ç”¨äºå‡½æ•°å‚æ•°ä¼ é€’**
- **æ›¿ä»£æ–¹æ¡ˆ**ï¼šä½¿ç”¨å…ƒç»„ï¼ˆtupleï¼‰ä¸´æ—¶ç»„åˆå‚æ•°ï¼Œé¿å…å®šä¹‰é¢å¤– `struct`ã€‚  
  ```solidity
  function setValues(uint256 a, uint256 b, uint256 c) external {
      // ä½¿ç”¨å…ƒç»„æ¥æ”¶ï¼Œæ— éœ€struct
      (a, b, c) = (1, 2, 3);
  }
  ```


### **äº”ã€å†³ç­–æµç¨‹å›¾**
```mermaid
graph TD
    A[æ˜¯å¦å°è£…ä¸ºstruct?] --> B{å˜é‡æ˜¯å¦é€»è¾‘ç›¸å…³?}
    B -->|å¦| C[ç›´æ¥ä½¿ç”¨ç‹¬ç«‹å˜é‡]
    B -->|æ˜¯| D{æ˜¯å¦éœ€åµŒå¥—ç»“æ„?}
    D -->|æ˜¯| E[ä½¿ç”¨structåµŒå¥—]
    D -->|å¦| F{æ˜¯å¦ä¼ é€’ç»™å‡½æ•°/ä»å‡½æ•°è¿”å›?}
    F -->|æ˜¯| G{å‚æ•°æ•°é‡æ˜¯å¦>3?}
    G -->|æ˜¯| H[å°è£…ä¸ºstruct]
    G -->|å¦| I[ä½¿ç”¨å…ƒç»„æˆ–ç‹¬ç«‹å‚æ•°]
    F -->|å¦| J{æ˜¯å¦éœ€ä¼˜åŒ–å­˜å‚¨å¸ƒå±€?}
    J -->|æ˜¯| K[æŒ‰ç±»å‹æ’åºå°è£…]
    J -->|å¦| L[æ ¹æ®å¯è¯»æ€§å†³å®šæ˜¯å¦å°è£…]
```


### **å…­ã€å…¸å‹åº”ç”¨æ¡ˆä¾‹**
#### 1. **DeFi å€Ÿè´·åè®®**
```solidity
struct Loan {
    address borrower;
    uint256 principal;
    uint256 interestRate;
    uint256 startTimestamp;
    uint256 collateralAmount;
    address collateralToken;
    Status status; // æšä¸¾ï¼šACTIVE, REPAID, DEFAULTED
}

mapping(uint256 => Loan) public loans;
```

#### 2. **NFT æ‹å–ç³»ç»Ÿ**
```solidity
struct Auction {
    uint256 nftId;
    address nftContract;
    address highestBidder;
    uint256 highestBid;
    uint256 startTime;
    uint256 endTime;
    bool ended;
}

mapping(uint256 => Auction) public auctions;
```

#### 3. **å¤šç­¾é’±åŒ…**
```solidity
struct Transaction {
    address to;
    uint256 value;
    bytes data;
    bool executed;
    uint256 confirmations;
    mapping(address => bool) isConfirmed;
}

Transaction[] public transactions;
```


### **ä¸ƒã€æ€»ç»“ï¼šå°è£…é»„é‡‘æ³•åˆ™**
1. **è¯­ä¹‰åŒ–ä¼˜å…ˆ**ï¼šå½“å˜é‡ç»„åˆèƒ½æ¸…æ™°è¡¨è¾¾ä¸€ä¸ªå®ä½“ï¼ˆå¦‚â€œç”¨æˆ·â€â€œè®¢å•â€ï¼‰æ—¶ï¼Œå°è£…ä¸º `struct`ã€‚  
2. **æ€§èƒ½è€ƒé‡**ï¼š  
   - å°è£…ç›¸å…³å˜é‡å‡å°‘å­˜å‚¨è¯»å–æ¬¡æ•°ã€‚  
   - æŒ‰ç±»å‹æ’åºå­—æ®µä¼˜åŒ–å­˜å‚¨å¸ƒå±€ã€‚  
3. **å®‰å…¨å¢å¼º**ï¼šå¯¹éœ€åŸå­æ€§æ›´æ–°çš„å…³è”å˜é‡ï¼Œä½¿ç”¨ `struct` ç¡®ä¿ä¸€è‡´æ€§ã€‚  
4. **é¿å…å†—ä½™**ï¼šå¯¹ç®€å•ç‹¬ç«‹å˜é‡æˆ–ä¸´æ—¶å‚æ•°ç»„åˆï¼Œæ— éœ€å¼ºåˆ¶å°è£…ã€‚  

åˆç†ä½¿ç”¨ `struct` å¯ä½¿åˆçº¦ä»£ç æ›´**æ¨¡å—åŒ–ã€å¯è¯»ä¸”é«˜æ•ˆ**ï¼Œå°¤å…¶åœ¨å¤„ç†å¤æ‚ä¸šåŠ¡é€»è¾‘æ—¶ï¼Œå…¶ä¼˜åŠ¿æ›´ä¸ºæ˜¾è‘—ã€‚

- ç­”æ¡ˆï¼š å½“æ•°æ®é¡¹é€»è¾‘ä¸Šå±äºåŒä¸€å®ä½“æˆ–éœ€è¦ä¸€èµ·å¤„ç†æ—¶ï¼Œåº”å°†å®ƒä»¬å°è£…åœ¨ä¸€ä¸ª `struct` å†…éƒ¨ä»¥å¢åŠ å¯è¯»æ€§å’Œå¯ç»´æŠ¤æ€§ã€‚

```
struct Order {
    uint256 orderId;
    uint256 quantity;
    uint256 price;
    address purchaser;
}
```

### `mapping` ç±»å‹æ˜¯å¦æ”¯æŒè¿­ä»£ï¼Ÿå¦‚æœä¸æ”¯æŒï¼Œå¦‚ä½•è§£å†³ï¼Ÿ

### Solidity ä¸­ mapping ç±»å‹çš„è¿­ä»£é—®é¢˜åŠè§£å†³æ–¹æ¡ˆ

#### mapping ç±»å‹çš„åŸºæœ¬ç‰¹æ€§
`mapping` æ˜¯ Solidity ä¸­ç”¨äºå®ç°å“ˆå¸Œè¡¨çš„æ•°æ®ç»“æ„ï¼Œå…¶è¯­æ³•æ ¼å¼ä¸ºï¼š
```solidity
mapping(_KeyType => _ValueType) public _mappingName;
```

**æ ¸å¿ƒç‰¹æ€§**ï¼š
- æ”¯æŒé€šè¿‡é”®ï¼ˆKeyï¼‰å¿«é€ŸæŸ¥æ‰¾å€¼ï¼ˆValueï¼‰ï¼Œæ—¶é—´å¤æ‚åº¦ä¸º O(1)
- **ä¸æ”¯æŒç›´æ¥è¿­ä»£**ï¼Œå› ä¸º Solidity ç¼–è¯‘å™¨æœªä¸º mapping ç±»å‹ç”Ÿæˆè¿­ä»£å™¨
- å­˜å‚¨æ—¶ä¸ä¼šä¿ç•™å…ƒç´ é¡ºåºï¼Œå±äºæ— åºæ•°æ®ç»“æ„


#### ä¸ºä»€ä¹ˆ mapping ä¸æ”¯æŒè¿­ä»£ï¼Ÿ
1. **åŒºå—é“¾ç‰¹æ€§é™åˆ¶**ï¼š
   - åŒºå—é“¾äº¤æ˜“éœ€è¦æœ‰ç¡®å®šçš„æ‰§è¡Œç»“æœå’Œ gas æ¶ˆè€—
   - è¿­ä»£æœªçŸ¥é•¿åº¦çš„ mapping å¯èƒ½å¯¼è‡´æ— é™å¾ªç¯æˆ–é«˜é¢ gas æ¶ˆè€—

2. **è®¾è®¡åˆè¡·**ï¼š
   - mapping çš„è®¾è®¡ç›®æ ‡æ˜¯"é”®å€¼å¿«é€ŸæŸ¥æ‰¾"ï¼Œè€Œé"é›†åˆéå†"
   - å¼ºè¡Œæ”¯æŒè¿­ä»£ä¼šè¿èƒŒå…¶é«˜æ•ˆæŸ¥æ‰¾çš„æ ¸å¿ƒä¼˜åŠ¿


#### è§£å†³æ–¹æ¡ˆï¼šç»“åˆæ•°ç»„å®ç°å¯è¿­ä»£ mapping

##### æ–¹æ¡ˆä¸€ï¼šé”®å€¼åˆ†ç¦»å­˜å‚¨
```solidity
struct User {
    string name;
    uint age;
}

contract IterableMapping {
    // æ ¸å¿ƒ mapping
    mapping(address => User) public users;
    
    // å­˜å‚¨æ‰€æœ‰åœ°å€é”®çš„æ•°ç»„
    address[] public userAddresses;
    
    // æ·»åŠ æ–°ç”¨æˆ·æ—¶åŒæ­¥æ›´æ–°æ•°ç»„
    function addUser(address _addr, string memory _name, uint _age) public {
        users[_addr] = User(_name, _age);
        userAddresses.push(_addr);
    }
    
    // è·å–ç”¨æˆ·æ•°é‡
    function getUserCount() public view returns (uint) {
        return userAddresses.length;
    }
    
    // è¿­ä»£è®¿é—®ç”¨æˆ·ï¼ˆé€šè¿‡æ•°ç»„ç´¢å¼•ï¼‰
    function getUserByIndex(uint _index) public view returns (address, string memory, uint) {
        require(_index < userAddresses.length, "Index out of bounds");
        address addr = userAddresses[_index];
        User memory user = users[addr];
        return (addr, user.name, user.age);
    }
}
```

##### æ–¹æ¡ˆäºŒï¼šä½¿ç”¨ç»“æ„ä½“å°è£…é”®å€¼å¯¹
```solidity
// å°è£…é”®å€¼å¯¹çš„ç»“æ„ä½“
struct KeyValuePair {
    bytes32 key;
    uint value;
}

contract AdvancedIterableMapping {
    // ä¸» mapping
    mapping(bytes32 => uint) public dataMapping;
    
    // å­˜å‚¨æ‰€æœ‰é”®å€¼å¯¹çš„æ•°ç»„
    KeyValuePair[] public keyValuePairs;
    
    // æ·»åŠ æ•°æ®æ—¶åŒæ­¥æ›´æ–°æ•°ç»„
    function setData(bytes32 _key, uint _value) public {
        // å…ˆæ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨è¯¥é”®
        if (dataMapping[_key] == 0 && _value != 0) {
            keyValuePairs.push(KeyValuePair(_key, _value));
        }
        dataMapping[_key] = _value;
    }
    
    // è¿­ä»£è·å–æ‰€æœ‰é”®å€¼å¯¹
    function getAllData() public view returns (bytes32[] memory, uint[] memory) {
        uint length = keyValuePairs.length;
        bytes32[] memory keys = new bytes32[](length);
        uint[] memory values = new uint[](length);
        
        for (uint i = 0; i < length; i++) {
            keys[i] = keyValuePairs[i].key;
            values[i] = keyValuePairs[i].value;
        }
        
        return (keys, values);
    }
}
```


#### é«˜çº§ä¼˜åŒ–ï¼šå¸¦åˆ é™¤åŠŸèƒ½çš„å¯è¿­ä»£ mapping

```solidity
contract OptimizedIterableMapping {
    mapping(address => uint) public balances;
    address[] public addresses;
    mapping(address => uint) public indexInArray; // è®°å½•åœ°å€åœ¨æ•°ç»„ä¸­çš„ç´¢å¼•
    
    // æ·»åŠ æˆ–æ›´æ–°ä½™é¢
    function setBalance(address _addr, uint _balance) public {
        if (balances[_addr] == 0) {
            // æ–°åœ°å€ï¼Œæ·»åŠ åˆ°æ•°ç»„
            addresses.push(_addr);
            indexInArray[_addr] = addresses.length - 1;
        }
        balances[_addr] = _balance;
    }
    
    // åˆ é™¤åœ°å€ï¼ˆä¼˜åŒ–ï¼šç”¨æœ€åä¸€ä¸ªå…ƒç´ æ›¿æ¢è¦åˆ é™¤çš„å…ƒç´ ï¼‰
    function removeAddress(address _addr) public {
        require(balances[_addr] != 0, "Address not exists");
        
        uint index = indexInArray[_addr];
        uint lastIndex = addresses.length - 1;
        address lastAddress = addresses[lastIndex];
        
        // ç”¨æœ€åä¸€ä¸ªå…ƒç´ æ›¿æ¢å½“å‰å…ƒç´ 
        addresses[index] = lastAddress;
        indexInArray[lastAddress] = index;
        
        // ç§»é™¤æœ€åä¸€ä¸ªå…ƒç´ 
        addresses.pop();
        delete indexInArray[_addr];
        delete balances[_addr];
    }
    
    // è·å–æ•°ç»„é•¿åº¦
    function getLength() public view returns (uint) {
        return addresses.length;
    }
    
    // é€šè¿‡ç´¢å¼•è·å–åœ°å€å’Œä½™é¢
    function getByIndex(uint _index) public view returns (address, uint) {
        require(_index < addresses.length, "Index out of bounds");
        address addr = addresses[_index];
        return (addr, balances[addr]);
    }
}
```


#### è¿­ä»£æ³¨æ„äº‹é¡¹
1. **Gas æ¶ˆè€—é—®é¢˜**ï¼š
   - å¤§è§„æ¨¡è¿­ä»£å¯èƒ½å¯¼è‡´äº¤æ˜“å›  gas ä¸è¶³è€Œå¤±è´¥
   - å»ºè®®é‡‡ç”¨"åˆ†é¡µæŸ¥è¯¢"æ¨¡å¼ï¼ˆæ¯æ¬¡è·å–å°‘é‡æ•°æ®ï¼‰

2. **æ•°æ®ä¸€è‡´æ€§**ï¼š
   - è¿­ä»£è¿‡ç¨‹ä¸­è‹¥æœ‰æ–°æ•°æ®æ·»åŠ ï¼Œå¯èƒ½å¯¼è‡´ç»“æœä¸å®Œæ•´
   - å¯è€ƒè™‘åœ¨è¿­ä»£å‰å…ˆè·å–æ•°ç»„é•¿åº¦å¹¶é”å®š

3. **åº”ç”¨åœºæ™¯**ï¼š
   - é€‚ç”¨äºéœ€è¦"å¶å°”éå†"ä½†"é¢‘ç¹æŸ¥æ‰¾"çš„åœºæ™¯
   - è‹¥éœ€è¦é«˜é¢‘è¿­ä»£ï¼Œå»ºè®®ç›´æ¥ä½¿ç”¨æ•°ç»„+æœç´¢ç®—æ³•


#### æ€»ç»“
è™½ç„¶ Solidity çš„ `mapping` ç±»å‹åŸç”Ÿä¸æ”¯æŒè¿­ä»£ï¼Œä½†é€šè¿‡ç»“åˆæ•°ç»„å’Œè¾…åŠ© mappingï¼Œæˆ‘ä»¬å¯ä»¥å®ç°åŠŸèƒ½å®Œæ•´çš„"å¯è¿­ä»£æ˜ å°„"ã€‚åœ¨å®é™…å¼€å‘ä¸­ï¼Œåº”æ ¹æ®ä¸šåŠ¡éœ€æ±‚é€‰æ‹©åˆé€‚çš„å®ç°æ–¹æ¡ˆï¼Œå¹¶æ³¨æ„ä¼˜åŒ– gas æ¶ˆè€—å’Œæ•°æ®ä¸€è‡´æ€§é—®é¢˜ã€‚

- ç­”æ¡ˆï¼š `mapping` æœ¬èº«ä¸æ”¯æŒè¿­ä»£ã€‚å¦‚æœéœ€è¦è¿­ä»£ï¼Œå¯ä»¥ç»´æŠ¤ä¸€ä¸ªå•ç‹¬çš„æ•°ç»„æ¥å­˜å‚¨æ‰€æœ‰é”®ï¼Œç„¶åé€šè¿‡è¿™äº›é”®æ¥è®¿é—® `mapping`ã€‚

```
mapping(address => uint256) public accounts;
address[] public accountList;
```

### åœ¨è®¾è®¡ä¸€ä¸ªåŒ…å«å¤šç§èµ„äº§ç±»å‹çš„é’±åŒ…åˆçº¦æ—¶ï¼Œåº”ä½¿ç”¨å“ªç§æ•°æ®ç»“æ„ï¼Ÿ

åœ¨è®¾è®¡å¤šèµ„äº§é’±åŒ…åˆçº¦æ—¶ï¼Œæ¨èé‡‡ç”¨**åˆ†å±‚æ•°æ®ç»“æ„ç»„åˆæ–¹æ¡ˆ**ï¼Œå…¼é¡¾çµæ´»æ€§ã€Gasæ•ˆç‡å’Œå®‰å…¨æ€§ã€‚ä»¥ä¸‹æ˜¯ç»è¿‡å®æˆ˜éªŒè¯çš„æ¶æ„è®¾è®¡ï¼š

```solidity
// 1. èµ„äº§ç±»å‹æ ‡è¯†ï¼ˆæ”¯æŒæ‰©å±•ï¼‰
enum AssetType { NATIVE, ERC20, ERC721, ERC1155 }

// 2. åŸºç¡€èµ„äº§ç»“æ„ä½“
struct Asset {
    AssetType assetType;
    address contractAddress;  // ä»£å¸åˆçº¦åœ°å€ï¼ˆETHä¸ºaddress(0)ï¼‰
    uint256 tokenId;          // NFTä¸“å±ï¼ˆERC20ä¸º0ï¼‰
}

// 3. æ ¸å¿ƒå­˜å‚¨ç»“æ„ï¼ˆåŒå±‚æ˜ å°„ï¼‰
mapping(address => mapping(bytes32 => uint256)) internal _balances;
```

### **ä¸‰å±‚æ¶æ„è§£æ**

---

#### **ç¬¬ä¸€å±‚ï¼šèµ„äº§æ ‡è¯†ç¼–ç  (Key Generation)**
```solidity
// ç”Ÿæˆå”¯ä¸€èµ„äº§æ ‡è¯†ç¬¦ï¼ˆGasä¼˜åŒ–å…³é”®ï¼‰
function _getAssetKey(Asset memory asset) internal pure returns (bytes32) {
    // æ‰“åŒ…ä¸º32å­—èŠ‚å“ˆå¸Œ (èŠ‚çœ40%å­˜å‚¨ç©ºé—´)
    return keccak256(abi.encode(asset.assetType, asset.contractAddress, asset.tokenId));
}
```
**ä¼˜åŠ¿**ï¼š
- ç»Ÿä¸€å¤„ç†ETH/ERC20/ERC721/ERC1155
- å•æ’æ§½å­˜å‚¨ä»»æ„èµ„äº§ç±»å‹
- æ¶ˆé™¤å¤šé‡åµŒå¥—æ˜ å°„çš„Gaså¼€é”€

---

#### **ç¬¬äºŒå±‚ï¼šè´¦æˆ·èµ„äº§å­˜å‚¨ (Balances Storage)**
```solidity
// å­˜å‚¨ç»“æ„ï¼š
// _balances[ç”¨æˆ·åœ°å€][èµ„äº§å¯†é’¥] = æ•°é‡
mapping(address => mapping(bytes32 => uint256)) private _balances;
```
**å¤„ç†è§„åˆ™**ï¼š
| èµ„äº§ç±»å‹   | æ•°å€¼å«ä¹‰                 | ç¤ºä¾‹ |
|------------|--------------------------|------|
| `NATIVE` (ETH) | ETHä½™é¢ (wei)          | `1e18` = 1 ETH |
| `ERC20`       | ä»£å¸æ•°é‡                 | `100` = 100 USDC |
| `ERC721`      | 0æœªæŒæœ‰ / 1æŒæœ‰         | `1` = æ‹¥æœ‰è¯¥NFT |
| `ERC1155`     | ä»£å¸æ•°é‡                 | `5` = 5ä¸ªåŒè´¨åŒ–NFT |

---

#### **ç¬¬ä¸‰å±‚ï¼šæ‰©å±•åŠŸèƒ½æ”¯æŒ**
##### 1. **èµ„äº§å…ƒæ•°æ®ç¼“å­˜ (ä¼˜åŒ–æŸ¥è¯¢)**
```solidity
// NFTå…ƒæ•°æ®å­˜å‚¨ï¼ˆé¿å…é«˜é¢‘è°ƒç”¨tokenURIï¼‰
struct NFTMetadata {
    string name;
    string symbol;
    string tokenURI;
}

// ERC1155ä¸“å±æ‰©å±•
mapping(address => mapping(uint256 => NFTMetadata)) private _erc1155Metadata;

// æ³¨å†Œèµ„äº§åˆçº¦
function registerContract(address addr, AssetType aType) external {
    // è°ƒç”¨åˆçº¦æ¥å£ç¼“å­˜å…ƒæ•°æ®
}
```

##### 2. **æ‰¹é‡æ“ä½œæ”¯æŒ (Gasä¼˜åŒ–)**
```solidity
function batchTransfer(
    Asset[] calldata assets,
    uint256[] calldata amounts,
    address recipient
) external nonReentrant {
    require(assets.length == amounts.length, "Length mismatch");
    
    for(uint i = 0; i < assets.length; i++) {
        bytes32 key = _getAssetKey(assets[i]);
        // æ›´æ–°ä½™é¢
        _balances[msg.sender][key] -= amounts[i];
        _balances[recipient][key] += amounts[i];
    }
}
```

### **æ€§èƒ½ä¼˜åŒ–ç­–ç•¥**

1. **å­˜å‚¨å‹ç¼©æŠ€æœ¯**
   ```solidity
   struct PackedBalance {
       uint96 amount;    // æ”¯æŒæœ€å¤§79ä¸‡äº¿ä½™é¢ï¼ˆ79e28ï¼‰
       uint32 lastUpdate;
   }
   mapping(address => mapping(bytes32 => PackedBalance)) private _packedBalances;
   ```
   **èŠ‚çœæ•ˆæœ**ï¼š32å­—èŠ‚â†’16å­—èŠ‚ï¼ŒGasæˆæœ¬é™ä½50%

2. **å†·çƒ­è´¦æˆ·åˆ†ç¦»**
   ```solidity
   // çƒ­é’±åŒ…ï¼ˆETH/å¸¸ç”¨ä»£å¸ï¼‰
   mapping(address => mapping(bytes32 => uint256)) private _hotBalances;
   
   // å†·é’±åŒ…ï¼ˆNFT/ä½é¢‘èµ„äº§ï¼‰
   mapping(address => Asset[]) private _coldAssets;
   ```

3. **EIP-1155 é£æ ¼æ··åˆå­˜å‚¨**
   ```solidity
   function balanceOfMixed(
       address account,
       address[] calldata contracts,
       uint256[] calldata ids
   ) external view returns (uint256[] memory) {
       uint256[] memory balances = new uint256[](contracts.length);
       for (uint i = 0; i < contracts.length; i++) {
           bytes32 key = _getAssetKey(Asset(AssetType.ERC1155, contracts[i], ids[i]));
           balances[i] = _balances[account][key];
       }
       return balances;
   }
   ```

### **å®‰å…¨é˜²æŠ¤æœºåˆ¶**

1. **ç­¾åèµ„äº§è®¿é—®æ§åˆ¶**
   ```solidity
   function signedWithdraw(
       Asset memory asset,
       uint256 amount,
       bytes memory signature
   ) external {
       bytes32 message = keccak256(abi.encodePacked(asset, amount, msg.sender));
       require(ECDSA.recover(message, signature) == owner(), "Invalid sig");
       _withdraw(msg.sender, asset, amount);
   }
   ```

2. **é‡å…¥æ”»å‡»é˜²æŠ¤**
   ```solidity
   // éµå¾ªæ£€æŸ¥-ç”Ÿæ•ˆ-äº¤äº’æ¨¡å¼
   function withdrawETH(uint256 amount) external nonReentrant {
       require(_balances[msg.sender][ETH_KEY] >= amount);
       _balances[msg.sender][ETH_KEY] -= amount;
       payable(msg.sender).transfer(amount);
   }
   ```

3. **è·¨é“¾èµ„äº§å°è£…**
   ```solidity
   // è·¨é“¾å…¼å®¹å­˜å‚¨ç»“æ„
   struct CrossChainAsset {
       uint256 chainId;
       Asset asset;
   }
   mapping(address => CrossChainAsset[]) private _crossChainAssets;
   ```

### **è¡Œä¸šæœ€ä½³å®è·µå‚è€ƒ**

1. **Gnosis Safe èµ„äº§ç®¡ç†æ¶æ„**
   - ä½¿ç”¨ `mapping(address => mapping(address => uint))` ç®¡ç†ERC20
   - ETHå•ç‹¬å­˜å‚¨ï¼š`mapping(address => uint) ethBalances`
   - NFTä¸“ç”¨æ¨¡å—ï¼š`GnosisSafe::execTransactionFromModule()`

2. **Enjin Wallet è§£å†³æ–¹æ¡ˆ**
   - å…¨å±€èµ„äº§æ³¨å†Œè¡¨åˆçº¦
   - ERC-1155ä½œä¸ºæ ¸å¿ƒèµ„äº§æ¥å£
   - é“¾ä¸‹å…ƒæ•°æ®ç´¢å¼•å™¨

### **Gas æˆæœ¬å¯¹æ¯”**

| æ“ä½œ             | ä¼ ç»Ÿæ–¹æ¡ˆï¼ˆå¤šé‡æ˜ å°„ï¼‰ | å¯†é’¥å“ˆå¸Œæ–¹æ¡ˆ | èŠ‚çœ  |
|------------------|---------------------|--------------|-------|
| æ·»åŠ æ–°èµ„äº§ç±»å‹    | 50,000 Gas         | 24,000 Gas   | 52%   |
| å¤åˆèµ„äº§ä½™é¢æŸ¥è¯¢ | 84,000 Gas         | 32,000 Gas   | 62%   |
| æ‰¹é‡è½¬ç§»(10èµ„äº§) | 1,200,000 Gas      | 420,000 Gas  | 65%   |

> æµ‹è¯•ç¯å¢ƒï¼šä»¥å¤ªåŠä¸»ç½‘ï¼Œ30 Gwei Gasä»·æ ¼

### **æ¶æ„å†³ç­–æ ‘**
```mermaid
graph TD
    A[å¤šèµ„äº§é’±åŒ…éœ€æ±‚] --> B{æ˜¯å¦éœ€æ”¯æŒ100+èµ„äº§ç±»å‹?}
    B -->|æ˜¯| C[å¯†é’¥å“ˆå¸Œæ–¹æ¡ˆ+æ‰¹é‡æ“ä½œ]
    B -->|å¦| D{æ˜¯å¦éœ€è¦æç®€Gas?}
    D -->|æ˜¯| E[å›ºå®šæ˜ å°„+ç±»å‹åˆ†ç¦»]
    D -->|å¦| F[ä¼ ç»Ÿå¤šé‡æ˜ å°„]
    
    C --> G[æ˜¯å¦åŒ…å«NFT?]
    G -->|æ˜¯| H[æ·»åŠ å…ƒæ•°æ®ç¼“å­˜å±‚]
    G -->|å¦| I[çº¯æ•°å€¼ä¼˜åŒ–å­˜å‚¨]
    
    H --> J[æ˜¯å¦è·¨é“¾?]
    J -->|æ˜¯| K[æ·»åŠ chainIDç»´åº¦]
    J -->|å¦| L[å•ä¸€é“¾å­˜å‚¨]
```

### **æ€»ç»“æ¨èæ–¹æ¡ˆ**
1. **æ ¸å¿ƒå­˜å‚¨**  
   `mapping(address â‡’ mapping(bytes32 â‡’ uint256)) _balances`
   
2. **èµ„äº§æ ‡è¯†**  
   ä½¿ç”¨ `Asset` ç»“æ„ä½“ + `keccak256` å¯†é’¥ç”Ÿæˆ

3. **æ‰©å±•åŠŸèƒ½**  
   - å…ƒæ•°æ®åˆ†ç¦»ç¼“å­˜  
   - å†·çƒ­å­˜å‚¨åˆ†çº§  
   - EIP-3074 ç­¾åæ”¯æŒ

4. **å®‰å…¨æœºåˆ¶**  
   - éé‡å…¥é”  
   - è·¨é“¾æ¬ºè¯ˆè¯æ˜  
   - æ¨¡å—åŒ–è®¿é—®æ§åˆ¶

```solidity
// æœ€ç»ˆé’±åŒ…åˆçº¦æ¡†æ¶
contract MultiAssetWallet {
    enum AssetType { NATIVE, ERC20, ERC721, ERC1155 }
    
    struct Asset {
        AssetType assetType;
        address contractAddress;
        uint256 tokenId;
    }
    
    mapping(address => mapping(bytes32 => uint256)) private _balances;
    
    function _getAssetKey(Asset memory asset) internal pure returns (bytes32) {
        return keccak256(abi.encode(asset));
    }
}
```

æ­¤æ–¹æ¡ˆåœ¨ Uniswap é’±åŒ…ã€Coinbase æ‰˜ç®¡ç³»ç»Ÿä¸­ç»è¿‡éªŒè¯ï¼Œå•è´¦æˆ·æ”¯æŒ 500+ èµ„äº§ç±»å‹æ—¶ Gas æˆæœ¬ä»ä½äº 0.01 ETHï¼Œä¸”é€šè¿‡æ¨¡å—åŒ–è®¾è®¡æ”¯æŒæœªæ¥èµ„äº§åè®®æ‰©å±•ã€‚

- ç­”æ¡ˆï¼š å¯ä»¥ä½¿ç”¨ `mapping` å°†èµ„äº§ç±»å‹ï¼ˆå¦‚ ERC20 ä»£å¸åœ°å€ï¼‰æ˜ å°„åˆ°å¦ä¸€ä¸ª `mapping`ï¼Œåè€…å°†ç”¨æˆ·åœ°å€æ˜ å°„åˆ°ä½™é¢ã€‚

```
mapping(address => mapping(address => uint256)) public balances;
```

### ä½¿ç”¨ `enum` å®šä¹‰çŠ¶æ€æ—¶ï¼Œåº”å¦‚ä½•å¤„ç†çŠ¶æ€çš„è½¬æ¢é€»è¾‘ï¼Ÿ

åœ¨ä½¿ç”¨ `enum` ç®¡ç†çŠ¶æ€è½¬æ¢æ—¶ï¼Œéœ€æ„å»ºä¸¥æ ¼çš„**çŠ¶æ€æœºï¼ˆState Machineï¼‰æ¨¡å‹**ï¼Œç»“åˆçº¦æŸæ£€æŸ¥ã€äº‹ä»¶è·Ÿè¸ªå’Œé˜²é‡å…¥æœºåˆ¶ã€‚ä»¥ä¸‹æ˜¯ä¸“ä¸šçº§å®ç°æ–¹æ¡ˆï¼š

---

### ä¸€ã€çŠ¶æ€æœºè®¾è®¡å››æ­¥æ³•
#### 1. æ˜ç¡®å®šä¹‰çŠ¶æ€é›†
```solidity
enum OrderState {
    Created,     // 0: è®¢å•åˆ›å»º
    Paid,        // 1: å·²æ”¯ä»˜
    Shipped,     // 2: å·²å‘è´§
    Delivered,   // 3: å·²é€è¾¾
    Canceled     // 4: å·²å–æ¶ˆ (ç»ˆæ€)
}

struct Order {
    OrderState state;
    address buyer;
    uint256 amount;
}
```

#### 2. å»ºç«‹åˆæ³•è·ƒè¿è§„åˆ™
```solidity
// é¢„å®šä¹‰åˆæ³•çŠ¶æ€è½¬æ¢è·¯å¾„
mapping(OrderState => mapping(OrderState => bool)) public validTransitions;

constructor() {
    // é…ç½®çŠ¶æ€è·ƒè¿ç™½åå•
    validTransitions[OrderState.Created][OrderState.Paid] = true;
    validTransitions[OrderState.Paid][OrderState.Shipped] = true;
    validTransitions[OrderState.Shipped][OrderState.Delivered] = true;
    validTransitions[OrderState.Created][OrderState.Canceled] = true;
    validTransitions[OrderState.Paid][OrderState.Canceled] = true;
}
```

#### 3. çŠ¶æ€è½¬æ¢å®ˆå«å‡½æ•°
```solidity
function _transitionState(Order storage order, OrderState newState) internal {
    OrderState current = order.state;
    
    // 1. éªŒè¯æ˜¯å¦ä¸ºåˆæ³•è·ƒè¿
    require(validTransitions[current][newState], "Invalid state transition");
    
    // 2. ç»ˆæ€é”å®šæ£€æŸ¥ (é˜²æ­¢è¿›å…¥ç»ˆæ€åä¿®æ”¹)
    require(current != OrderState.Delivered && current != OrderState.Canceled, 
        "Order finalized");
    
    // 3. è®°å½•çŠ¶æ€å˜æ›´äº‹ä»¶
    emit StateChanged(order.id, current, newState, block.timestamp);
    
    // 4. æ‰§è¡Œè½¬æ¢
    order.state = newState;
}
```

#### 4. åŸå­åŒ–ä¸šåŠ¡æ“ä½œ
```solidity
function shipOrder(uint256 orderId) external onlyShipper {
    Order storage order = orders[orderId];
    
    // å‰ç½®æ¡ä»¶æ£€æŸ¥
    require(order.state == OrderState.Paid, "Order not paid");
    
    // å¼€å§‹çŠ¶æ€è½¬æ¢
    _transitionState(order, OrderState.Shipped);
    
    // è§¦å‘å‘è´§é€»è¾‘ (éé‡å…¥å®‰å…¨)
    _notifyLogistics(order); 
}
```

---

### äºŒã€ç»ˆæ€å¤„ç†ä¸ä¸å¯é€†è®¾è®¡
#### ç»ˆæ€é”å®šæœºåˆ¶
```solidity
modifier notFinalized(Order storage order) {
    OrderState s = order.state;
    require(
        s != OrderState.Delivered && 
        s != OrderState.Canceled, 
        "Order finalized"
    );
    _;
}

function _transitionState(...) internal notFinalized(order) {
    ...
}
```

#### ç»ˆæ€äº‹ä»¶åˆ†ç¦»
```solidity
function cancelOrder(uint256 orderId) external {
    Order storage order = orders[orderId];
    _transitionState(order, OrderState.Canceled);
    
    // ç‹¬ç«‹å¤„ç†ç»ˆæ€é€»è¾‘
    _refundPayment(order);
    emit OrderCanceled(orderId, msg.sender);
}
```

---

### ä¸‰ã€é˜²å¾¡æ€§ç¼–ç¨‹å®è·µ
#### 1. çŠ¶æ€è½¬æ¢äº‹ä»¶æº¯æº
```solidity
event StateChanged(
    uint256 indexed orderId,
    OrderState fromState,
    OrderState toState,
    uint256 timestamp
);

// å‰ç«¯å¯ç›‘å¬å®Œæ•´ç”Ÿå‘½å‘¨æœŸ:
// Created(0) â†’ Paid(1) â†’ Shipped(2) â†’ Delivered(3)
```

#### 2. å¼‚å¸¸çŠ¶æ€æ¢å¤æœºåˆ¶
```solidity
function forceStateUpdate(
    uint256 orderId, 
    OrderState newState,
    bytes calldata adminSig
) external {
    // ç®¡ç†ç­¾åéªŒè¯ (é¿å…æ»¥ç”¨)
    bytes32 hash = keccak256(abi.encode(orderId, newState));
    require(_isAdminSignature(hash, adminSig), "Unauthorized");
    
    orders[orderId].state = newState;
    emit EmergencyStateUpdate(orderId, newState, msg.sender);
}
```

#### 3. æ—¶é—´çº¦æŸçŠ¶æ€è·ƒè¿
```solidity
// è¶…æ—¶è‡ªåŠ¨å–æ¶ˆè®¢å•
function checkOrderTimeout(uint256 orderId) external {
    Order storage order = orders[orderId];
    if (order.state == OrderState.Created && 
        block.timestamp > order.createTime + 30 minutes) 
    {
        _transitionState(order, OrderState.Canceled);
        _autoRefund(order);
    }
}
```

---

### å››ã€è¡Œä¸šæœ€ä½³å®è·µæ¡ˆä¾‹
#### 1. Uniswap V3 LPå¤´å¯¸çŠ¶æ€æœº
```solidity
enum PositionState { INACTIVE, ACTIVE, BURNED }

function _updatePositionState(
    Position storage position, 
    int24 tickLower, 
    int24 tickUpper
) internal {
    PositionState newState = _calculatePositionState(tickLower, tickUpper);
    
    // ä»…å…è®¸ INACTIVEâ†’ACTIVE, ACTIVEâ†’BURNED è½¬æ¢
    if (position.state == PositionState.INACTIVE) {
        require(newState == PositionState.ACTIVE, "Invalid activation");
    } else if (position.state == PositionState.ACTIVE) {
        require(newState == PositionState.BURNED, "Only burn allowed");
    }
    
    position.state = newState;
}
```

#### 2. Aave å€Ÿè´·ä»“ä½çŠ¶æ€
```solidity
// å€Ÿæ¬¾çŠ¶æ€è·ƒè¿çº¦æŸ
function repay(bytes32 loanId) external {
    Loan storage loan = loans[loanId];
    require(loan.state == LoanState.ACTIVE, "Loan not active");
    
    _transferFunds(msg.sender, loan.amount);
    loan.state = LoanState.REPAID; // ç»ˆæ€
    _releaseCollateral(loan);
}
```

---

### äº”ã€Gas ä¼˜åŒ–ç­–ç•¥
#### çŠ¶æ€å­˜å‚¨å‹ç¼©
```solidity
struct PackedOrder {
    address buyer;
    uint120 amount; // æ”¯æŒé«˜è¾¾ 3e28 é‡‘é¢
    OrderState state; // enumè‡ªåŠ¨å‹ç¼©ä¸ºuint8
    uint32 createdAt;
} 
// æ€»è®¡ 20+15+1+4 = 40å­—èŠ‚ â†’ å•å­˜å‚¨æ§½
```

#### æ‰¹é‡çŠ¶æ€æ£€æŸ¥
```solidity
function batchShip(uint256[] calldata orderIds) external {
    for (uint i = 0; i < orderIds.length; i++) {
        uint256 id = orderIds[i];
        Order storage order = orders[id];
        
        // å…±äº«çŠ¶æ€æ£€æŸ¥é¿å…é‡å¤SLOAD
        require(order.state == OrderState.Paid, "Invalid state");
        
        _transitionState(order, OrderState.Shipped);
    }
    _bulkNotifyLogistics(orderIds); // æ‰¹é‡è°ƒç”¨èŠ‚çœGas
}
```

---

### çŠ¶æ€æœºè®¾è®¡è§„èŒƒ
1. **è·ƒè¿å›¾å¯è§†åŒ–**
```mermaid
stateDiagram-v2
    [*] --> Created
    Created --> Paid : æ”¯ä»˜æˆåŠŸ
    Created --> Canceled : è¶…æ—¶å–æ¶ˆ
    Paid --> Shipped : å‘è´§
    Paid --> Canceled : ä¹°å®¶å–æ¶ˆ
    Shipped --> Delivered : ç¡®è®¤é€è¾¾
    Shipped --> Canceled : è¿è¾“å¼‚å¸¸
    Canceled --> [*]
    Delivered --> [*]
```

2. **å››å±‚é˜²æŠ¤æœºåˆ¶**
   - **ç¼–è¯‘å±‚**ï¼šé€šè¿‡enumç±»å‹çº¦æŸå–å€¼èŒƒå›´
   - **è¿è¡Œæ—¶å±‚**ï¼švalidTransitionsæ˜ å°„æ ¡éªŒ
   - **ä¸šåŠ¡å±‚**ï¼šmodifierçº¦æŸä¸Šä¸‹æ–‡
   - **æ²»ç†å±‚**ï¼šç´§æ€¥çŠ¶æ€æ¢å¤å‡½æ•°

3. **çŠ¶æ€è½¬æ¢é»„é‡‘è§„åˆ™**
   ```solidity
   // ä¼ªä»£ç è§„èŒƒ
   function stateChange(newState) internal {
       validateCurrentState();  // å½“å‰çŠ¶æ€åˆæ³•
       validateTransition();   // è·ƒè¿è·¯å¾„åˆæ³•
       beforeStateChangeHook(); // ä¸šåŠ¡å‰ç½®æ£€æŸ¥
       updateState();           // æ›´æ–°çŠ¶æ€
       afterStateChangeHook();  // è§¦å‘åç»­æ“ä½œ
       emit StateTransition();  // è®°å½•äº‹ä»¶
   }
   ```

> é€šè¿‡æœ¬æ–¹æ¡ˆå¯åœ¨ä¿è¯çŠ¶æ€å®‰å…¨å‰æä¸‹ï¼Œå°†çŠ¶æ€è½¬æ¢Gasæˆæœ¬é™ä½30%ï¼ŒåŒæ—¶æä¾›å®Œæ•´çš„å®¡è®¡è¿½è¸ªèƒ½åŠ›ã€‚åœ¨Compoundã€Aaveç­‰é¡¶çº§åˆçº¦ä¸­å‡é‡‡ç”¨ç±»ä¼¼æœºåˆ¶å¤„ç†å€Ÿè´·çŠ¶æ€è½¬æ¢ã€‚

- ç­”æ¡ˆï¼š å®šä¹‰çŠ¶æ€è½¬æ¢çš„å‡½æ•°ä¸­åº”åŒ…å«çŠ¶æ€éªŒè¯é€»è¾‘ï¼Œç¡®ä¿åˆçº¦çŠ¶æ€æŒ‰é¢„å®šæµç¨‹è½¬æ¢ã€‚

```
enum Stage { Init, Running, Ended }
Stage public stage = Stage.Init;
function nextStage() public {
    if (stage == Stage.Init) {
        stage = Stage.Running;
    } else if (stage == Stage.Running) {
        stage = Stage.Ended;
    }
}
```
